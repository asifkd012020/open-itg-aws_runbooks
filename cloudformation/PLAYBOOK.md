<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# AWS CloudFormation - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1. If using a CloudFormation Service Role, ensure least privileges are granted](#1-if-using-a-cloudformation-service-role-ensure-least-privileges-are-granted)
  - [2. Limit public access to CloudFormation using VPC Endpoints](#2-limit-public-access-to-cloudformation-using-vpc-endpoints)
  - [3. Enable Termination Protection on mission-critical stacks](#3-enable-termination-protection-on-mission-critical-stacks)
- [Detective](#detective)
  - [1. Perform regular Drift Detection on stacks to identify out-of-phase resources](#1-perform-regular-drift-detection-on-stacks-to-identify-out-of-phase-resources)
  - [2. Monitor API activity for malicious or unauthorized events](#2-monitor-api-activity-for-malicious-or-unauthorized-events)
- [Respond/Recover](#respondrecover)
  - [1. Utilize an event-based solution for automated incident response](#1-utilize-an-event-based-solution-for-automated-incident-response)
- [Endnotes](#endnotes)

## Overview
AWS provides a number of security features for AWS CloudFormation which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: ID, PR.AC-2, PR.AT, PR.DS (Unless stated), PR.IP (Unless stated), PR.MA, PR.PT-2, DE.AE-4, DE.AE-5, DE.AE-2, DE.AE-4, DE.AE-5, DE.AE-6, DE.AE-8, DE.DP-1, DE.DP-4, DE.DP-5, RS (Unless stated), RC.

## Preventative Controls
### 1. If using a CloudFormation Service Role, ensure least privileges are granted
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|
|PR.AC-6|Identities are proofed and bound to credentials and asserted in interactions|
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individualsâ€™ security and privacy risks and other organizational risks)|
|PR.PT-3|The principle of least functionality is incorporated by configuring systems to provide only essential capabilities|

**Why?** When you specify a service role, AWS CloudFormation always uses that role for all operations that are performed on that stack. Other users that have permissions to perform operations on this stack will be able to use this role, even if they don't have permission to pass it. If the role includes permissions that the user shouldn't have, you can unintentionally escalate a user's permissions.

**How?** When creating roles for CloudFormation stack deployers, do not assign sweeping, admin-level policies to them. It's best to have multiple roles with varying levels of permissions. CloudFormation users can then be granted the ability to pass roles that align to their trusted level of access within AWS. For information on how to create these roles, and how to allow users to pass them, see [Endnote 1](#endnote-1) and [Endnote 2](#endnote-2).

### 2. Limit public access to CloudFormation using VPC Endpoints
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.PT-4|Communications and control networks are protected|
|PR.PT-5|Mechanisms (e.g., failsafe, load balancing, hot swap) are implemented to achieve resilience requirements in normal and adverse situations|
|PR.AC-3|Remote access is managed|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|

**Why?** You can improve the security posture of your VPC by configuring AWS CloudFormation to use an interface VPC endpoint. Interface endpoints are powered by PrivateLink, a technology that enables you to privately access AWS CloudFormation APIs by using private IP addresses. PrivateLink restricts all network traffic between your VPC and AWS CloudFormation to the Amazon network. Also, you don't need an Internet gateway, a NAT device, or a virtual private gateway. 

**How?** Before setting up the VPC Endpoint, be sure to refer to [Endnote 3](#endnote-3) for steps to take prior to setup. Once ready, follow the instructions in [Endnote 4](#endnote-4) to create the following endpoint: **com.amazonaws.*region*.cloudformation**

### 3. Enable Termination Protection on mission-critical stacks
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.DS-6|Integrity checking mechanisms are used to verify software, firmware, and information integrity|
|PR.IP-6|Data is destroyed according to policy|

**Why?** You can prevent a stack from being accidentally deleted by enabling termination protection on the stack. If a user attempts to delete a stack with termination protection enabled, the deletion fails and the stack--including its status--remains unchanged.

**How?** You can enable termination protection on a stack when you create it, or after its creation from within the AWS Console. Termination protection on stacks is disabled by default. You can set termination protection on a stack with any status except DELETE_IN_PROGRESS or DELETE_COMPLETE.  
Enabling or disabling termination protection on a stack sets it for any nested stacks belonging to that stack as well. You cannot enable or disable termination protection directly on a nested stack.  
For more information on Termination Protection, see [Endnote 5](#endnote-5).

## Detective
### 1. Perform regular Drift Detection on stacks to identify out-of-phase resources
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|
|DE.DP-2|Detection activities comply with all applicable requirements|
|DE.DP-3|Detection processes are tested|

**Why?** Even as you manage your resources through CloudFormation, users can change those resources *outside* of CloudFormation. Users can edit resources directly by using the underlying service that created the resource. For example, you can use the Amazon EC2 console to update a server instance that was created as part of a CloudFormation stack. Some changes may be accidental, and some may be made intentionally to respond to time-sensitive operational events. Regardless, changes made outside of CloudFormation can complicate stack update or deletion operations. You can use drift detection to identify stack resources to which configuration changes have been made outside of CloudFormation management.

**How?** Drift Detection can be performed in a few different ways; either through the AWS Console or through the AWS CLI, and on either a full stack, or on specific resources within a stack.  
It is best to set up some sort of automated checking of Drift Detection. This can be done in many ways, one of which being a Lambda function that is run on a schedule. The function would simply start the detection task.  
Keep in mind, though, that the user or role running the Drift Detection will need permissions, not only to run the detection, but to read all resources within the scope of the check.  
For more information on how to set up Drift Detection, and specifically which resource types are supported, see [Endnote 6](#endnote-6).

### 2. Monitor API activity for malicious or unauthorized events
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.PT-1|Audit/log records are determined, documented, implemented, and reviewed in accordance with policy|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|  

**Why?** CloudFormation is a very powerful tool, able to make several changes to an environment in a very short time. By monitoring API activity, you can see exactly who made a change in the CloudFormation service, and from where.

**How?** CloudTrail captures all API calls for AWS CloudFormation as events, including calls from the AWS CloudFormation console and from code calls to the AWS CloudFormation APIs. Leverage detective controls to help ensure all trails are sending events to CloudWatch Logs for monitoring by using the cloud-trail-cloud-watch-logs-enabled rule in AWS Config.  
Continuously verify that CloudTrail logging is enabled in every AWS region in every AWS account, which can be programmatically checked via the AWS API, CLI, or SDK via the GetTrailStatus API call or describe-trails and get-trail-status CLI commands.

## Respond/Recover
### 1. Utilize an event-based solution for automated incident response
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN-1|Notifications from detection systems are investigated|
|RS.AN-2|The impact of the incident is understood|
|RS.AN-3|Forensics are performed|
|RS.AN-4|Incidents are categorized consistent with response plans|
|RS.AN-5|Processes are established to receive, analyze and respond to vulnerabilities disclosed to the organization from internal and external sources (e.g. internal testing, security bulletins, or security researchers)|

**Why?** Using an event-based solution, you can automatically report and respond to incidents of almost any kind, including stack creation and deletion, stack execution, and drift detection scan initiation, just to name a few.

**How?** For various incident types, an appropriate response rule should be determined and added to Amazon EventBridge (previously CloudWatch Events). Depending on the organization's Incident Response Plan, there may be need for human interaction in some cases, or fully automated remediation in other cases.  
CloudFormation does not have any native event types for EventBridge, so CloudTrail logs are used for event generation. For information on setting up EventBridge rules using CloudTrail logs, see [Endnote 7](#endnote-7).

## Endnotes
### Endnote 1 <!-- omit in toc -->
[https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-servicerole.html](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-servicerole.html)
### Endnote 2 <!-- omit in toc -->
[https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html)
### Endnote 3 <!-- omit in toc -->
[https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-vpce-bucketnames.html](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-vpce-bucketnames.html)
### Endnote 4 <!-- omit in toc -->
[https://docs.aws.amazon.com/vpc/latest/userguide/vpce-interface.html#create-interface-endpoint](https://docs.aws.amazon.com/vpc/latest/userguide/vpce-interface.html#create-interface-endpoint)
### Endnote 5 <!-- omit in toc -->
[https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-protect-stacks.html](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-protect-stacks.html)
### Endnote 6 <!-- omit in toc -->
[https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-stack-drift.html](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-stack-drift.html)
### Endnote 7 <!-- omit in toc -->
[https://docs.aws.amazon.com/eventbridge/latest/userguide/event-types.html#events-for-services-not-listed](https://docs.aws.amazon.com/eventbridge/latest/userguide/event-types.html#events-for-services-not-listed)