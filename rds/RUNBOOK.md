<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# AWS Relational Database Service (RDS) - Security Playbook <!-- omit in toc -->
## Capgroup Cybersecurity Control Alignment <!-- omit in toc -->

**Generated By:**  
[Rob Goss (RMG)](https://cgweb3/profile/RMG)
<br>
Security Engineering

**Last Update:** *09/22/2021*

## Table of Contents <!-- omit in toc -->
- [Overview](#overview)
- [Cloud Security Requirements](#cloud-security-requirements)
  - [1. RDS Utilizes VPC Endpoints to Prevent Public Access](#1-rds-Utilizes-VPC-Endpoints-to-Prevent-Public-Access)
  - [2. RDS has Instance Public Accessibility turned off](#2-rds-has-nstance-public-accessibility-turned-off)
  - [3. RDS snapshots are never shared Publicly](#3-rds-snapshots-are-never-shared-publicly)
  - [4. RDS data are Encrypted at rest using CG CMK](#4-rds-data-are-encrypted-at-rest-using-cg-cmk)
  - [5. RDS snapshots are Encrypted at rest using CG CMK](#5-rds-snapshots-are-encrypted-at-rest-using-cg-cmk)
  - [6. RDS connections are Encrypted in transit using TLS 1.2](#6-rds-connections-are-encrypted-in-transit-using-tls-12)
  - [7. RDS has appropriate access controls to enforce least privilege](#7-RDS-has-appropriate-access-controls-to-enforce-least-privilege)
  - [8. RDS instances are configured for high-availability](#8-rds-instances-are-configured-for-high-availability)
  - [9. RDS database secrets are vaulted for automatic rotation](#9-rds-database-secrets-are-vaulted-for-automatic-rotation)
  - [10. RDS uses CloudWatch and EventBridge events for anomaly detection](#10-rds-uses-cloudwatch-and-eventbridge-events-for-anomaly-detection)
  - [11. Log RDS API calls with CloudTrail](#11-log-rds-api-calls-with-cloudtrail)
- [Operational Best Practices](#operational-best-practices)
  - [1. RDS Resources are tagged according to CG standards](#1-rds-resources-are-tagged-according-to-cg-standards)
  - [2. RDS auto minor version upgrade is enabled](#2-rds-auto-minor-version-upgrade-is-enabled)
- [Endnotes](#endnotes)
- [Capital Group Glossory](#capital-group-glossory) 
<br><br>

## Overview
Amazon Relational Database Service (Amazon RDS) makes it easy to set up, operate, and scale a relational database in the cloud. It provides cost-efficient and resizable capacity while automating time-consuming administration tasks such as hardware provisioning, database setup, patching and backups. It frees you to focus on your applications so you can give them the fast performance, high availability, security and compatibility they need.

Amazon RDS is available on several database instance types - optimized for memory, performance or I/O - and provides you with six familiar database engines to choose from, including Amazon Aurora, PostgreSQL, MySQL, MariaDB, Oracle Database, and SQL Server. You can use the AWS Database Migration Service to easily migrate or replicate your existing databases to Amazon RDS.

**NOTE**
>The only two RDS instance types supported at CG are Oracle and Postgress, all other instance types are not currently supported and should not be deployed.<br>

<img src="/docs/img/rds/example.png" width="800">

### Features & Benefits
 - Easy to administer
 - Highly scalable
 - Available and durable
 - Fast, secure and inexpensive
<br><br>

## Cloud Security Requirements
<img src="/docs/img/Prevent.png" width="50">

### 1. RDS Utilizes VPC Endpoints to Prevent Public Access
RDS as a service currently supports VPC Interface Endpoints in AWS, and as such allows the service to meet CG's stringent Public Access control requirements.
<br>

**Capital Group Controls:** 
<br>
|Control Statement|Description|
|------|----------------------|
|[CS0012300](https://capitalgroup.service-now.com/cg_grc?sys_id=80df48c01bac20506a50beef034bcb47&table=sn_compliance_policy_statement&id=cg_grc_action_item_details&view=sp)|Cloud products and services must be deployed on private subnets and public access must be disabled for these services.|

**Why?**<br>
Multiple layers of security are needed to help ensure that resources are safe from unwanted access. In addition to IAM policies, having strong network controls in place isolates your instances from outside threats. If traffic is not able to reach an instance, then remote threats can be mitigated.

**How?** <br>
You should establish a private connection between your VPC and Amazon RDS API endpoints by creating an interface VPC endpoint. Interface endpoints are powered by AWS PrivateLink.

AWS PrivateLink enables you to privately access Amazon RDS API operations without an internet gateway, NAT device, VPN connection, or AWS Direct Connect connection. Instances in your VPC don't need public IP addresses to communicate with Amazon RDS API endpoints to launch, modify, or terminate DB instances. Your instances also don't need public IP addresses to use any of the available RDS API operations. Traffic between your VPC and Amazon RDS doesn't leave the Amazon network. Each interface endpoint is represented by one or more elastic network interfaces in your subnets.


**Creation of Interface VPC Endpoint for RDS:**
  1. Open the Amazon VPC console at https://console.aws.amazon.com/vpc/, and choose Endpoints from the navigation pane at left.
  2. Choose Create Endpoint.
     - For Service category, choose AWS service. 
     - For Service Name, choose Config in your AWS Region (for example, `com.amazonaws.region.rds`).
     - Then choose the VPC, if it does not already exist follow this [link](https://github.com/open-itg/aws_runbooks/blob/master/vpc/RUNBOOK.md) for instructions on how to create a new VPC. 
     - Select a security group for AWS Config, if the default security group will not suffice then follow this [link](https://github.com/open-itg/aws_runbooks/blob/master/vpc/RUNBOOK.md) for instructions on how to create a new Security Group. 
     - Make sure that you `Enable` the Enable Private DNS Name check box.
     - Now add the appropriate `CG standard tags`.
  4. Click `Create Endpoint` to complete the process.
  5. The RDS service will now be accessible via the private endpoint for all requests within the VPC.
<br><br>

### 2. RDS has Instance Public Accessibility turned off
RDS as a service currently supports publically accessible databases, this option can be turned off and as such allows the service to meet CG's stringent Public Access control requirements.
<br>

**Capital Group Controls:** 
<br>
|Control Statement|Description|
|------|----------------------|
|[CS0012300](https://capitalgroup.service-now.com/cg_grc?sys_id=80df48c01bac20506a50beef034bcb47&table=sn_compliance_policy_statement&id=cg_grc_action_item_details&view=sp)|Cloud products and services must be deployed on private subnets and public access must be disabled for these services.|

**Why?**<br>
As mentioned previously, CG has stringent public accessibility standards when it comes to deploying services in the cloud and RDS is no different. When you launch a DB instance, you can turn on or off public accessibility for that instance, and turning off public accessibility allows the RDS service to meet the CG public access controls.

**How?**<br>
To designate whether the DB instance that you create has a DNS name that resolves to a public IP address, you use the `Public accessibility` parameter. By using this parameter, you can designate whether there is public access to the DB instance. You can modify a DB instance to turn on or off public accessibility by modifying the `Public accessibility` parameter within the `Network & Security` section of the configuration.

Security groups should be utilized to control which IP addresses or Amazon EC2 instances can connect to the databases on an RDS DB instance. When you first create a DB instance, its firewall prevents any database access except through rules specified by an associated security group. For further information on how to correctly deploy security groups, please read the [VPC Runbook](https://github.com/open-itg/aws_runbooks/blob/master/vpc/RUNBOOK.md).
<br><br>

### 3. RDS snapshots are never shared Publicly
RDS as a service currently supports publically sharing database snapshots, this option can be turned off and as such allows the service to meet CG's stringent Public Access control requirements.
<br>

**Capital Group Controls:** 
<br>
|Control Statement|Description|
|------|----------------------|
|[CS0012300](https://capitalgroup.service-now.com/cg_grc?sys_id=80df48c01bac20506a50beef034bcb47&table=sn_compliance_policy_statement&id=cg_grc_action_item_details&view=sp)|Cloud products and services must be deployed on private subnets and public access must be disabled for these services.|

**What, Why & How?**<br>
As mentioned previously, CG has stringent public accessibility standards when it comes to deploying services in the cloud and as such database snapshots should never be made publicaly accessible or shared outside of CG. If a malicious actor was to have access to a snapshot, they would be able to restore a database from this snapshot and see all the data contained within. Athough this could be mitigated with the encryption of the snapshot, at CG we layer our controls and public access is our first mitigating control in all cases.

To determine if a database snapshot was been publically, and subsequently remove the public access the steps below should be followed.

**Making a Snapshot Private**<br>
When creating a snapshot, one should always choose the `Private` option under the Snapshot Permissions tab. This can be seen in the screenshot below:<br>

<img src="/docs/img/rds/snap_perms.png" width="500">
<br>

**Checking for Public Snapshots**<br>
You can use the following AWS CLI command (Unix only) to view the public snapshots owned by your AWS account in a particular AWS Region. Any snapshots seen in the output should be either made private or deleted as soon as possible.

```
aws rds describe-db-snapshots --snapshot-type public --include-public | grep account_number
```
The output returned is similar to the following example if you have public snapshots.
```
"DBSnapshotArn": "arn:aws:rds:us-east-1:123456789012:snapshot:MySharedSnapshot1",
"DBSnapshotArn": "arn:aws:rds:us-east-1:123456789012:snapshot:MySharedSnapshot2",
```
<br>

### 4. RDS data are Encrypted at rest using CG CMK

**Capital Group Controls:**<br>

|Control Statement|Description|
|------|----------------------|
|Control ID |Control Description|

**Why?**<br>
Amazon RDS encrypted DB instances provide an additional layer of data protection by securing your data from unauthorized access to the underlying storage. You can use Amazon RDS encryption to increase data protection of your applications deployed in the cloud, and to fulfill compliance requirements for data-at-rest encryption.  
For an Amazon RDS encrypted DB instance, all logs, backups, and snapshots are encrypted. A read replica of an Amazon RDS encrypted instance is also encrypted using the same key as the master instance when both are in the same AWS Region. If the master and read replica are in different AWS Regions, you encrypt using the encryption key for that AWS Region. 

**How?**<br>
For all CG RDS encrypted DB instances are to be encrypted with a CG managed KMS key. A read replica of a CG RDS encrypted instance is also encrypted using the same key as the master instance when both are in the same AWS Region. If the master and read replica are in different AWS Regions, you will encrypt using the encryption key for that AWS Region.

**In the Console:**  
To enable encryption for a new DB instance:
- Choose `Enable encryption` on the Amazon RDS console while creating the instance. 
- Make sure to select an appropriate `CG KMS Key` to use for encryption of the instance. By default all CG accounts will have a dedicated KMS key provisioned for use with RDS.

**In the AWS CLI:**  
 - If you use the `create-db-instance` AWS CLI command to create an encrypted DB instance, set the `--storage-encrypted` parameter to `true`. Set the `--kms-key-id` parameter to the Amazon Resource Name (ARN) for the CG AWS KMS encryption key for the DB instance, by default all CG accounts will have a dedicated KMS key provisioned for use with RDS. 
<br><br>

### 5. RDS snapshots are Encrypted at rest using CG CMK

**Capital Group Controls:**<br>

|Control Statement|Description|
|------|----------------------|
|Control ID |Control Description|

**What, Why & How?**<br>
Ensure that your RDS snapshots are encrypted in order to achieve compliance for data-at-rest encryption within CG. The RDS snapshot encryption and decryption process is handled transparently and does not require any additional action from you or your application. The keys used for RDS database snapshot encryption should be entirely managed and protected through the use of CG KMS Customer Master Keys (CMKs).

If you have encrypted your RDS database instance as outlined above in [Section 4.](#4-rds-data-are-encrypted-at-rest-using-cg-cmk) all logs, snapshots and backups are automatically encrypted with the same CG Key.

If you have found an unencrypted snapshot and need to encrypt the snapshot to bring it into compliance, you should follow the steps below:

**Encrypting an Unencrypted Snapshot:**
1. Open the Amazon RDS console, and then choose `Snapshots` from the navigation pane.
2. Select the snapshot that you want to encrypt.
3. Under Snapshot Actions, choose `Copy Snapshot`.
4. Choose your Destination Region, and then enter your New DB Snapshot Identifier.
5. Change `Enable Encryption` to `Yes`.
<br><br>

### 6. RDS connections are Encrypted in transit using TLS 1.2

**Capital Group Controls:**<br>

|Control Statement|Description|
|------|----------------------|
|Control ID |Control Description|

**Why?**<br>
At CG we require that all data and services in the cloud are encrypted both at rest and in-transit and as such, the best mechanism to securly provide in-transit encryption is TLS 1.2.

**How?**<br>

Communications with the RDS API are all encrypted with TLS. In order to encrypt communications with the databases in RDS, this needs to be enabled, and each engine requires a slightly different process to enable TLS.

First of all, the root certificate needs to be downloaded so that it can be fed into the application or client connecting to the database. To retrieve a root certificate that works for all AWS Regions, excluding opt-in AWS Regions, download it from <https://s3.amazonaws.com/rds-downloads/rds-ca-2019-root.pem>.

If your application cannot accept certificate chains, download the certificate bundle that contains both the `intermediate` and `root certificates`, download from <https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem>.

- [MariaDB](#using-tls-with-mariadb)  
- [MySQL](#using-tls-with-mysql)  
- [Oracle](#using-tls-with-oracle)  
- [PostgreSQL](#using-tls-with-postgresql)

#### **Using TLS with MariaDB**<br>

NOTE:
>CG does not currently support MariaDB, but the information pertaining to TLS enablement for MariaDB is listed below in the event the service is later permitted.

The following example shows how to launch the client using the `--ssl-ca` parameter for MariaDB 10.2 and later:
```
mysql -h myinstance.a1bcdef23.rds-us-east-1.amazonaws.com
--ssl-ca=[full path]rds-combined-ca-bundle.pem --ssl-mode=REQUIRED
```

The following example shows how to launch the client using the `--ssl-ca` parameter for MariaDB 10.1 and earlier:
```
mysql -h myinstance.a1bcdef23.rds-us-east-1.amazonaws.com
--ssl-ca=[full path]rds-combined-ca-bundle.pem --ssl-verify-server-cert
```

You can use one of the following statements, depending on your MariaDB version, to require SSL connections on the user account `encrypted_user`.  
For MariaDB 10.2 and later, use the following statement:
```
ALTER USER 'encrypted_user'@'%' REQUIRE SSL;            
```     

For MariaDB 10.1 and earlier, use the following statement:
```
GRANT USAGE ON *.* TO 'encrypted_user'@'%' REQUIRE SSL;
```

#### **Using TLS with MySQL**<br>

NOTE:
>CG does not currently support MySQL, but the information pertaining to TLS enablement for MySQL is listed below in the event the service is later permitted.

The following example shows how to launch the client using the --ssl-ca parameter for MySQL 5.7 and later:
```
mysql -h myinstance.c9akciq32.rds-us-east-1.amazonaws.com
--ssl-ca=[full path]rds-combined-ca-bundle.pem --ssl-mode=VERIFY_IDENTITY
```

The following example shows how to launch the client using the --ssl-ca parameter for MySQL 5.6 and earlier:
```
mysql -h myinstance.c9akciq32.rds-us-east-1.amazonaws.com
--ssl-ca=[full path]rds-combined-ca-bundle.pem --ssl-verify-server-cert
```

You can use one of the following statements, depending on your MySQL version, to require SSL connections on the user account `encrypted_user`.  
For MySQL 5.7 and later, use the following statement:
```
ALTER USER 'encrypted_user'@'%' REQUIRE SSL;            
```     

For MySQL 5.6 and earlier, use the following statement:
```
GRANT USAGE ON *.* TO 'encrypted_user'@'%' REQUIRE SSL;
```

#### **Using TLS with Oracle**
You must configure SQL*Plus before connecting to an Oracle DB instance that uses the Oracle SSL option.

**To configure SQL*Plus to use SSL to connect to an Oracle DB instance**  
1. Set the `ORACLE_HOME` environment variable to the location of your Oracle home directory.  
The path to your Oracle home directory depends on your installation. The following example sets the `ORACLE_HOME` environment variable:
```
prompt>export ORACLE_HOME=/home/user/app/user/product/12.1.0/dbhome_1
```

2. Append `$ORACLE_HOME/lib` to the `LD_LIBRARY_PATH` environment variable.  
The following is an example that sets the `LD_LIBRARY_PATH` environment variable:
```
prompt>export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/lib 
```                 

3. Create a directory for the Oracle wallet at `$ORACLE_HOME/ssl_wallet`.  
The following is an example that creates the Oracle wallet directory:
```
prompt>mkdir $ORACLE_HOME/ssl_wallet 
```
                    
4. Download the root certificate that works for all AWS Regions and put the file in the `ssl_wallet` directory.  

5. In the `$ORACLE_HOME/network/admin` directory, modify or create the `tnsnames.ora` file and include the following entry:
```
<net_service_name>= (DESCRIPTION = (ADDRESS_LIST = (ADDRESS = (PROTOCOL = TCPS) 
   (HOST = <endpoint>) (PORT = <ssl port number>)))(CONNECT_DATA = (SID = <database name>))
   (SECURITY = (SSL_SERVER_CERT_DN = "C=US,ST=Washington,L=Seattle,O=Amazon.com,OU=RDS,CN=<endpoint>")))
```                 

6. In the same directory, modify or create the `sqlnet.ora` file and include the following parameters:
```
WALLET_LOCATION = (SOURCE = (METHOD = FILE) (METHOD_DATA = (DIRECTORY = $ORACLE_HOME/ssl_wallet))) 
SSL_CLIENT_AUTHENTICATION = FALSE 
SSL_VERSION = 1.0 
SSL_CIPHER_SUITES = (SSL_RSA_WITH_AES_256_CBC_SHA) 
SSL_SERVER_DN_MATCH = ON  
```

7. Run the following commands to create the Oracle wallet:
```
prompt>orapki wallet create -wallet $ORACLE_HOME/ssl_wallet -auto_login_only   

prompt>orapki wallet add -wallet $ORACLE_HOME/ssl_wallet -trusted_cert -cert
      $ORACLE_HOME/ssl_wallet/rds-ca-2019-root.pem -auto_login_only  
```
*Replace the file name with the one you downloaded.*

**Connecting to an Oracle DB Instance Using SSL**  
Export the `TNS_ADMIN` value that points to the directory that contains the `tnsnames.ora` and `sqlnet.ora` files. Doing so ensures that SQL*Plus can find these files consistently. The following example exports the `TNS_ADMIN` value:
```  
export TNS_ADMIN = ${ORACLE_HOME}/network/admin               
```         

Connect to the DB instance. For example, you can connect using SQL*Plus and a `<net_service_name>` in a `tnsnames.ora` file:
```
sqlplus <mydbuser>@<net_service_name>
```

#### **Using TLS with PostgreSQL**
The following is an example of using `psql` to connect to a PostgreSQL DB instance:
```
$ psql -h testpg.123abc456def.us-east-1.rds.amazonaws.com -p 5432 \
    "dbname=testpg user=testuser sslrootcert=rds-ca-2015-root.pem sslmode=verify-full"
```

**Requiring an SSL Connection to a PostgreSQL DB Instance**  
Set the `rds.force_ssl` parameter to 1 (on) to require SSL for connections to your DB instance. Updating the `rds.force_ssl` parameter also sets the PostgreSQL `ssl` parameter to 1 (on) and modifies your DB instance’s `pg_hba.conf` file to support the new SSL configuration.

You can set the `rds.force_ssl` parameter value by updating the parameter group for your DB instance. If the parameter group for your DB instance isn't the default one, and the `ssl` parameter is already set to 1 when you set `rds.force_ssl` to 1, you don't need to reboot your DB instance. Otherwise, *you must reboot your DB instance for the change to take effect*.
<br><br>


### 7. RDS has appropriate access controls to enforce least privilege

**Capital Group Controls:**<br>

|Control Statement|Description|
|------|----------------------|
|Control ID |Control Description|

**Why?**<br>
When you create custom policies, grant only the permissions required to perform a task. Start with a minimum set of permissions and grant additional permissions as necessary. Doing so is more secure than starting with permissions that are too lenient and then trying to tighten them later.  

To the extent that it's practical, define the conditions under which your identity-based policies allow access to a resource. For example, you can write conditions to specify a range of allowable IP addresses that a request must come from. You can also write conditions to allow requests only within a specified date or time range, or to require the use of SSL or MFA.

**How?**<br>
RDS is fully integrated with AWS IAM for authentication and access control. Use IAM to create IAM users, groups and roles with appropriate permissions, and then add users to appropriate groups and roles. Use Multifactor Authentication for extra security (especially for users with administrative privileges).  
Use AWS Identity and Access Management (IAM) policies to assign permissions that determine who is allowed to manage Amazon RDS resources. For example, you can use IAM to determine who is allowed to create, describe, modify, and delete DB instances, tag resources, or modify security groups.

The following example policy allows a principal to perform specific actions in RDS, but only on resources tagged as "development" or "test":
```json
{
   "Version":"2012-10-17",
   "Statement":[
      {
         "Sid":"AllowDevTestCreate",
         "Effect":"Allow",
         "Action":[
            "rds:ModifyDBInstance",
            "rds:CreateDBSnapshot"
         ],
         "Resource":"*",
         "Condition":{
            "StringEquals":{
               "rds:db-tag/stage":[
                  "development",
                  "test"
               ]
            }
         }
      }
   ]
}
```

#### **IAM Database Authentication**
You can authenticate to your DB instance using AWS IAM database authentication. IAM database authentication works with MySQL and PostgreSQL. With this authentication method, you don't need to use a password when you connect to a DB instance. Instead, you use an authentication token.  
The following AWS CLI command can be used to enable IAM authentication on an existing RDS database:
```
aws rds modify-db-instance \
    --db-instance-identifier mydbinstance \
    --apply-immediately \
    --enable-iam-database-authentication
```
<br>

### 8. RDS instances are configured for high-availability

**Capital Group Controls:**<br>

|Control Statement|Description|
|------|----------------------|
|Control ID |Control Description|

**Why?**<br> 

Amazon RDS provides high availability and failover support for DB instances using Multi-AZ deployments. In a Multi-AZ deployment, Amazon RDS automatically provisions and maintains a synchronous standby replica in a different Availability Zone. The primary DB instance is synchronously replicated across Availability Zones to a standby replica to provide data redundancy, eliminate I/O freezes, and minimize latency spikes during system backups. Running a DB instance with high availability can enhance availability during planned system maintenance, and help protect your databases against DB instance failure and Availability Zone disruption.

**How?**<br> 

Using the RDS console, you can create a Multi-AZ deployment by simply specifying Multi-AZ when creating a DB instance. You can use the console to convert existing DB instances to Multi-AZ deployments by modifying the DB instance and specifying the Multi-AZ option. You can also specify a Multi-AZ deployment with the AWS CLI by specifying the `--multi-az` option as `true` in either the `create-db-instance` or `modify-db-instance` commands.

#### Example Deployment
<img src="/docs/img/rds/failover.png" width="500">
<br>


### 9. RDS database secrets are vaulted for automatic rotation

**Capital Group Controls:**<br>

|Control Statement|Description|
|------|----------------------|
|Control ID |Control Description|

**Why?**<br>
In the past, when you created a custom application to retrieve information from a database, you typically embedded the credentials, the secret, for accessing the database directly in the application. When the time came to rotate the credentials, you had to do more than just create new credentials. You had to invest time to update the application to use the new credentials. Then you distributed the updated application. If you had multiple applications with shared credentials and you missed updating one of them, the application failed. Because of this risk, many customers choose not to regularly rotate credentials, which effectively substitutes one risk for another.  

A vaulting solution enables you to replace hardcoded credentials in your code, including passwords, with an API call to retrieve the secret programmatically. This helps ensure the secret can't be compromised by someone examining your code, because the secret no longer exists in the code.

**How?**<br>
You can configure AWS Secrets Manager to automatically rotate the secret for a secured database. Secrets Manager natively knows how to rotate secrets for supported Amazon RDS databases. Because each database can have a unique way of configuring secrets, Secrets Manager uses a Lambda function you can customize to work with a selected database.

When you enable rotation for a secret by using the **Credentials for RDS database** secret type, Secrets Manager provides a Lambda rotation function for you and populates the function automatically with the Amazon Resource Name (ARN) in the secret. You provide a few details for this to work. For example, you specify the secret with permissions to rotate the credentials, and how often you want to rotate the secret.

If you run your Amazon RDS DB instance in a VPC, and the VPC doesn't have public Internet access, then Secrets Manager also configures the Lambda function to run within that VPC. In order for the Lambda function to access the Secrets Manager API and retrieve secrets, a service endpoint will need to be created, which will keep all traffic on the AWS network, and removes the need for Internet access in the VPC. To set up the endpoint for Secrets Manager, run the following command.
```
aws ec2 create-vpc-endpoint  --vpc-id <vpc id> \
                             --vpc-endpoint-type Interface \
                             --service-name com.amazonaws.<region>.secretsmanager \
                             --subnet-ids <subnet id> \
                             --security-group-id <security group id>
```
<br>

### 10. RDS uses CloudWatch and EventBridge events for anomaly detection

**Capital Group Controls:**<br>

|Control Statement|Description|
|------|----------------------|
|Control ID |Control Description|

**Why?**<br>
Understanding instance behavior and having the ability to be notified of anomalies to that behavior is key to securing your RDS deployments.

**How?**<br>
Utilize Amazon CloudWatch Events and Amazon EventBridge Events for Amazon RDS

### Getting CloudWatch Events and Amazon EventBridge Events for Amazon RDS

Amazon CloudWatch Events and Amazon EventBridge both enable you to automate AWS services and respond to system events such as application availability issues or resource changes\. Events from AWS services are delivered to CloudWatch Events and EventBridge nearly in real time\. You can write simple rules to indicate which events interest you and what automated actions to take when an event matches a rule\.

You can set a variety of targets—such as an AWS Lambda function or an Amazon SNS topic—which receive events in JSON format\. For more information, see the [Amazon CloudWatch Events User Guide](https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/) and the [Amazon EventBridge User Guide](https://docs.aws.amazon.com/eventbridge/latest/userguide/)\.

For example, you can configure Amazon RDS to send events to CloudWatch Events or Amazon EventBridge whenever a DB instance is created or deleted\.

### Sending Amazon RDS Events to CloudWatch Events
You can create CloudWatch Events rules to send Amazon RDS events to CloudWatch Events\.

Use the following steps to create a CloudWatch Events rule that triggers on an event emitted by an AWS service\.

**To create a rule that triggers on an event:**

1. Open the CloudWatch console at [https://console\.aws\.amazon\.com/cloudwatch/](https://console.aws.amazon.com/cloudwatch/)\.

1. Under **Events** in the navigation pane, choose **Rules**\.

1. Choose **Create rule**\.

1. For **Event Source**, do the following:

   1. Choose **Event Pattern**\.

   1. For **Service Name**, choose **Relational Database Service \(RDS\)**\.

   1. For **Event Type**, choose the type of Amazon RDS resource that triggers the event\. For example, if a DB instance triggers the event, choose **RDS DB Instance Event**\.

1. For **Targets**, choose **Add Target**, then choose the **CloudWatch log group**\. 

1. For **Log Group**, enter a name for the log group to store the events\. 

1. Choose **Configure details**\. For **Rule definition**, type a name and description for the rule\. 

1. Choose **Create rule**\.

### DB Instance Events

The following is an example of a DB instance event\.

```
{
  "version": "0",
  "id": "68f6e973-1a0c-d37b-f2f2-94a7f62ffd4e",
  "detail-type": "RDS DB Instance Event",
  "source": "aws.rds",
  "account": "123456789012",
  "time": "2018-09-27T22:36:43Z",
  "region": "us-east-1",
  "resources": [
    "arn:aws:rds:us-east-1:123456789012:db:my-db-instance"
  ],
  "detail": {
    "EventCategories": [
      "failover"
    ],
    "SourceType": "DB_INSTANCE",
    "SourceArn": "arn:aws:rds:us-east-1:123456789012:db:my-db-instance",
    "Date": "2018-09-27T22:36:43.292Z",
    "SourceIdentifier": "rds:my-db-instance",
    "Message": "A Multi-AZ failover has completed."
  }
}
```

### DB Parameter Group Events

The following is an example of a DB parameter group event\.

```
{
  "version": "0",
  "id": "844e2571-85d4-695f-b930-0153b71dcb42",
  "detail-type": "RDS DB Parameter Group Event",
  "source": "aws.rds",
  "account": "123456789012",
  "time": "2018-10-06T12:26:13Z",
  "region": "us-east-1",
  "resources": [
    "arn:aws:rds:us-east-1:123456789012:pg:my-db-param-group"
  ],
  "detail": {
    "EventCategories": [
      "configuration change"
    ],
    "SourceType": "DB_PARAM",
    "SourceArn": "arn:aws:rds:us-east-1:123456789012:pg:my-db-param-group",
    "Date": "2018-10-06T12:26:13.882Z",
    "SourceIdentifier": "rds:my-db-param-group",
    "Message": "Updated parameter time_zone to UTC with apply method immediate"
  }
}
```

### DB Security Group Events

The following is an example of a DB security group event\.

```
{
  "version": "0",
  "id": "844e2571-85d4-695f-b930-0153b71dcb42",
  "detail-type": "RDS DB Security Group Event",
  "source": "aws.rds",
  "account": "123456789012",
  "time": "2018-10-06T12:26:13Z",
  "region": "us-east-1",
  "resources": [
    "arn:aws:rds:us-east-1:123456789012:secgrp:my-security-group"
  ],
  "detail": {
    "EventCategories": [
      "configuration change"
    ],
    "SourceType": "SECURITY_GROUP",
    "SourceArn": "arn:aws:rds:us-east-1:123456789012:secgrp:my-security-group",
    "Date": "2018-10-06T12:26:13.882Z",
    "SourceIdentifier": "rds:my-security-group",
    "Message": "Applied change to security group"
  }
}
```

### DB Snapshot Events 

The following is an example of a DB snapshot event\.

```
{
  "version": "0",
  "id": "844e2571-85d4-695f-b930-0153b71dcb42",
  "detail-type": "RDS DB Snapshot Event",
  "source": "aws.rds",
  "account": "123456789012",
  "time": "2018-10-06T12:26:13Z",
  "region": "us-east-1",
  "resources": [
    "arn:aws:rds:us-east-1:123456789012:snapshot:rds:my-db-snapshot"
  ],
  "detail": {
    "EventCategories": [
      "deletion"
    ],
    "SourceType": "SNAPSHOT",
    "SourceArn": "arn:aws:rds:us-east-1:123456789012:snapshot:rds:my-db-snapshot",
    "Date": "2018-10-06T12:26:13.882Z",
    "SourceIdentifier": "rds:my-db-snapshot",
    "Message": "Deleted manual snapshot"
  }
}
```
<br>

### 11. Log RDS API calls with CloudTrail

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|N/A| No security control currently defined.|

**Why?**<br>

Using the information collected by Cloudtrail, you can determine the request that was made to Amazon RDS, The IP address from which the request was made, who made the request. when the request was made and additional details that will help protect your database instances. 

**How?**<br>

### Log Amazon RDS API Calls with AWS CloudTrail

Amazon RDS is integrated with AWS CloudTrail, a service that provides a record of actions taken by a user, role, or an AWS service in Amazon RDS\. CloudTrail captures all API calls for Amazon RDS as events, including calls from the Amazon RDS console and from code calls to the Amazon RDS APIs\. If you create a trail, you can enable continuous delivery of CloudTrail events to an Amazon S3 bucket, including events for Amazon RDS\. If you don't configure a trail, you can still view the most recent events in the CloudTrail console in **Event history**\. Using the information collected by CloudTrail, you can determine the request that was made to Amazon RDS, the IP address from which the request was made, who made the request, when it was made, and additional details\. 

To learn more about CloudTrail, see the [CloudTrail Runbook](https://github.com/open-itg/aws_runbooks/blob/master/cloudtrail/Runbook.md).

### Amazon RDS Information in CloudTrail

CloudTrail is enabled on your AWS account when you create the account\. When activity occurs in Amazon RDS, that activity is recorded in a CloudTrail event along with other AWS service events in **Event history**\. You can view, search, and download recent events in your AWS account\. For more information, see [Viewing Events with CloudTrail Event History](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/view-cloudtrail-events.html)\. 

For an ongoing record of events in your AWS account, including events for Amazon RDS, create a trail\. A trail enables CloudTrail to deliver log files to an Amazon S3 bucket\. By default, when you create a trail in the console, the trail applies to all regions\. The trail logs events from all regions in the AWS partition and delivers the log files to the Amazon S3 bucket that you specify\. Additionally, you can configure other AWS services to further analyze and act upon the event data collected in CloudTrail logs\. For more information, see: 
+ [Overview for Creating a Trail](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-create-and-update-a-trail.html)
+ [CloudTrail Supported Services and Integrations](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-aws-service-specific-topics.html#cloudtrail-aws-service-specific-topics-integrations)
+ [Configuring Amazon SNS Notifications for CloudTrail](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/getting_notifications_top_level.html)
+ [Receiving CloudTrail Log Files from Multiple Regions](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/receive-cloudtrail-log-files-from-multiple-regions.html) and [Receiving CloudTrail Log Files from Multiple Accounts](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-receive-logs-from-multiple-accounts.html)

All Amazon RDS actions are logged by CloudTrail and are documented in the [Amazon RDS API Reference](https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/)\. For example, calls to the `CreateDBInstance`, `ModifyDBInstance`, and `CreateDBParameterGroup` actions generate entries in the CloudTrail log files\. 

Every event or log entry contains information about who generated the request\. The identity information helps you determine the following: 
+ Whether the request was made with root or IAM user credentials\.
+ Whether the request was made with temporary security credentials for a role or federated user\.
+ Whether the request was made by another AWS service\.

For more information, see the [CloudTrail userIdentity Element](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-user-identity.html)\.

### Understanding Amazon RDS Log File Entries

A trail is a configuration that enables delivery of events as log files to an Amazon S3 bucket that you specify\. CloudTrail log files contain one or more log entries\. An event represents a single request from any source and includes information about the requested action, the date and time of the action, request parameters, and so on\. CloudTrail log files are not an ordered stack trace of the public API calls, so they do not appear in any specific order\. 

The following example shows a CloudTrail log entry that demonstrates the `CreateDBInstance` action\.

```
{
    "eventVersion": "1.04",
    "userIdentity": {
        "type": "IAMUser",
        "principalId": "AKIAIOSFODNN7EXAMPLE",
        "arn": "arn:aws:iam::123456789012:user/johndoe",
        "accountId": "123456789012",
        "accessKeyId": "AKIAI44QH8DHBEXAMPLE",
        "userName": "johndoe"
    },
    "eventTime": "2018-07-30T22:14:06Z",
    "eventSource": "rds.amazonaws.com",
    "eventName": "CreateDBInstance",
    "awsRegion": "us-east-1",
    "sourceIPAddress": "192.0.2.0",
    "userAgent": "aws-cli/1.15.42 Python/3.6.1 Darwin/17.7.0 botocore/1.10.42",
    "requestParameters": {
        "enableCloudwatchLogsExports": [
            "audit",
            "error",
            "general",
            "slowquery"
        ],
        "dBInstanceIdentifier": "test-instance",
        "engine": "mysql",
        "masterUsername": "myawsuser",
        "allocatedStorage": 20,
        "dBInstanceClass": "db.m1.small",
        "masterUserPassword": "****"
    },
    "responseElements": {
        "dBInstanceArn": "arn:aws:rds:us-east-1:123456789012:db:test-instance",
        "storageEncrypted": false,
        "preferredBackupWindow": "10:27-10:57",
        "preferredMaintenanceWindow": "sat:05:47-sat:06:17",
        "backupRetentionPeriod": 1,
        "allocatedStorage": 20,
        "storageType": "standard",
        "engineVersion": "5.6.39",
        "dbInstancePort": 0,
        "optionGroupMemberships": [
            {
                "status": "in-sync",
                "optionGroupName": "default:mysql-5-6"
            }
        ],
        "dBParameterGroups": [
            {
                "dBParameterGroupName": "default.mysql5.6",
                "parameterApplyStatus": "in-sync"
            }
        ],
        "monitoringInterval": 0,
        "dBInstanceClass": "db.m1.small",
        "readReplicaDBInstanceIdentifiers": [],
        "dBSubnetGroup": {
            "dBSubnetGroupName": "default",
            "dBSubnetGroupDescription": "default",
            "subnets": [
                {
                    "subnetAvailabilityZone": {"name": "us-east-1b"},
                    "subnetIdentifier": "subnet-cbfff283",
                    "subnetStatus": "Active"
                },
                {
                    "subnetAvailabilityZone": {"name": "us-east-1e"},
                    "subnetIdentifier": "subnet-d7c825e8",
                    "subnetStatus": "Active"
                },
                {
                    "subnetAvailabilityZone": {"name": "us-east-1f"},
                    "subnetIdentifier": "subnet-6746046b",
                    "subnetStatus": "Active"
                },
                {
                    "subnetAvailabilityZone": {"name": "us-east-1c"},
                    "subnetIdentifier": "subnet-bac383e0",
                    "subnetStatus": "Active"
                },
                {
                    "subnetAvailabilityZone": {"name": "us-east-1d"},
                    "subnetIdentifier": "subnet-42599426",
                    "subnetStatus": "Active"
                },
                {
                    "subnetAvailabilityZone": {"name": "us-east-1a"},
                    "subnetIdentifier": "subnet-da327bf6",
                    "subnetStatus": "Active"
                }
            ],
            "vpcId": "vpc-136a4c6a",
            "subnetGroupStatus": "Complete"
        },
        "masterUsername": "myawsuser",
        "multiAZ": false,
        "autoMinorVersionUpgrade": true,
        "engine": "mysql",
        "cACertificateIdentifier": "rds-ca-2015",
        "dbiResourceId": "db-ETDZIIXHEWY5N7GXVC4SH7H5IA",
        "dBSecurityGroups": [],
        "pendingModifiedValues": {
            "masterUserPassword": "****",
            "pendingCloudwatchLogsExports": {
                "logTypesToEnable": [
                    "audit",
                    "error",
                    "general",
                    "slowquery"
                ]
            }
        },
        "dBInstanceStatus": "creating",
        "publiclyAccessible": true,
        "domainMemberships": [],
        "copyTagsToSnapshot": false,
        "dBInstanceIdentifier": "test-instance",
        "licenseModel": "general-public-license",
        "iAMDatabaseAuthenticationEnabled": false,
        "performanceInsightsEnabled": false,
        "vpcSecurityGroups": [
            {
                "status": "active",
                "vpcSecurityGroupId": "sg-f839b688"
            }
        ]
    },
    "requestID": "daf2e3f5-96a3-4df7-a026-863f96db793e",
    "eventID": "797163d3-5726-441d-80a7-6eeb7464acd4",
    "eventType": "AwsApiCall",
    "recipientAccountId": "123456789012"
}
```
<br><br>

## Operational Best Practices

### 1. RDS Resources are tagged according to CG standards

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|N/A| No security control currently defined.|

**What, Why & How?**

Tagging resources in the cloud is an easy way for teams to provide information related to who owns the resource, what the resource is used for, as well as other important information related to the deployment lifecycle of the resource. CG has mandated that all cloud resources are to be tagged with certain important for cross-team use. Although most of the mandatory tags will be added through automation, one should still check to make sure that all newly deployed recources have the appropriate tags attached. please see the documentation below for the latest tagging standards.

[CG Cloud Tagging Strategy](https://confluence.capgroup.com/display/HCEA/Resource+Tagging+standards)
<br><br>

### 2. RDS auto minor version upgrade is enabled

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|N/A| No security control currently defined.|

**Why?**<br>

RDS can be upgraded with major and minor upgrades\. Minor upgrades helps maintain a secure and stable RDS with minimal impact on the application\. Auto Minor Version Upgrade is a feature that you can enable to have your database automatically upgraded when a new minor database engine version is available\. It is recommended to have RDS auto minor version upgrade enabled\.

After a minor version has been tested and approved by Amazon RDS, the minor version upgrade occurs automatically during your maintenance window\. RDS doesn't automatically set newer released minor versions as the automatic upgrade version\. Before RDS designates a newer automatic upgrade version, several criteria are considered, such as the following:
1. Known security issues\.
2. Bugs in the PostgreSQL community version\.
3. Overall fleet stability since the minor version was released\.

**How?**<br>

#### Enable RDS auto minor version upgrades\.
1. Navigate to the AWS console RDS dashboard\.
2. In the navigation pane, select Databases\.
3. Select the database instance you wish to configure and select Modify\.
4. Under the Maintenance section, select Yes for `"Enable Auto minor version upgrade"`\.
5. Select Continue and then Modify DB Instance\.
You can also use the AWS CLI, and set the `--auto-minor-version-upgrade|--no-auto-minor-version-upgrade` option using modify-db-instance api\.
<br><br>

## Endnotes
**Resources**<br>
1. [Encryption of RDS Snapshots](https://aws.amazon.com/premiumsupport/knowledge-center/encrypt-rds-snapshots/)
2. [Sharing of RDS Snapshots](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ShareSnapshot.html)
<br><br>

## Capital Group Glossory 
**Data** - Digital pieces of information stored or transmitted for use with an information system from which understandable information is derived. Items that could be considered to be data are: Source code, meta-data, build artifacts, information input and output.  
 
**Information System** - An organized assembly of resources and procedures for the collection, processing, maintenance, use, sharing, dissemination, or disposition of information. All systems, platforms, compute instances including and not limited to physical and virtual client endpoints, physical and virtual servers, software containers, databases, Internet of Things (IoT) devices, network devices, applications (internal and external), Serverless computing instances (i.e. AWS Lambda), vendor provided appliances, and third-party platforms, connected to the Capital Group network or used by Capital Group users or customers.

**Log** - a record of the events occurring within information systems and networks. Logs are composed of log entries; each entry contains information related to a specific event that has occurred within a system or network.

**Information** - communication or representation of knowledge such as facts, data, or opinions in any medium or form, including textual, numerical, graphic, cartographic, narrative, or audiovisual. 

**Cloud computing** - A model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources (e.g., networks, servers, storage, applications, and services) that can be rapidly provisioned and released with minimal management effort or service provider interaction.

**Vulnerability**  - Weakness in an information system, system security procedures, internal controls, or implementation that could be exploited or triggered by a threat source. Note: The term weakness is synonymous for deficiency. Weakness may result in security and/or privacy risks.