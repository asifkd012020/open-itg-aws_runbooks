<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# AWS CodeDeploy - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1.Use CodeDeploy Identity-based policies to ensure least-privilege is enforced to create, delete, or update deployment configurations and deployment groups.](#1-use-codedeploy-identity-based-policies-to-ensure-least-privilege-is-enforced-to-create-delete-or-update-deployment-configurations-and-deployment-groups)
- [Detective](#detective)
  - [1. Audit and monitor all interactions with AWS CodeDeploy using AWS Cloudtrail](#1-Audit-and-monitor-all-interactions-with-AWS-CodeDeploy-using-AWS-Cloudtrail)
-[Respond/Recover](#respondrecover)
  -[Utilize AWS CloudWatch alarm actions to automatically stop, terminate, reboot, or recover EC2 instances when a deployment or instance event you specify occurs](#1-utilize-aws-cloudWatch-alarm-actions-to-automatically-stop-terminate-reboot-or-recover-ec-instances-when-a-deployment-or-instance-event-you-specify-occurs)
- [Endnotes](#endnotes)

## Overview
AWS provides a number of security features for AWS CodeDeploy which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: ID, PR.AC-2, PR.AC-5, PR.AT, PR.DS-3, PR.DS-7, PR.DS-8, PR.IP (Unless Stated), PR.MA, PR.PT-2, PR.PT-3, DE.CM-2, DE.CM-6, DE.DP, RS.RP, RS.CO, RS.MI, RS.IM, RC

## Preventative Controls
### 1. Use CodeDeploy Identity-based policies to ensure least-privilege is enforced to create, delete, or update deployment configurations and deployment groups. 
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|  
|PR.AC-6|Identities are protected and bound to credentials and asserted in interactios
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individuals’ security and privacy risks and other organizational risks)|
|PR.PT-3|The principle of least functionality is incorporated by configuring systems to provide only essential capabilities|

**Why?** With AWS COdeDeploy IAM identity-based policies, you can specify allowed or denied actions and resources and the conditions under which actions are allowed or denied.

**How?**
- CodeDeploy identity-based policies supports **Actions**, **Resources**, **Condition Keys**, and **Service Roles** 
    - **Actions** – The Action element of an IAM idenity-based policy describesd the specific actions or actions that will be allowed ot denied by the policy. Policy actions usually have the same name as the associated AWS API operation. The action is used in a policy to grant permissions to perform the associated operation. Policy statements must include an **Action** or **NotAction** element.
    For information on Actions defined by CodeDeploy, see [Endnote 1](#endnote-1).
    - **Resources** - The Resources element specifies the object or objects to which the action applies. Statements must include either a **Resources** or **NotResource** statement. 
    - **Condition Keys** - Use the availble Global Condition Keys to further refine the conditions under which a policy statement applies. 
    - **Service Roles** - The service role feature allows a service to assume a service role on your behalf. This allows service to access resources in other services to complete an action on your behalf.

For more information on IAM identity-based policies for CodeDeploy, including examples, see [Endnote 2](#endnote-2).


## Detective

### 1. Audit and monitor all interactions with AWS CodeDeploy using AWS Cloudtrail 
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|  

**Why?** Using the information collected by CloudTrail, you can determine which request was made to CodeDeploy, the source IP address from which the request was made, who made the request, when it was made, and so on.

**How?** CodeDeploy is integrated with AWS CloudTrail, a service that captures API calls made by or on behalf of CodeDeploy in your AWS account and delivers the log files to an S3 bucket you specify. CloudTrail captures API calls from the CodeDeploy console, from CodeDeploy commands through the AWS CLI, or from the CodeDeploy APIs directly.

### 2. Centrailaize and View AWS CodeDeploy logs in Amazon CloudWatch utilizing Cloudwatch Events 
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.AE-4|Impact of events is determined
|DE.AE-5|Incident Alert thresholds are established
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|  

**Why?** You can use Amazon CloudWatch Events to detect and react to changes in the state of an instance or a deployment (an event) in your CodeDeploy operations. Then, based on rules you create, CloudWatch Events invokes one or more target actions when a deployment or instance enters the state you specify in a rule. Depending on the type of state change, you might want to send notifications, capture state information, take corrective action, initiate events, or take other actions

**How?** Install and configure the CloudWatch Log agent and add the required IAM permissions to each instance profile.  
For instruction on installing the AWS CloudWatch Logs Agent, see [Endnote 3](#endnote-3).

## Respond/Recover
### 1. Utilize AWS CloudWatch alarm actions to automatically stop, terminate, reboot, or recover EC2 instances when a deployment or instance event you specify occurs
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN-1|Notifications from detection systems are investigated|
|RS.AN-2|The impact of the incident is understood|
|RS.AN-3|Forensics are performed|
|RS.AN-4|Incidents are categorized consistent with response plans|
|RS.AN-5|Processes are established to receive, analyze and respond to vulnerabilities disclosed to the organization from internal and external sources (e.g. internal testing, security bulletins, or security researchers)|

**Why?** An alarm watches a single metric over a time period you specify and performs one or more actions based on the value of the metric relative to a given threshold over a number of time periods. CloudWatch alarms invoke actions when their state changes (for example, from OK to ALARM).

**How?** Using native CloudWatch alarm functionality, you can specify any of the actions supported by CloudWatch when an instance you are using in a deployment fails, such as sending an Amazon SNS notification or stopping, terminating, rebooting, or recovering an instance. For your CodeDeploy operations, you can configure a deployment group to stop a deployment whenever any CloudWatch alarm you associate with the deployment group is activated.

You can associate up to ten CloudWatch alarms with a CodeDeploy deployment group. If any of the specified alarms are activated, the deployment stops, and the status is updated to Stopped. To use this option, you must grant CloudWatch permissions to your CodeDeploy service role.  
See [Endnote 4](#endnote-4) for more information on Using Amazon CloudWatch Alamrs.

## Endnotes
### Endnote 1 <!-- omit in toc -->
[https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscodedeploy.html#awscodedeploy-actions-as-permissions](https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscodedeploy.html#awscodedeploy-actions-as-permissions)
### Endnote 2 <!-- omit in toc -->
[https://docs.aws.amazon.com/codedeploy/latest/userguide/security_iam_id-based-policy-examples.html](https://docs.aws.amazon.com/codedeploy/latest/userguide/security_iam_id-based-policy-examples.html)
### Endnote 3 <!-- omit in toc -->
[https://aws.amazon.com/blogs/devops/view-aws-codedeploy-logs-in-amazon-cloudwatch-console/](https://aws.amazon.com/blogs/devops/view-aws-codedeploy-logs-in-amazon-cloudwatch-console/)
### Endnote 4 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html)
