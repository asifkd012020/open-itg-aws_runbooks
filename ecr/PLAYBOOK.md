<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# Amazon Elastic Container Registry (ECR) - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1. Implement strict IAM policies around who/what is allowed to use the service](#1-implement-strict-iam-policies-around-whowhat-is-allowed-to-use-the-service)
  - [2. Take measures to ensure data is protected](#2-take-measures-to-ensure-data-is-protected)
  - [3. Implement strong infrastructure controls using VPC Endpoints, data management, and monitoring](#3-implement-strong-infrastructure-controls-using-vpc-endpoints-data-management-and-monitoring)
- [Detective](#detective)
  - [1. Establish network/application monitoring controls](#1-establish-networkapplication-monitoring-controls)
  - [2. Run vulnerability scans on images stored in ECR](#2-run-vulnerability-scans-on-images-stored-in-ecr)
- [Respond/Recover](#respondrecover)
  - [1. Utilize Amazon EventBridge for automated incident response](#1-utilize-amazon-eventbridge-for-automated-incident-response)
- [Endnotes](#endnotes)

## Overview
AWS provides a number of security features for Amazon Elastic Container Registry (ECR) which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: ID, PR.AC-2, PR.AT, PR.DS-3, PR.DS-7, PR.DS-8, PR.IP (Unless Stated), PR.MA, PR.PT-2, PR.PT-3, DE.AE-4, DE.AE-5, DE.CM-2, DE.CM-6, DE.DP, RS.RP, RS.CO, RS.MI, RS.IM, RC

## Preventative Controls
### 1. Implement strict IAM policies around who/what is allowed to use the service
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|
|PR.AC-6|Identities are proofed and bound to credentials and asserted in interactions|
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individualsâ€™ security and privacy risks and other organizational risks)|

**Why?** ECR contains registries of some of the organization's most sensitive IP and data. Implement levels of privilege and have authorization mechanisms in place to enforce the separation of privileges, mandate multi-factor authentication, and similar protections based on sensitivity.

**How?** ECR is fully integrated with AWS IAM for authentication and access control. Use IAM to create IAM users, groups and roles with appropriate permissions, and then add users to appropriate groups and roles. Use Multifactor Authentication for extra security (especially for users with administrative privileges). Customers can define granular, API level access to container image repositories.  
Leverage IAM Policy Conditions to achieve fine-grained access control in ECR, which allows you to specify conditions that determine how a permissions policy takes effect. See [Endnote 1](#endnote-1).  
Using IAM Roles to authenticate access to ECR is best practice, which enables temporary access keys (removing any reliance on long-term credentials that may not be automatically rotated).

### 2. Data is protected
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|
|PR.DS-5|Protections against data leaks are implemented|
|PR.DS-6|Integrity checking mechanisms are used to verify software, firmware, and information integrity|
|PR.IP-1|A baseline configuration of information technology/industrial control systems is created and maintained incorporating security principles (e.g. concept of least functionality)|

**Why?** Data should be protected in-transit between the customer and AWS, as well as within AWS Services using NIST-approved encryption mechanism.

**How?** Amazon ECR automatically encrypts images at rest using S3 server-side encryption. Amazon S3 server-side encryption uses 256-bit Advanced Encryption Standard (AES-256), to encrypt your data. Amazon ECR also transfers container images using HTTPS.  
Use CloudTrail to monitor for anomalous API activity, including calls to/from external IPs or accounts.  
Use AWS Config to track for any configuration drift within ECR and its supporting services, like IAM and CloudTrail.

### 3. Infrastructure must be secured for monitoring, audit, availability, and access control
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.PT-1|Audit/log records are determined, documented, implemented, and reviewed in accordance with policy|
|PR.PT-4|Communications and control networks are protected|
|PR.PT-5|Mechanisms (e.g., failsafe, load balancing, hot swap) are implemented to achieve resilience requirements in normal and adverse situations|
|PR.AC-3|Remote access is managed|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|
|PR.DS-4|Adequate capacity to ensure availability is maintained|

**Why?** Images stored within ECR are backed by S3. The data is highly available, thanks to built-in replication. Integrity, however can be improved through the use of VPC Endpoints, CloudTrail, and a configuration management tool.

**How?** AWS PrivateLink endpoints allow your ECS instances to pull images without traversing through the public internet. Amazon Elastic Container Registry (ECR) now supports PrivateLink Endpoint Policies, a capability that enables customers to better control access to Amazon ECR repositories and images using private endpoints. For more information on setting up VPC Endpoints on ECR, see [Endnote 2](#endnote-2).  
Use AWS Config to track for any configuration drift to VPC Subnet ACL's.  
CloudTrail captures all API calls for Amazon ECR as events, including calls from the Amazon ECR console and from code calls to the Amazon ECR APIs. These logs should be monitored regularly to ensure no changes are made to Config or ECR.

## Detective
### 1. Establish network/application monitoring controls
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|

**Why?** Actions taken within ECR, even those with no malicious intent, can have negative impacts on the business. Being able to identify when an image was altered, or who connected to the service and from where, are valuable pieces of information during a forensic investigation.

**How?** Setup CloudWatch to log metrics and detect events, AWS Config to monitor the integrity of ECR assets, and CloudTrail for monitoring API activity.

### 2. Run vulnerability scans on images stored in ECR
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-4|Malicious code is detected|
|DE.CM-8|Vulnerability scans are performed|

**Why?** Amazon ECR image scanning helps in identifying software vulnerabilities in your container images. Amazon ECR uses the Common Vulnerabilities and Exposures (CVEs) database from the open source CoreOS Clair project and provides you with a list of scan findings. You can review the scan findings for information about the security of the container images that are being deployed.

**How?** You can manually scan container images stored in Amazon ECR, or you can configure your repositories to scan images when you push them to a repository. The last completed image scan findings can be retrieved for each image. Amazon ECR sends an event to Amazon EventBridge when an image scan is completed. For details on how to set up scans on an image or repository, see [Endnote 3](#endnote-3).

## Respond/Recover
### 1. Utilize an event-based solution for automated incident response
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN-1|Notifications from detection systems are investigated|
|RS.AN-2|The impact of the incident is understood|
|RS.AN-3|Forensics are performed|
|RS.AN-4|Incidents are categorized consistent with response plans|
|RS.AN-5|Processes are established to receive, analyze and respond to vulnerabilities disclosed to the organization from internal and external sources (e.g. internal testing, security bulletins, or security researchers)|

**Why?** Using an event-based solution, you can automatically report and respond to incidents of almost any kind, including ECR actions, Image Scans, or API Calls via CloudTrail.

**How?** For various incident types, an appropriate response rule should be determined and added to Amazon EventBridge. Depending on the organization's Incident Response Plan, there may be need for human interaction in some cases, or fully automated remediation in other cases. For information on setting up EventBridge with ECR, as well as some sample events, see [Endnote 4](#endnote-4).

## Endnotes
### Endnote 1 <!-- omit in toc -->
[https://docs.aws.amazon.com/IAM/latest/UserGuide/list_amazonelasticcontainerregistry.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/list_amazonelasticcontainerregistry.html)
### Endnote 2 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonECR/latest/userguide/vpc-endpoints.html](https://docs.aws.amazon.com/AmazonECR/latest/userguide/vpc-endpoints.html)
### Endnote 3 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonECR/latest/userguide/image-scanning.html](https://docs.aws.amazon.com/AmazonECR/latest/userguide/image-scanning.html)
### Endnote 4 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonECR/latest/userguide/ecr-eventbridge.html](https://docs.aws.amazon.com/AmazonECR/latest/userguide/ecr-eventbridge.html)