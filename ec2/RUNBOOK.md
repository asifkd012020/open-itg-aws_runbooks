<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# Amazon Elastic Compute Cloud (EC2) - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1. Enforce strict boundaries for access to _and_ from EC2 instances](#1-enforce-strict-boundaries-for-access-to-and-from-ec2-instances)
  - [2. Data Protection standards are enforced](#2-data-protection-standards-are-enforced)
  - [3. Network access to EC2 instances and API is restricted](#3-network-access-to-ec2-instances-and-api-is-restricted)
  - [4. Close unnecessary administrative access ports to instances](#4-close-unnecessary-administrative-access-ports-to-instances)
- [Detective](#detective)
  - [1. Monitor EC2 instance activity](#1-monitor-ec2-instance-activity)
  - [2. Log Amazon EC2 and Amazon EBS API calls](#2-log-amazon-ec2-and-amazon-ebs-api-calls)
  - [3. Monitor EC2 Instance metrics for anomalous behavior](#3-monitor-ec2-instance-metrics-for-anomalous-behavior)
  - [4. EC2 instance should have SSM Managed](#4-ec2-instance-should-have-ssm-managed)
  - [5. EC2 instance should have Qualys agent installed](#5-ec2-instance-should-have-qualys-agent-installed)
- [Respond/Recover](#respondrecover)
  - [1. Utilize Amazon cloudWatch alarm actions](#1-utilize-amazon-cloudwatch-alarm-actions)
- [Endnotes](#endnotes)
- [Capital Group Control Statements](#capital-group-control-statements)
- [Glossary](#glossary)

## Overview
AWS provides a number of security features for Amazon Elastic Compute Cloud (EC2) which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: ID, PR.AC-2, PR.AT, PR.DS (Unless stated), PR.IP (Unless Stated), PR.MA, PR.PT-2, DE.AE-4, DE.AE-5, DE.CM-2, DE.CM-6, DE.DP, RS.RP, RS.CO, RS.MI, RS.IM, RC

This Capital Group Control Statement is not applicable to this service: [9](#capital-group-control-statements)

## Preventative Controls
### 1. Enforce strict boundaries for access to _and_ from EC2 instances
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-3|Remote access is managed|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|
|PR.AC-6|Identities are proofed and bound to credentials and asserted in interactions|
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individuals’ security and privacy risks and other organizational risks)|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|5|AWS IAM User accounts are only to be created for use by services or products that do not support IAM Roles. Services are not allowed to create local accounts for human use within the service. All human user authentication will take place within CG’s Identity Provider.|
|8|AWS IAM User secrets, including passwords and secret access keys, are to be rotated every 90 days. Accounts created locally within any service must also have their secrets rotated every 90 days.|
|10|Administrative access to AWS resources will have MFA enabled|

**Why?** Customers should have the capability to implement levels of privilege and have authorization mechanisms in place to enforce the separation of privileges, mandate multi-factor authentication, and similar protections based on sensitivity.

**How?** IAM, Organizations, and supporting AWS Services can be leveraged to customize users, groups, roles, permissions and organize the hierarchy. No local accounts are to be set up on EC2 instances for use by humans. If access is needed to an EC2 instance, it is to be set up through IAM, and authenticated using CG's Identity Provider.

Use IAM Instance Profiles for EC2 access to AWS services. In order for applications on EC2 to access other AWS services, they must include valid AWS credentials in their AWS API requests. Developers should _not_ store AWS credentials directly in the application or EC2 instance as these are long term credentials that are not automatically rotated, and therefore could have significant business impact if they are compromised. You can and should use an IAM role and instance profile to manage temporary credentials for applications or services which need to access AWS services. When you use a role and instance profile, you don't have to distribute long-term credentials (such as a user name and password or access keys) to an EC2 instance, instead the role supplies temporary permissions that applications can use when they make calls to other AWS resources.  
For more information about using IAM Instance Profiles, see [Endnote 1](#endnote-1).

A couple examples of least privilege within EC2 are as follows. Example 1 allows users to create EC2 instances, but only through the Launch Wizard, and only under certain parameters (Instance Type, Subnet, Region). Example 2 shows a policy that allows a specific instance the ability to access certain resources in other AWS services.

#### Example 1: <!-- omit in toc -->  
```json
{
   "Version": "2012-10-17",
   "Statement": [{
      "Effect": "Allow",
      "Action": [
         "ec2:DescribeInstances", 
         "ec2:DescribeImages", 
         "ec2:DescribeKeyPairs", 
         "ec2:CreateKeyPair", 
         "ec2:DescribeVpcs", 
         "ec2:DescribeSubnets", 
         "ec2:DescribeSecurityGroups", 
         "ec2:CreateSecurityGroup", 
         "ec2:AuthorizeSecurityGroupIngress"
	  ],
	  "Resource": "*"
   },
   {
      "Effect": "Allow",
      "Action":"ec2:RunInstances",
      "Resource": [
         "arn:aws:ec2:sa-east-1:111122223333:network-interface/*",
         "arn:aws:ec2:sa-east-1:111122223333:volume/*",
         "arn:aws:ec2:sa-east-1:111122223333:key-pair/*",
         "arn:aws:ec2:sa-east-1:111122223333:security-group/*",
         "arn:aws:ec2:sa-east-1:111122223333:subnet/subnet-1a2b3c4d"
      ]
   },
   {
      "Effect": "Allow",
      "Action": "ec2:RunInstances",
      "Resource": [
         "arn:aws:ec2:sa-east-1:111122223333:instance/*"
      ],
      "Condition": {
         "StringEquals": {
            "ec2:InstanceType": "t2.micro"
         }
      }
   },
   {
      "Effect": "Allow",
      "Action": "ec2:RunInstances",
      "Resource": [ 
            "arn:aws:ec2:sa-east-1::image/ami-*"
      ],
      "Condition": {
         "StringEquals": {
            "ec2:Owner": "amazon"
         }
      }
   }
   ]
}
```

#### Example 2: <!-- omit in toc -->
```json
{
    "Version": "2012-10-17",
    "Statement": [
              {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeVolumes",
                "s3:ListAllMyBuckets",
                "dynamodb:ListTables",
                "rds:DescribeDBInstances"
            ],
            "Resource": [
                "*"
            ],
            "Condition": {
                "ArnEquals": {
                    "ec2:SourceInstanceARN": "arn:aws:ec2:region:account:instance/i-093452212644b0dd6"
                }
            }
        }
    ]
}
```

### 2. Data Protection standards are enforced
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|1|All Data-at-rest must be encrypted and use a CG BYOK encryption key.|
|2|All Data-in-transit must be encrypted using certificates using CG Certificate Authority.|
|3|Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.|

**Why?** Data should be protected at-rest, in-transit between the customer and AWS, as well as in-transit between AWS Services using NIST-approved and CG-approved encryption mechanisms.

**How?** All communications with the EC2 API are encrypted using TLS. No actions are required to ensure data-in-transit to the EC2 API is protected. For communications with EC2 instances, however, that is dependent on the software running on the instance, as well as the ports that are open within the Security Group associated with the instance. Ensure that any server-type software running on the instance is configured to only use secure protocols, and only open those secure ports on the instance's Security Group.  
Some instance types use the offload capabilities of the underlying hardware to automatically encrypt in-transit traffic between instances, using AEAD algorithms with 256-bit encryption. There is no impact on network performance. The following requirements must be met to ensure the additional in-transit traffic encryption:
- The instances use the following instance types: C5n, C5a, G4, I3en, M5dn, M5n, P3dn, R5dn, and R5n.
- The instances are in the same Region.
- The instances are in the same VPC or peered VPCs, and the traffic does not pass through a virtual network device, such as a load balancer or a transit gateway.

EC2 can store data in a few different ways. The most common is using Elastic Block Storage (EBS) volumes. These volumes act as the boot volumes, handling the operating system files, and anything else that is stored locally while the EC2 instance is powered on.  
Another block-type storage solution is NVMe Instance Store. These provide high-speed, ephemeral storage for EC2 instances.  
There are also Elastic File System (EFS) volumes, which can be mounted to an EC2 instance and used as persistent storage, which is accessible by many instances or services concurrently, even when one instance it's mounted to is powered off.  
Lastly, there are instance snapshots and Amazon Machine Images (AMIs). Snapshots are point-in-time copies of an EBS volume, based on the running state of an instance. They are useful for backing up a machine before rolling out updates, or when trying to create AMIs. AMIs are images that can be used to start up new EC2 instances so that they all have the exact same configurations and software installed. AMIs can be created yourself, or are available on the AWS Marketplace.  
Protecting the data on each of these storage mediums is handled a little differently. We will address each one here.

#### Encrypting EBS Volumes <!-- omit in toc -->
##### Encryption by default <!-- omit in toc -->
You can configure your AWS account to enforce the encryption of the new EBS volumes and snapshot copies that you create. For example, Amazon EBS encrypts the EBS volumes created when you launch an instance and the snapshots that you copy from an unencrypted snapshot. Encryption by default has no effect on existing EBS volumes or snapshots.  
Encryption by default is a Region-specific setting. If you enable it for a Region, you cannot disable it for individual volumes or snapshots in that Region.

**In the Console:**
1. From the navigation bar, select the Region.
1. From the navigation pane, select EC2 Dashboard.
1. In the upper-right corner of the page, choose Account Attributes, Settings.
1. Under EBS Storage, select Always encrypt new EBS volumes.
1. Choose Update.

Amazon EBS automatically creates a unique AWS-managed CMK in each Region where you store AWS resources. This key has the alias `alias/aws/ebs`. By default, Amazon EBS uses this key for encryption. You must specify a symmetric customer-managed CMK that you created as the default key for EBS encryption.  
**To change the default key used for EBS encryption in the console:**  
1. From the navigation bar, select the Region.
1. Choose Account Attributes, Settings.
1. Choose Change the default key and then choose an available key.
1. Choose Update.

**In the AWS CLI:**  
To enable EBS encryption by default:  
```
aws ec2 enable-ebs-encryption-by-default
```

To set your default key for EBS encryption:  
```
aws ec2 modify-ebs-default-kms-key-id --kms-key-id alias/my-cmk
```

For an additional preventative control, block `ec2:DisableEbsEncryptionByDefault` via a Service Control Policy. 

##### For encrypting EBS volumes at the time of instance creation: <!-- omit in toc -->
**In the Console:**  
On step 4 of instance creation (Choose Storage), the last column of the table is labeled Encryption. Select the key you wish to use from the dropdown menu, or enter the full ARN of the key if it is not in the list. Any keys you wish to use must be created prior to creating the instance. By default the AWS-managed "aws/ebs" key is available, but customer-managed keys may be used here. You can do this with any EBS volumes added in this step of the process.

**In the AWS CLI:**  
When using the `run-instances` command to launch a new instance, you can specify the `--block-device-mappings` option, which lets you specify if a volume will be encrypted or not. Passing a JSON file to this option, you can specify the following parameters:  
```json
[
  {
    "Ebs": {
      "KmsKeyId": "string",
      "Encrypted": true,
      ...
    },
    ...
  }
]
```

##### For encrypting EBS volumes after the volume has been created <!-- omit in toc -->
Although there is no direct way to encrypt an existing unencrypted volume or snapshot, you can encrypt them by creating either a volume or a snapshot. If you enabled encryption by default, Amazon EBS encrypts the resulting new volume or snapshot using your default key for EBS encryption. Even if you have not enabled encryption by default, you can enable encryption when you create an individual volume or snapshot. Whether you enable encryption by default or in individual creation operations, you can override the default key for EBS encryption and select a symmetric customer managed CMK.

##### Encrypting EBS Snapshots and AMIs <!-- omit in toc -->
If Encryption-by-default is enabled on the region, then all snapshots taken for encrypted EBS volumes will also be encrypted. If a volume is not encrypted, then the snapshot taken will not be encrypted either. However, copies made of that snapshot will be encrypted.

For information on how to encrypt unencrypted snapshots in various scenarios, see [Endnote 2](#endnote-2).

#### Encrypting NVMe Instance Store Volumes <!-- omit in toc -->
The data on NVMe instance store volumes is encrypted using an XTS-AES-256 cipher implemented on a hardware module on the instance. The encryption keys are generated using the hardware module and are unique to each NVMe instance storage device. All encryption keys are destroyed when the instance is stopped or terminated and cannot be recovered. **You cannot disable this encryption and you cannot provide your own encryption key.**

#### Encrypting EFS Volumes <!-- omit in toc -->
Encryption of EFS volumes is done at the time of volume creation.  

**In the Console:**  
1. Choose **Create file system** to open the file system creation wizard.
1. For **Step 1: Configure network access**, choose your VPC, create your mount targets, and then choose **Next Step**.
1. For **Step 2: Configure file system settings**, add any tags, enable Lifecycle management, choose your throughput and performance modes, and Enable encryption to encrypt your file system. Select a customer-managed CMK, and then choose **Next Step**.
1. For **Step 3. Configure client access**, you can choose a pre-configured **File system policy**, or use the JSON editor in the **{} JSON** tab to create a more advanced policy. Choose **Next Step**.
1. For **Step 4: Review and create**, review your settings, and choose **Create File System**.

**Important Note**  
The provided Customer-Managed CMK is used for encrypting file data stored on the file system. A AWS-Managed CMK is used for encrypting file metadata, including filenames, directory names, and directory contents. **This key cannot be changed to a Customer-Managed CMK.**

**In the CLI:**  
When using the `create-file-system` CLI command, include the options `--Encrypted true` and `--KmsKeyId "String"`

##### Encryption-in-transit of EFS volumes <!-- omit in toc -->
Enabling encryption of data in transit for your Amazon EFS file system is done by enabling Transport Layer Security (TLS) when you mount your file system using the Amazon EFS mount helper. When encryption of data in transit is declared as a mount option for your Amazon EFS file system, the mount helper initializes a client stunnel process. Stunnel is an open source multipurpose network relay. The client stunnel process listens on a local port for inbound traffic, and the mount helper redirects Network File System (NFS) client traffic to this local port. The mount helper uses TLS version 1.2 to communicate with your file system.  
To mount your Amazon EFS file system with the mount helper with encryption of data in transit enabled, access the terminal of your instance and run the following command, replacing the file system name and mount point with valid entries. This can also be run as part of User Data or bootstrap.  
```
sudo mount -t efs  -o tls fs-12345678:/ /mnt/efs
```

##### Setting up Load Balancers with CG Certificates <!-- omit in toc -->
**To change the default certificate using the console**
1. Open the Amazon EC2 console at https://console.aws.amazon.com/ec2/.
1. On the navigation pane, under **LOAD BALANCING**, choose **Load Balancers**.
1. Select the load balancer and choose **Listeners**.
1. Select the check box for the listener and choose **Edit**.
1. For **Default SSL certificate**, do one of the following:
   - If you created or imported a certificate using AWS Certificate Manager, choose **From ACM** and choose the certificate.
   - If you uploaded a certificate using IAM, choose **From IAM** and choose the certificate.
1. Choose **Update**.

**To change the default certificate using the AWS CLI**
```
aws elbv2 modify-listener --listener-arn arn:aws:elasticloadbalancing:us-west-2:123456789012:listener/app/my-load-balancer/50dc6c495c0c9188/0467ef3c8400ae65 --certificates CertificateArn=arn:aws:iam::123456789012:server-certificate/my-new-server-cert
```

### 3. Network access to EC2 instances and API is restricted
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.PT-4|Communications and control networks are protected|
|PR.PT-5|Mechanisms (e.g., failsafe, load balancing, hot swap) are implemented to achieve resilience requirements in normal and adverse situations|
|PR.AC-3|Remote access is managed|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|6|Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.|
|7|Use of AWS IAM accounts are restricted to CG networks.|

**Why?** EC2 often lives at the center of an organization's cloud infrastructure. Whether it is running web applications, high-performance computing, or a custom logging system, EC2 is a critical part of the business, and should be protected from outside access wherever possible. Putting network controls in place helps keep unwanted personnel out of instances or the EC2 API.

**How?** There are a few perspectives to take when looking at securing EC2 from a network perspective. There is access to the EC2 instances themselves, and how the network requests get to them, and there is the EC2 API (including the Console and AWS CLI).

It's not uncommon to isolate AWS accounts by application. Within that, however, you can further separate workloads using Virtual Private Cloud (VPC). A VPC is a virtual network in your own logically isolated area in the AWS Cloud. A subnet is a range of IP addresses in a VPC. When you launch an instance, you launch it into a subnet in your VPC. Use subnets to isolate the tiers of your application (for example, web, application, and database) within a single VPC. Use private subnets for your instances if they should not be accessed directly from the internet.

A *security group* acts as a virtual firewall for your instance to control incoming and outgoing traffic. Inbound rules control the incoming traffic to your instance, and outbound rules control the outgoing traffic from your instance. By default, all network ports are blocked in all directions. It is up to you, or the network administrator, to specify which ports to open, and in which directions. If you are unsure the port for a given protocol, there are also several common protocols available to select from when creating new rules.  
#### To create a new Security Group <!-- omit in toc -->
**In the New EC2 Console:**  
1. In the navigation pane of the console, choose **Security Groups**.
2. Choose **Create security group**.
3. In the **Basic details** section, do the following.
     1. Enter a descriptive name and brief description for the security group. The name and description can be up to 255 characters long, and they can include `a-z, A-Z, 0-9, spaces, and ._-:/()#,@[]+=&;{}!$*`.
     2. For **VPC**, choose the VPC in which to create the security group. The security group can only be used in the VPC in which it is created.
4. You can add security group rules now, or you can add them at any time after you have created the security group.
     1. For **Type**, choose the type of protocol to allow.
          - If you choose a custom TCP or UDP protocol, you must manually enter the port range to allow.
          - If you choose a custom ICMP protocol, you must choose the ICMP type name from **Protocol**, and, if applicable, the code name from **Port range**.
          - If you choose any other type, the protocol and port range are configured automatically.
     2. For **Source**, do one of the following.
          - Choose **Custom** and then enter an IP address in CIDR notation, a CIDR block, or another security group from which to allow inbound traffic.
          - Choose **Anywhere** to allow all inbound traffic of the specified protocol to reach your instance. This option automatically adds the 0.0.0.0/0 IPv4 CIDR block as an allowed source. **This is acceptable for a short time in a test environment, but is unacceptable for production environments.** In production, authorize only a specific IP address or range of addresses to access your instance.
          - If your security group is in a VPC that's enabled for IPv6, this option automatically adds a second rule for IPv6 traffic (::/0).
          - Choose **My IP** to allow inbound traffic from only your local computer's public IPv4 address.
     3. For Description, optionally specify a brief description for the rule.
5. Choose **Create**.

**In the CLI:**  
Creating a Security Group in the CLI is a 2-3 part process. First is the creation of the Security Group itself, then commands are run to add rules for ingress or egress.

This command creates the Security and adds it to a specified VPC:  
```
aws ec2 create-security-group --group-name MySecurityGroup --description "My security group" --vpc-id vpc-1a2b3c4d
```

This command adds a rule to a Security Group allowing inbound SSH access:
```
aws ec2 authorize-security-group-ingress \
    --group-id sg-1234567890abcdef0 \
    --protocol tcp \
    --port 22 \
    --cidr 203.0.113.0/24
```
*Note: When adding rules to a Security Group that is not in the Default VPC, you must specify the Security Group by its `group-id`. For Security Group in the default VPC, the `group-name` can be used.*

It is possible to set the source or destination for a rule as another Security Group. This lets members of that Security Group access or be reached by the current one. This command shows how to allow a Security Group to reach another Security Group on port 80:  
```
aws ec2 authorize-security-group-egress --group-id sg-1a2b3c4d --ip-permissions IpProtocol=tcp,FromPort=80,ToPort=80,UserIdGroupPairs='[{GroupId=sg-4b51a32f}]'
```

#### Interface VPC Endpoints <!-- omit in toc -->
You can improve the security posture of your VPC by configuring Amazon EC2 to use an interface VPC endpoint. Interface endpoints are powered by AWS PrivateLink, a technology that enables you to privately access Amazon EC2 APIs by restricting all network traffic between your VPC and Amazon EC2 to the Amazon network. With interface endpoints, you also don't need an internet gateway, a NAT device, or a virtual private gateway.

To create an interface VPC endpoint for EC2, run the following command in the AWS CLI:
```
aws ec2 create-vpc-endpoint --vpc-id vpc-example123 --vpc-endpoint-type Interface --service-name com.amazonaws.region.ec2 --subnet-id subnet-abababab --security-group-id sg-1a2b3c4d
```

### 4. Close unnecessary administrative access ports to instances
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-3|Remote access is managed|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|
|PR.PT-3|The principle of least functionality is incorporated by configuring systems to provide only essential capabilities|
|PR.PT-4|Communications and control networks are protected|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|5|AWS IAM User accounts are only to be created for use by services or products that do not support IAM Roles. Services are not allowed to create local accounts for human use within the service. All human user authentication will take place within CG’s Identity Provider.|
|10|Administrative access to AWS resources will have MFA enabled|

**Why?** Leaving inbound SSH ports and remote PowerShell ports open on your instances greatly increases the risk of entities running unauthorized or malicious commands on the instances. Even with access to the Internet removed, there is still risk involved on the internal network, so having these ports closed off greatly reduces the organization's footprint and blast radius.

**How?** Only the necessary ports for an instance to fulfill its business purpose should be left open. This means closing administrative access ports. For SSH, this is port 22, and for PowerShell, this is port 5986. There may be other ports associated with other management types used in your organization, which is why it is important to inspect Security Groups for unnecessary rules.

Use AWS Systems Manager Session Manager for shell access to EC2. Session Manager helps you improve your security posture by letting you close these inbound ports, freeing you from managing SSH keys and certificates, bastion hosts, and jump boxes. Session Manager is a fully managed AWS Systems Manager capability that lets you manage your Amazon EC2 instances through an interactive one-click browser-based shell or through the AWS CLI. Session Manager provides secure and auditable instance management without the need to open inbound ports, maintain bastion hosts, or manage SSH keys. Session Manager also makes it easy to comply with policies that require controlled access to instances, strict security practices, and fully auditable logs with instance access details, while still providing end users with simple one-click cross-platform access to your Amazon EC2 instances.

**Setting up the SSM Agent**
In order to communicate with an instance, it needs to have the SSM Agent installed. This is pre-installed on Amazon Linux 2 and Windows Server AMIs, but is not currently pre-installed on RHEL AMIs.  

1. To install the agent
```
sudo dnf install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm
```
2. Get the current status of the SSM Agent service
```
sudo systemctl status amazon-ssm-agent
```
3. If the service is not started, start the service:
```
sudo systemctl enable amazon-ssm-agent
```
```
sudo systemctl start amazon-ssm-agent
```
4. Check the status of the service
```
sudo systemctl status amazon-ssm-agent
```

**There are two ways to access instances through Session Manager within the Console:**  
*Option 1:*  
1. Open the Amazon EC2 console at [https://console.aws.amazon.com/ec2/](https://console.aws.amazon.com/ec2/).
2. In the navigation pane, choose **Instances**.
3. Select the instance and choose **Connect**.
4. For **Connection method**, choose **Session Manager**.
5. Choose **Connect**.

*Option 2:*  
1. Open the AWS Systems Manager console at [https://console.aws.amazon.com/systems-manager/](https://console.aws.amazon.com/systems-manager/).
1. In the navigation pane, choose **Session Manager**.  
-or-  
If the AWS Systems Manager home page opens first, choose the menu icon to open the navigation pane, and then choose **Session Manager** in the navigation pane.
1. Choose **Start session**.
1. For **Target instances**, choose the option button to the left of the instance you want to connect to.  
If an instance you want to connect to is not in the list, or is listed but an error message reports, "The instance you selected is not configured to use Session Manager," see [Instance not available or not configured for Session Manager](https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-troubleshooting.html#session-manager-troubleshooting-instances) for troubleshooting steps.
1. Choose **Start session**.

**In the CLI:**  
```
aws ssm start-session --target instance-id
```
*instance-id* represents of the ID of an instance configured for use with AWS Systems Manager and its Session Manager capability, such as `i-02573cafcfEXAMPLE`. 

### 5. Patch Management and Vulnerability Management
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.IP-12|A vulnerability management plan is developed and implemented|
|DE.CM-8|Vulnerability scans are performed|

**Why** Vulnerabilities are weaknesses in software that can expose a system to unwanted malicious activity. By applying regular patches and performing regular vulnerability scans, you help to ensure the safety and integrity of a system.

**How** Refer to Internal Documentation on the setup of Capital Group's vulnerability management software. If you are deploying an EC2 instance from an image that does not already have this software installed and configured, you will need to include it in the initial deployment.

For patch management, the best way to manage a fleet of instances is using AWS Systems Manager. Systems Manager offers options for performing patch management on individual, or multiple, instances. In order for AWS Systems Manager to communicate with your instance, you will need to install the SSM Agent on the instance. Refer to [Endnote 3](#endnote-3) for details on setting up patch management on specific types of instances. Refer to the previous section for instructions on installing the SSM Agent.

## Detective
### 1. Monitor EC2 instance activity
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are aggregated and correlated from multiple sources and sensors|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|4|AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch|

**Why?** 
Understanding what activities are impacting your instances and what events could impact thier performace is key to detecting potentially malicious activity or the implmentation of poor security practices 

**How?**  
#### Monitor your instances using CloudWatch detailed monitoring <!-- omit in toc -->
You can monitor your instances using Amazon CloudWatch, which collects and processes raw data from Amazon EC2 into readable, near real\-time metrics\. These statistics are recorded for a period of 15 months, so that you can access historical information and gain a better perspective on how your web application or service is performing\.

By default, Amazon EC2 sends metric data to CloudWatch in 5\-minute periods\. To send metric data for your instance to CloudWatch in 1\-minute periods, you can enable detailed monitoring on the instance\.

The Amazon EC2 console displays a series of graphs based on the raw data from Amazon CloudWatch\. Depending on your needs, you might prefer to get data for your instances from Amazon CloudWatch instead of the graphs in the console\.

#### Enable or disable detailed monitoring for your instances <!-- omit in toc -->

By default, your instance is enabled for basic monitoring\. You can optionally enable detailed monitoring\. After you enable detailed monitoring, the Amazon EC2 console displays monitoring graphs with a 1\-minute period for the instance\.

The following describes the data interval and charge for basic and detailed monitoring for instances\.

Basic monitoring  
Data is available automatically in 5\-minute periods at no charge\.

Detailed monitoring  
Data is available in 1\-minute periods for an additional charge\.  
To get this level of data, you must specifically enable it for the instance\. For the instances where you've enabled detailed monitoring, you can also get aggregated data across groups of similar instances\.


##### Enabling detailed monitoring <!-- omit in toc -->

You can enable detailed monitoring on an instance as you launch it or after the instance is running or stopped\. Enabling detailed monitoring on an instance does not affect the monitoring of the EBS volumes attached to the instance\.

**To enable detailed monitoring for an existing instance \(console\)**

1. Open the Amazon EC2 console at [https://console\.aws\.amazon\.com/ec2/](https://console.aws.amazon.com/ec2/)\.

1. In the navigation pane, choose **Instances**\.

1. Select the instance and choose **Actions**, **CloudWatch Monitoring**, **Enable Detailed Monitoring**\.

1. In the **Enable Detailed Monitoring** dialog box, choose **Yes, Enable**\.

1. Choose **Close**\.

**To enable detailed monitoring when launching an instance \(console\)**  
When launching an instance using the AWS Management Console, select the **Monitoring** check box on the **Configure Instance Details** page\.

**To enable detailed monitoring for an existing instance \(AWS CLI\)**  
Use the following [monitor\-instances](https://docs.aws.amazon.com/cli/latest/reference/ec2/monitor-instances.html) command to enable detailed monitoring for the specified instances\.

```
aws ec2 monitor-instances --instance-ids i-1234567890abcdef0
```

**To enable detailed monitoring when launching an instance \(AWS CLI\)**  
Use the [run\-instances](https://docs.aws.amazon.com/cli/latest/reference/ec2/run-instances.html) command with the `--monitoring` flag to enable detailed monitoring\.

```
aws ec2 run-instances --image-id ami-09092360 --monitoring Enabled=true...
```

##### Disabling detailed monitoring <!-- omit in toc -->

You can disable detailed monitoring on an instance as you launch it or after the instance is running or stopped\.

**To disable detailed monitoring \(console\)**

1. Open the Amazon EC2 console at [https://console\.aws\.amazon\.com/ec2/](https://console.aws.amazon.com/ec2/)\.

1. In the navigation pane, choose **Instances**\.

1. Select the instance and choose **Actions**, **CloudWatch Monitoring**, **Disable Detailed Monitoring**\.

1. In the **Disable Detailed Monitoring** dialog box, choose **Yes, Disable**\.

1. Choose **Close**\.

**To disable detailed monitoring \(AWS CLI\)**  
Use the following [unmonitor\-instances](https://docs.aws.amazon.com/cli/latest/reference/ec2/unmonitor-instances.html) command to disable detailed monitoring for the specified instances\.

```
aws ec2 unmonitor-instances --instance-ids i-1234567890abcdef0
```

### 2. Log Amazon EC2 and Amazon EBS API calls
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are aggregated and correlated from multiple sources and sensors|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|4|AWS services should have logging enabled and those logs delivered to CloudTrail or CloudWatch|

**Why?** 
 Using the information collected by CloudTrail, you can determine the request that was made to Amazon EC2 and Amazon EBS, the IP address from which the request was made, who made the request, when it was made, and additional details\. 
**How?** 
#### Logging Amazon EC2 and Amazon EBS API calls with AWS CloudTrail <!-- omit in toc -->

Amazon EC2 and Amazon EBS are integrated with AWS CloudTrail, a service that provides a record of actions taken by a user, role, or an AWS service in Amazon EC2 and Amazon EBS\. CloudTrail captures all API calls for Amazon EC2 and Amazon EBS as events, including calls from the console and from code calls to the APIs\. If you create a trail, you can enable continuous delivery of CloudTrail events to an Amazon S3 bucket, including events for Amazon EC2 and Amazon EBS\. If you don't configure a trail, you can still view the most recent events in the CloudTrail console in **Event history**\.


##### Amazon EC2 and Amazon EBS information in CloudTrail <!-- omit in toc -->

CloudTrail is enabled on your AWS account when you create the account\. When activity occurs in Amazon EC2 and Amazon EBS, that activity is recorded in a CloudTrail event along with other AWS service events in **Event history**\. You can view, search, and download recent events in your AWS account\. For more information, see [Viewing Events with CloudTrail Event History](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/view-cloudtrail-events.html)\. 

For an ongoing record of events in your AWS account, including events for Amazon EC2 and Amazon EBS, create a trail\. A trail enables CloudTrail to deliver log files to an Amazon S3 bucket\. By default, when you create a trail in the console, the trail applies to all Regions\. The trail logs events from all Regions in the AWS partition and delivers the log files to the Amazon S3 bucket that you specify\. Additionally, you can configure other AWS services to further analyze and act upon the event data collected in CloudTrail logs\. For more information, see: 
+ [Overview for Creating a Trail](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-create-and-update-a-trail.html)
+ [CloudTrail Supported Services and Integrations](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-aws-service-specific-topics.html#cloudtrail-aws-service-specific-topics-integrations)
+ [Configuring Amazon SNS Notifications for CloudTrail](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/getting_notifications_top_level.html)
+ [Receiving CloudTrail Log Files from Multiple Regions](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/receive-cloudtrail-log-files-from-multiple-regions.html) and [Receiving CloudTrail Log Files from Multiple Accounts](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-receive-logs-from-multiple-accounts.html)

All Amazon EC2 and Amazon EBS actions are logged by CloudTrail and are documented in the [Amazon EC2 API Reference](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/)\. For example, calls to the [RunInstances](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/ApiReference-query-RunInstances.html), [DescribeInstances](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/ApiReference-query-DescribeInstances.html), or [CreateImage](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/ApiReference-query-CreateImage.html) actions generate entries in the CloudTrail log files\. 

Every event or log entry contains information about who generated the request\. The identity information helps you determine the following: 
+ Whether the request was made with root or IAM user credentials\.
+ Whether the request was made with temporary security credentials for a role or federated user\.
+ Whether the request was made by another AWS service\.

For more information, see the [CloudTrail userIdentity Element](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-user-identity.html)\.

#### Understanding Amazon EC2 and Amazon EBS log file entries <!-- omit in toc -->

A trail is a configuration that enables delivery of events as log files to an Amazon S3 bucket that you specify\. CloudTrail log files contain one or more log entries\. An event represents a single request from any source and includes information about the requested action, the date and time of the action, request parameters, and so on\. CloudTrail log files are not an ordered stack trace of the public API calls, so they do not appear in any specific order\. 

The following log file record shows that a user terminated an instance\.

```
{
   "Records":[
      {
         "eventVersion":"1.03",
         "userIdentity":{
            "type":"Root",
            "principalId":"123456789012",
            "arn":"arn:aws:iam::123456789012:root",
            "accountId":"123456789012",
            "accessKeyId":"AKIAIOSFODNN7EXAMPLE",
            "userName":"user"
         },
         "eventTime":"2016-05-20T08:27:45Z",
         "eventSource":"ec2.amazonaws.com",
         "eventName":"TerminateInstances",
         "awsRegion":"us-west-2",
         "sourceIPAddress":"198.51.100.1",
         "userAgent":"aws-cli/1.10.10 Python/2.7.9 Windows/7botocore/1.4.1",
         "requestParameters":{
            "instancesSet":{
               "items":[{
                  "instanceId":"i-1a2b3c4d"
               }]
            }
         },
         "responseElements":{
            "instancesSet":{
               "items":[{
                  "instanceId":"i-1a2b3c4d",
                  "currentState":{
                     "code":32,
                     "name":"shutting-down"
                  },
                  "previousState":{
                     "code":16,
                     "name":"running"
                  }
               }]
            }
         },
         "requestID":"be112233-1ba5-4ae0-8e2b-1c302EXAMPLE",
         "eventID":"6e12345-2a4e-417c-aa78-7594fEXAMPLE",
         "eventType":"AwsApiCall",
         "recipientAccountId":"123456789012"
     }
   ]
}
```

#### Using AWS CloudTrail to audit users that connect via EC2 Instance Connect <!-- omit in toc -->

Use AWS CloudTrail to audit the users that connect to your instances via EC2 Instance Connect\.

**To audit SSH activity via EC2 Instance Connect using the AWS CloudTrail console**

1. Open the AWS CloudTrail console at [https://console.aws.amazon.com/cloudtrail/](https://console.aws.amazon.com/cloudtrail/)\.

1. Verify that you are in the correct Region\.

1. In the navigation pane, choose **Event history**\.

1. For **Filter**, choose **Event source**, **ec2\-instance\-connect\.amazonaws\.com**\.

1. \(Optional\) For **Time range**, select a time range\.

1. Choose the **Refresh events** icon\.

1. The page displays the events that correspond to the `[SendSSHPublicKey](https://docs.aws.amazon.com/ec2-instance-connect/latest/APIReference/API_SendSSHPublicKey.html)` API calls\. Expand an event using the arrow to view additional details, such as the user name and AWS access key that was used to make the SSH connection, and the source IP address\.

1. To display the full event information in JSON format, choose **View event**\. The **requestParameters** field contains the destination instance ID, OS user name, and public key that were used to make the SSH connection\.

   ```
   {
       "eventVersion": "1.05",
       "userIdentity": {
           "type": "IAMUser",
           "principalId": "ABCDEFGONGNOMOOCB6XYTQEXAMPLE",
           "arn": "arn:aws:iam::1234567890120:user/IAM-friendly-name",
           "accountId": "123456789012",
           "accessKeyId": "ABCDEFGUKZHNAW4OSN2AEXAMPLE",
           "userName": "IAM-friendly-name",
           "sessionContext": {
               "attributes": {
                   "mfaAuthenticated": "false",
                   "creationDate": "2018-09-21T21:37:58Z"}
           }
       },
       "eventTime": "2018-09-21T21:38:00Z",
       "eventSource": "ec2-instance-connect.amazonaws.com",
       "eventName": "SendSSHPublicKey ",
       "awsRegion": "us-west-2",
       "sourceIPAddress": "123.456.789.012",
       "userAgent": "aws-cli/1.15.61 Python/2.7.10 Darwin/16.7.0 botocore/1.10.60",
       "requestParameters": {
           "instanceId": "i-0123456789EXAMPLE",
           "osUser": "ec2-user",
           "SSHKey": {
               "publicKey": "ssh-rsa ABCDEFGHIJKLMNO01234567890EXAMPLE"
           }
       "responseElements": null,
       "requestID": "1a2s3d4f-bde6-11e8-a892-f7ec64543add",
       "eventID": "1a2w3d4r5-a88f-4e28-b3bf-30161f75be34",
       "eventType": "AwsApiCall",
       "recipientAccountId": "0987654321"
   }
   ```
### 3. Monitor EC2 Instance metrics for anomalous behavior 
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are aggregated and correlated from multiple sources and sensors|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are aggregated and correlated from multiple sources and sensors|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|4|AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch|

**Why?** 
Understanding instance behavior and having the ability to be notified of anomalies to that behavior is key to securin your instance deployments

**How?** 
#### Utilize available CloudWatch metrics to understand instance behavioural anomolies <!-- omit in toc -->

Amazon EC2 sends metrics to Amazon CloudWatch\. You can use the AWS Management Console, the AWS CLI, or an API to list the metrics that Amazon EC2 sends to CloudWatch\. By default, each data point covers the 5 minutes that follow the start time of activity for the instance\. If you've enabled detailed monitoring, each data point covers the next minute of activity from the start time\.


**Topics**
+ [Instance metrics](#ec2-cloudwatch-metrics)
+ [CPU credit metrics](#cpu-credit-metrics)
+ [Amazon EBS metrics for Nitro\-based instances](#ebs-metrics-nitro)
+ [Status check metrics](#status-check-metrics)
+ [Traffic mirroring metrics](#traffic-mirroring-metrics)
+ [Amazon EC2 metric dimensions](#ec2-cloudwatch-dimensions)
+ [Amazon EC2 usage metrics](#service-quota-metrics)
+ [Listing metrics using the console](#list-ec2-metrics-console)
+ [Listing metrics using the AWS CLI](#list-ec2-metrics-cli)

##### Instance metrics <!-- omit in toc -->

The `AWS/EC2` namespace includes the following instance metrics\.


| Metric | Description | 
| --- | --- | 
| CPUUtilization |  The percentage of allocated EC2 compute units that are currently in use on the instance\. This metric identifies the processing power required to run an application on a selected instance\. Depending on the instance type, tools in your operating system can show a lower percentage than CloudWatch when the instance is not allocated a full processor core\. Units: Percent  | 
| DiskReadOps |  Completed read operations from all instance store volumes available to the instance in a specified period of time\. To calculate the average I/O operations per second \(IOPS\) for the period, divide the total operations in the period by the number of seconds in that period\. If there are no instance store volumes, either the value is 0 or the metric is not reported\. Units: Count  | 
| DiskWriteOps |  Completed write operations to all instance store volumes available to the instance in a specified period of time\. To calculate the average I/O operations per second \(IOPS\) for the period, divide the total operations in the period by the number of seconds in that period\. If there are no instance store volumes, either the value is 0 or the metric is not reported\. Units: Count  | 
| DiskReadBytes |  Bytes read from all instance store volumes available to the instance\. This metric is used to determine the volume of the data the application reads from the hard disk of the instance\. This can be used to determine the speed of the application\. The number reported is the number of bytes received during the period\. If you are using basic \(five\-minute\) monitoring, you can divide this number by 300 to find Bytes/second\. If you have detailed \(one\-minute\) monitoring, divide it by 60\. If there are no instance store volumes, either the value is 0 or the metric is not reported\. Units: Bytes  | 
| DiskWriteBytes |  Bytes written to all instance store volumes available to the instance\. This metric is used to determine the volume of the data the application writes onto the hard disk of the instance\. This can be used to determine the speed of the application\. The number reported is the number of bytes received during the period\. If you are using basic \(five\-minute\) monitoring, you can divide this number by 300 to find Bytes/second\. If you have detailed \(one\-minute\) monitoring, divide it by 60\. If there are no instance store volumes, either the value is 0 or the metric is not reported\.  Units: Bytes  | 
| NetworkIn |  The number of bytes received on all network interfaces by the instance\. This metric identifies the volume of incoming network traffic to a single instance\. The number reported is the number of bytes received during the period\. If you are using basic \(five\-minute\) monitoring, you can divide this number by 300 to find Bytes/second\. If you have detailed \(one\-minute\) monitoring, divide it by 60\. Units: Bytes  | 
| NetworkOut |  The number of bytes sent out on all network interfaces by the instance\. This metric identifies the volume of outgoing network traffic from a single instance\. The number reported is the number of bytes sent during the period\. If you are using basic \(five\-minute\) monitoring, you can divide this number by 300 to find Bytes/second\. If you have detailed \(one\-minute\) monitoring, divide it by 60\. Units: Bytes  | 
| NetworkPacketsIn |  The number of packets received on all network interfaces by the instance\. This metric identifies the volume of incoming traffic in terms of the number of packets on a single instance\. This metric is available for basic monitoring only\. Units: Count Statistics: Minimum, Maximum, Average  | 
| NetworkPacketsOut |  The number of packets sent out on all network interfaces by the instance\. This metric identifies the volume of outgoing traffic in terms of the number of packets on a single instance\. This metric is available for basic monitoring only\. Units: Count Statistics: Minimum, Maximum, Average  | 
| MetadataNoToken |  The number of times the instance metadata service was succesfully accessed using a method that does not use a token\. This metric is used to determine if there are any processes accessing instance metadata that are using Instance Metadata Service Version 1, which does not use a token\. If all requests use token\-backed sessions, i\.e\., Instance Metadata Service Version 2, the value is 0\. For more information, see [Transitioning to using Instance Metadata Service Version 2](configuring-instance-metadata-service.md#instance-metadata-transition-to-version-2)\. Units: Count  | 

##### CPU credit metrics <!-- omit in toc -->

| Metric | Description | 
| --- | --- | 
| CPUCreditUsage |  The number of CPU credits spent by the instance for CPU utilization\. One CPU credit equals one vCPU running at 100% utilization for one minute or an equivalent combination of vCPUs, utilization, and time \(for example, one vCPU running at 50% utilization for two minutes or two vCPUs running at 25% utilization for two minutes\)\. CPU credit metrics are available at a five\-minute frequency only\. If you specify a period greater than five minutes, use the `Sum` statistic instead of the `Average` statistic\. Units: Credits \(vCPU\-minutes\)  | 
| CPUCreditBalance |  The number of earned CPU credits that an instance has accrued since it was launched or started\. For T2 Standard, the `CPUCreditBalance` also includes the number of launch credits that have been accrued\. Credits are accrued in the credit balance after they are earned, and removed from the credit balance when they are spent\. The credit balance has a maximum limit, determined by the instance size\. After the limit is reached, any new credits that are earned are discarded\. For T2 Standard, launch credits do not count towards the limit\. The credits in the `CPUCreditBalance` are available for the instance to spend to burst beyond its baseline CPU utilization\. When an instance is running, credits in the `CPUCreditBalance` do not expire\. When a T3 or T3a instance stops, the `CPUCreditBalance` value persists for seven days\. Thereafter, all accrued credits are lost\. When a T2 instance stops, the `CPUCreditBalance` value does not persist, and all accrued credits are lost\. CPU credit metrics are available at a five\-minute frequency only\. Units: Credits \(vCPU\-minutes\)  | 
| CPUSurplusCreditBalance  |  The number of surplus credits that have been spent by an `unlimited` instance when its `CPUCreditBalance` value is zero\. The `CPUSurplusCreditBalance` value is paid down by earned CPU credits\. If the number of surplus credits exceeds the maximum number of credits that the instance can earn in a 24\-hour period, the spent surplus credits above the maximum incur an additional charge\. CPU credit metrics are available at a five\-minute frequency only\. Units: Credits \(vCPU\-minutes\)   | 
| CPUSurplusCreditsCharged |  The number of spent surplus credits that are not paid down by earned CPU credits, and which thus incur an additional charge\. Spent surplus credits are charged when any of the following occurs:  [\[See the AWS documentation website for more details\]](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/viewing_metrics_with_cloudwatch.html) CPU credit metrics are available at a five\-minute frequency only\. Units: Credits \(vCPU\-minutes\)  | 

##### Amazon EBS metrics for Nitro\-based instances <!-- omit in toc -->

The `AWS/EC2` namespace includes the following Amazon EBS metrics for the Nitro\-based instances that are not bare metal instances\. For the list of Nitro\-based instance types, see [Instances built on the Nitro System](instance-types.md#ec2-nitro-instances)\.

Metric values for Nitro\-based instances will always be integers \(whole numbers\), whereas values for Xen\-based instances support decimals\. Therefore, low instance CPU utilization on Nitro\-based instances may appear to be rounded down to 0\.


| Metric | Description | 
| --- | --- | 
|  EBSReadOps |  Completed read operations from all Amazon EBS volumes attached to the instance in a specified period of time\. To calculate the average read I/O operations per second \(Read IOPS\) for the period, divide the total operations in the period by the number of seconds in that period\. If you are using basic \(five\-minute\) monitoring, you can divide this number by 300 to calculate the Read IOPS\. If you have detailed \(one\-minute\) monitoring, divide it by 60\.  Unit: Count  | 
|  EBSWriteOps  |  Completed write operations to all EBS volumes attached to the instance in a specified period of time\. To calculate the average write I/O operations per second \(Write IOPS\) for the period, divide the total operations in the period by the number of seconds in that period\. If you are using basic \(five\-minute\) monitoring, you can divide this number by 300 to calculate the Write IOPS\. If you have detailed \(one\-minute\) monitoring, divide it by 60\. Unit: Count  | 
|  EBSReadBytes  |  Bytes read from all EBS volumes attached to the instance in a specified period of time\.  The number reported is the number of bytes read during the period\. If you are using basic \(five\-minute\) monitoring, you can divide this number by 300 to find Read Bytes/second\. If you have detailed \(one\-minute\) monitoring, divide it by 60\.  Unit: Bytes  | 
|  EBSWriteBytes  |  Bytes written to all EBS volumes attached to the instance in a specified period of time\. The number reported is the number of bytes written during the period\. If you are using basic \(five\-minute\) monitoring, you can divide this number by 300 to find Write Bytes/second\. If you have detailed \(one\-minute\) monitoring, divide it by 60\.  Unit: Bytes  | 
|  EBSIOBalance%  |  Available only for the smaller instance sizes\. Provides information about the percentage of I/O credits remaining in the burst bucket\. This metric is available for basic monitoring only\. The `Sum` statistic is not applicable to this metric\. Unit: Percent  | 
|  EBSByteBalance%  |  Available only for the smaller instance sizes\. Provides information about the percentage of throughput credits remaining in the burst bucket\. This metric is available for basic monitoring only\. The `Sum` statistic is not applicable to this metric\. Unit: Percent  | 

For information about the metrics provided for your EBS volumes, see [Amazon EBS metrics](using_cloudwatch_ebs.md#ebs-metrics)\. 

##### Status check metrics <!-- omit in toc -->

The `AWS/EC2` namespace includes the following status check metrics\. By default, status check metrics are available at a 1\-minute frequency at no charge\. For a newly\-launched instance, status check metric data is only available after the instance has completed the initialization state \(within a few minutes of the instance entering the running state\)\. For more information about EC2 status checks, see [Status Checks For Your Instances](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/monitoring-system-instance-status-check.html)\.


| Metric | Description | 
| --- | --- | 
| StatusCheckFailed |  Reports whether the instance has passed both the instance status check and the system status check in the last minute\. This metric can be either 0 \(passed\) or 1 \(failed\)\. By default, this metric is available at a 1\-minute frequency at no charge\. Units: Count  | 
| StatusCheckFailed\_Instance |  Reports whether the instance has passed the instance status check in the last minute\. This metric can be either 0 \(passed\) or 1 \(failed\)\. By default, this metric is available at a 1\-minute frequency at no charge\. Units: Count  | 
| StatusCheckFailed\_System |  Reports whether the instance has passed the system status check in the last minute\. This metric can be either 0 \(passed\) or 1 \(failed\)\. By default, this metric is available at a 1\-minute frequency at no charge\. Units: Count  | 

##### Traffic mirroring metrics <!-- omit in toc -->

The `AWS/EC2` namespace includes metrics for mirrored traffic\. For more information, see [Monitoring mirrored traffic using Amazon CloudWatch](https://docs.aws.amazon.com/vpc/latest/mirroring/traffic-mirror-cloudwatch.html) in the *Amazon VPC Traffic Mirroring Guide*\.

##### Amazon EC2 metric dimensions <!-- omit in toc -->

You can use the following dimensions to refine the metrics listed in the previous tables\.


|  Dimension  |  Description  | 
| --- | --- | 
|  AutoScalingGroupName  |  This dimension filters the data you request for all instances in a specified capacity group\. An *Auto Scaling group* is a collection of instances you define if you're using Auto Scaling\. This dimension is available only for Amazon EC2 metrics when the instances are in such an Auto Scaling group\. Available for instances with Detailed or Basic Monitoring enabled\.  | 
|  ImageId  |  This dimension filters the data you request for all instances running this Amazon EC2 Amazon Machine Image \(AMI\)\. Available for instances with Detailed Monitoring enabled\.  | 
|  InstanceId  |  This dimension filters the data you request for the identified instance only\. This helps you pinpoint an exact instance from which to monitor data\.  | 
|  InstanceType  |  This dimension filters the data you request for all instances running with this specified instance type\. This helps you categorize your data by the type of instance running\. For example, you might compare data from an m1\.small instance and an m1\.large instance to determine which has the better business value for your application\. Available for instances with Detailed Monitoring enabled\.  | 
##### Amazon EC2 usage metrics <!-- omit in toc -->

You can use CloudWatch usage metrics to provide visibility into your account's usage of resources\. Use these metrics to visualize your current service usage on CloudWatch graphs and dashboards\.

Amazon EC2 usage metrics correspond to AWS service quotas\. You can configure alarms that alert you when your usage approaches a service quota\. For more information about CloudWatch integration with service quotas, see [Service Quotas Integration and Usage Metrics](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Service-Quota-Integration.html)\.

Amazon EC2 publishes the following metrics in the `AWS/Usage` namespace\.


| Metric | Description | 
| --- | --- | 
| `ResourceCount` |  The number of the specified resources running in your account\. The resources are defined by the dimensions associated with the metric\. The most useful statistic for this metric is `MAXIMUM`, which represents the maximum number of resources used during the 1\-minute period\.  | 

The following dimensions are used to refine the usage metrics that are published by Amazon EC2\.


|  Dimension  |  Description  | 
| --- | --- | 
|  Service  |  The name of the AWS service containing the resource\. For Amazon EC2 usage metrics, the value for this dimension is `EC2`\.  | 
|  Type  |  The type of entity that is being reported\. Currently, the only valid value for Amazon EC2 usage metrics is `Resource`\.  | 
|  Resource  |  The type of resource that is running\. Currently, the only valid value for Amazon EC2 usage metrics is `vCPU`, which returns information on instances that are running\.  | 
|  Class  |  The class of resource being tracked\. For Amazon EC2 usage metrics with `vCPU` as the value of the `Resource` dimension, the valid values are `Standard/OnDemand`, `F/OnDemand`, `G/OnDemand`, `Inf/OnDemand`, `P/OnDemand`, and `X/OnDemand`\. The values for this dimension define the first letter of the instance types that are reported by the metric\. For example, `Standard/OnDemand` returns information about all running instances with types that start with A, C, D, H, I, M, R, T, and Z, and `G/OnDemand` returns information about all running instances with types that start with G\.  | 

#### Listing metrics using the console <!-- omit in toc -->

Metrics are grouped first by namespace, and then by the various dimension combinations within each namespace\. For example, you can view all metrics provided by Amazon EC2, or metrics grouped by instance ID, instance type, image \(AMI\) ID, or Auto Scaling group\.

**To view available metrics by category \(console\)**

1. Open the CloudWatch console at [https://console\.aws\.amazon\.com/cloudwatch/](https://console.aws.amazon.com/cloudwatch/)\.

1. In the navigation pane, choose **Metrics**\.

1. Choose the **EC2** metric namespace\.  

1. Select a metric dimension \(for example, **Per\-Instance Metrics**\)\.  


1. To sort the metrics, use the column heading\. To graph a metric, select the check box next to the metric\. To filter by resource, choose the resource ID and then choose **Add to search**\. To filter by metric, choose the metric name and then choose **Add to search**\.  


#### Listing metrics using the AWS CLI <!-- omit in toc -->

Use the [list\-metrics](https://docs.aws.amazon.com/cli/latest/reference/cloudwatch/list-metrics.html) command to list the CloudWatch metrics for your instances\.

**To list all the available metrics for Amazon EC2 \(AWS CLI\)**  
The following example specifies the `AWS/EC2` namespace to view all the metrics for Amazon EC2\.

```
aws cloudwatch list-metrics --namespace AWS/EC2
```

The following is example output:

```
{
  "Metrics": [
    {
        "Namespace": "AWS/EC2",
        "Dimensions": [
            {
                "Name": "InstanceId",
                "Value": "i-1234567890abcdef0"
            }
        ],
        "MetricName": "NetworkOut"
    },
    {
        "Namespace": "AWS/EC2",
        "Dimensions": [
            {
                "Name": "InstanceId",
                "Value": "i-1234567890abcdef0"
            }
        ],
        "MetricName": "CPUUtilization"
    },
    {
        "Namespace": "AWS/EC2",
        "Dimensions": [
            {
                "Name": "InstanceId",
                "Value": "i-1234567890abcdef0"
            }
        ],
        "MetricName": "NetworkIn"
    },
    ...
  ]
}
```

**To list all the available metrics for an instance \(AWS CLI\)**  
The following example specifies the `AWS/EC2` namespace and the `InstanceId` dimension to view the results for the specified instance only\.

```
aws cloudwatch list-metrics --namespace AWS/EC2 --dimensions Name=InstanceId,Value=i-1234567890abcdef0
```

**To list a metric across all instances \(AWS CLI\)**  
The following example specifies the `AWS/EC2` namespace and a metric name to view the results for the specified metric only\.

```
aws cloudwatch list-metrics --namespace AWS/EC2 --metric-name CPUUtilization
```
#### Create a CloudWatch alarm for an instance <!-- omit in toc -->

You can create a CloudWatch alarm that monitors CloudWatch metrics for one of your instances\. CloudWatch will automatically send you a notification when the metric reaches a threshold you specify\. You can create a CloudWatch alarm using the Amazon EC2 console, or using the more advanced options provided by the CloudWatch console\.

**To create an alarm using the CloudWatch console**  
For examples, see [Creating Amazon CloudWatch Alarms](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html) in the *Amazon CloudWatch User Guide*\.

**To create an alarm using the Amazon EC2 console**

1. Open the Amazon EC2 console at [https://console\.aws\.amazon\.com/ec2/](https://console.aws.amazon.com/ec2/)\.

1. In the navigation pane, choose **Instances**\.

1. Select the instance\.

1. On the **Monitoring** tab located at the bottom of the page, choose **Create Alarm**\. Or, from the **Actions** dropdown, choose **CloudWatch Monitoring**, **Add/Edit Alarm**\.

1. In the **Create Alarm** dialog box, do the following:

   1. Choose **create topic**\. For **Send a notification to**, enter a name for the SNS topic\. For **With these recipients**, enter one or more email addresses to receive notification\.

   1. Specify the metric and the criteria for the policy\. For example, you can leave the default settings for **Whenever** \(Average of CPU Utilization\)\. For **Is**, choose `>=` and enter `80` percent\. For **For at least**, enter `1` consecutive period of `5 Minutes`\.

   1. Choose **Create Alarm**\.   

### 4. EC2 instance should have SSM Managed

**Why?** This controls checks whether EC2 instance is SSM Managed. Setting up EC2 instance as SSM Managed allows EC2 instance accessible for AWS System Manager service. This ensure that System Manager will scan and install latest patches, bug fix and OS updates on EC2 instance.

**How?** Following are pre-requisite for SSM Managed instance

a)	EC2 instance should have SSM agent installed and in running state. Below is the link to install SSM agent on EC2 instance:

   Linux OS: https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html
   MAC OS: https://docs.aws.amazon.com/systems-manager/latest/userguide/install-ssm-agent-macos.html
   Windows OS: https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-win.html
 
   Below is the link to check SSM agent service status:

   https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent-status-and-restart.html

b)	EC2 instance should have attached IAM role with below SSM policy / permission
   -	AmazonSSMManagedInstanceCore
   -	AmazonSSMPatchAssociation
   -	EC2SSMRoleForInstanceAutomationQuickSetupInlinePolicy
   -	EC2SSMPolicyForInstanceAutomationQuickSetup

c)	EC2 instance should be reachable to SSM service.
   EC2 instance should have outbound internet connectivity or below VPC Endpoints.
   -	ssm.region.amazonaws.com
   -	ssmmessages.region.amazonaws.com
   -	ec2messages.region.amazonaws.com

### 5. EC2 instance should have Qualys agent installed

**Why?** This control checks whether Qualys agent is installed on EC2 instance. Qualys detect instances vulnerability and helps to keep instance secure with latest patches.

**How?** Below are the steps to install Qualys agent on EC2 instance
         
         https://confluence.capgroup.com/pages/viewpage.action?pageId=301864477


## Respond/Recover
### 1. Utilize Amazon cloudWatch alarm actions
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN|Notifications from detection systems are investigated|
|RS.MI-1| Incidents are contained|
|RS.AN-3|Forensics are performed|
|RS.MI-2|Incidents are mitigated|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|#|No applicable controls|

**Why?**
There are a number of scenarios in which you might want to automatically stop or terminate your instance\. One method for reducing your attack surface is by ensuring unused instances are stopped or termnited when certain status metrics are met. For example, you might have instances dedicated to batch payroll processing jobs or scientific computing tasks that run for a period of time and then complete their work\. Rather than letting those instances sit idle \(and accrue charges\), you can stop or terminate them, which can help you to save money\. The main difference between using the stop and the terminate alarm actions is that you can easily restart a stopped instance if you need to run it again later, and you can keep the same instance ID and root volume\. However, you cannot restart a terminated instance\. Instead, you must launch a new instance\.

**How?** 
#### Create alarms that stop, terminate, reboot, or recover an instance <!-- omit in toc -->

Using Amazon CloudWatch alarm actions, you can create alarms that automatically stop, terminate, reboot, or recover your instances\. You can use the stop or terminate actions to help you save money when you no longer need an instance to be running\. You can use the reboot and recover actions to automatically reboot those instances or recover them onto new hardware if a system impairment occurs\.

The `AWSServiceRoleForCloudWatchEvents` service\-linked role enables AWS to perform alarm actions on your behalf\. The first time you create an alarm in the AWS Management Console, the IAM CLI, or the IAM API, CloudWatch creates the service\-linked role for you\.


You can add the stop, terminate, reboot, or recover actions to any alarm that is set on an Amazon EC2 per\-instance metric, including basic and detailed monitoring metrics provided by Amazon CloudWatch \(in the `AWS/EC2` namespace\), as well as any custom metrics that include the `InstanceId` dimension, as long as its value refers to a valid running Amazon EC2 instance\.

**Console Support**  
You can create alarms using the Amazon EC2 console or the CloudWatch console\. The procedures in this documentation use the Amazon EC2 console\. For procedures that use the CloudWatch console, see [Create Alarms That Stop, Terminate, Reboot, or Recover an Instance](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/UsingAlarmActions.html) in the *Amazon CloudWatch User Guide*\.

**Permissions**  
If you are an AWS Identity and Access Management \(IAM\) user, you must have the following permissions to create or modify an alarm:
+ `iam:CreateServiceLinkedRole`, `iam:GetPolicy`, `iam:GetPolicyVersion`, and `iam:GetRole` – For all alarms with Amazon EC2 actions
+ `ec2:DescribeInstanceStatus` and `ec2:DescribeInstances` – For all alarms on Amazon EC2 instance status metrics
+ `ec2:StopInstances` – For alarms with stop actions
+ `ec2:TerminateInstances` – For alarms with terminate actions
+ No specific permissions are needed for alarms with recover actions\.

If you have read/write permissions for Amazon CloudWatch but not for Amazon EC2, you can still create an alarm but the stop or terminate actions won't be performed on the Amazon EC2 instance\. However, if you are later granted permission to use the associated Amazon EC2 APIs, the alarm actions you created earlier are performed\. For more information about IAM permissions, see [Policies and Permissions](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html) in the *IAM User Guide*\.

**Topics**
+ [Adding stop actions to Amazon CloudWatch alarms](#AddingStopActions)
+ [Adding terminate actions to Amazon CloudWatch alarms](#AddingTerminateActions)
+ [Adding reboot actions to Amazon CloudWatch alarms](#AddingRebootActions)
+ [Adding recover actions to Amazon CloudWatch alarms](#AddingRecoverActions)
+ [Using the Amazon CloudWatch console to view alarm and action history](#ViewAlarmHistory)
+ [Amazon CloudWatch alarm action scenarios](#AlarmActionScenarios)

##### Adding stop actions to Amazon CloudWatch alarms <!-- omit in toc -->

You can create an alarm that stops an Amazon EC2 instance when a certain threshold has been met\. For example, you may run development or test instances and occasionally forget to shut them off\. You can create an alarm that is triggered when the average CPU utilization percentage has been lower than 10 percent for 24 hours, signaling that it is idle and no longer in use\. You can adjust the threshold, duration, and period to suit your needs, plus you can add an Amazon Simple Notification Service \(Amazon SNS\) notification so that you receive an email when the alarm is triggered\.

Instances that use an Amazon EBS volume as the root device can be stopped or terminated, whereas instances that use the instance store as the root device can only be terminated\.

**To create an alarm to stop an idle instance \(Amazon EC2 console\)**

1. Open the Amazon EC2 console at [https://console\.aws\.amazon\.com/ec2/](https://console.aws.amazon.com/ec2/)\.

1. In the navigation pane, choose **Instances**\.

1. Select the instance\. On the **Monitoring** tab, choose **Create Alarm**\.

1. In the **Create Alarm** dialog box, do the following:

   1. To receive an email when the alarm is triggered, for **Send a notification to**, choose an existing Amazon SNS topic, or choose **create topic** to create a new one\.

      To create a new topic, for **Send a notification to**, enter a name for the topic, and then for **With these recipients**, enter the email addresses of the recipients \(separated by commas\)\. After you create the alarm, you will receive a subscription confirmation email that you must accept before you can get notifications for this topic\.

   1. Choose **Take the action**, **Stop this instance**\.

   1. For **Whenever**, choose the statistic you want to use and then choose the metric\. In this example, choose **Average** and **CPU Utilization**\.

   1. For **Is**, specify the metric threshold\. In this example, enter **10** percent\.

   1. For **For at least**, specify the evaluation period for the alarm\. In this example, enter **24** consecutive period\(s\) of **1 Hour**\.

   1. To change the name of the alarm, for **Name of alarm**, enter a new name\. Alarm names must contain only ASCII characters\.

      If you don't enter a name for the alarm, Amazon CloudWatch automatically creates one for you\.
**Note**  
You can adjust the alarm configuration based on your own requirements before creating the alarm, or you can edit them later\. This includes the metric, threshold, duration, action, and notification settings\. However, after you create an alarm, you cannot edit its name later\.

   1. Choose **Create Alarm**\.

##### Adding terminate actions to Amazon CloudWatch alarms <!-- omit in toc -->

You can create an alarm that terminates an EC2 instance automatically when a certain threshold has been met \(as long as termination protection is not enabled for the instance\)\. For example, you might want to terminate an instance when it has completed its work, and you don’t need the instance again\. If you might want to use the instance later, you should stop the instance instead of terminating it\. For information on enabling and disabling termination protection for an instance, see [Enabling termination protection](terminating-instances.md#Using_ChangingDisableAPITermination)\.

**To create an alarm to terminate an idle instance \(Amazon EC2 console\)**

1. Open the Amazon EC2 console at [https://console\.aws\.amazon\.com/ec2/](https://console.aws.amazon.com/ec2/)\.

1. In the navigation pane, choose **Instances**\.

1. Select the instance\. On the **Monitoring** tab, choose **Create Alarm**\.

1. In the **Create Alarm** dialog box, do the following:

   1. To receive an email when the alarm is triggered, for **Send a notification to**, choose an existing Amazon SNS topic, or choose **create topic** to create a new one\.

      To create a new topic, for **Send a notification to**, enter a name for the topic, and then for **With these recipients**, enter the email addresses of the recipients \(separated by commas\)\. After you create the alarm, you will receive a subscription confirmation email that you must accept before you can get notifications for this topic\.

   1. Choose **Take the action**, **Terminate this instance**\.

   1. For **Whenever**, choose a statistic and then choose the metric\. In this example, choose **Average** and **CPU Utilization**\.

   1. For **Is**, specify the metric threshold\. In this example, enter **10** percent\.

   1. For **For at least**, specify the evaluation period for the alarm\. In this example, enter **24** consecutive period\(s\) of **1 Hour**\.

   1. To change the name of the alarm, for **Name of alarm**, enter a new name\. Alarm names must contain only ASCII characters\.

      If you don't enter a name for the alarm, Amazon CloudWatch automatically creates one for you\.
**Note**  
You can adjust the alarm configuration based on your own requirements before creating the alarm, or you can edit them later\. This includes the metric, threshold, duration, action, and notification settings\. However, after you create an alarm, you cannot edit its name later\.

   1. Choose **Create Alarm**\.

##### Adding reboot actions to Amazon CloudWatch alarms <!-- omit in toc -->

You can create an Amazon CloudWatch alarm that monitors an Amazon EC2 instance and automatically reboots the instance\. The reboot alarm action is recommended for Instance Health Check failures \(as opposed to the recover alarm action, which is suited for System Health Check failures\)\. An instance reboot is equivalent to an operating system reboot\. In most cases, it takes only a few minutes to reboot your instance\. When you reboot an instance, it remains on the same physical host, so your instance keeps its public DNS name, private IP address, and any data on its instance store volumes\.

Rebooting an instance doesn't start a new instance billing period \(with a minimum one\-minute charge\), unlike stopping and restarting your instance\. For more information, see [Reboot Your Instance](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-reboot.html) in the *Amazon EC2 User Guide for Linux Instances*\.

**Important**  
To avoid a race condition between the reboot and recover actions, avoid setting the same number of evaluation periods for a reboot alarm and a recover alarm\. We recommend that you set reboot alarms to three evaluation periods of one minute each\. For more information, see [Evaluating an Alarm](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html#alarm-evaluation) in the *Amazon CloudWatch User Guide*\.

**To create an alarm to reboot an instance \(Amazon EC2 console\)**

1. Open the Amazon EC2 console at [https://console\.aws\.amazon\.com/ec2/](https://console.aws.amazon.com/ec2/)\.

1. In the navigation pane, choose **Instances**\.

1. Select the instance\. On the **Monitoring** tab, choose **Create Alarm**\.

1. In the **Create Alarm** dialog box, do the following:

   1. To receive an email when the alarm is triggered, for **Send a notification to**, choose an existing Amazon SNS topic, or choose **create topic** to create a new one\.

      To create a new topic, for **Send a notification to**, enter a name for the topic, and for **With these recipients**, enter the email addresses of the recipients \(separated by commas\)\. After you create the alarm, you will receive a subscription confirmation email that you must accept before you can get notifications for this topic\.

   1. Select **Take the action**, **Reboot this instance**\.

   1. For **Whenever**, choose **Status Check Failed \(Instance\)**\.

   1. For **For at least**, specify the evaluation period for the alarm\. In this example, enter **3** consecutive period\(s\) of **1 Minute**\.

   1. To change the name of the alarm, for **Name of alarm**, enter a new name\. Alarm names must contain only ASCII characters\.

      If you don't enter a name for the alarm, Amazon CloudWatch automatically creates one for you\.

   1. Choose **Create Alarm**\.

##### Adding recover actions to Amazon CloudWatch alarms <!-- omit in toc -->

You can create an Amazon CloudWatch alarm that monitors an Amazon EC2 instance\. If the instance becomes impaired due to an underlying hardware failure or a problem that requires AWS involvement to repair, you can automatically recover the instance\. Terminated instances cannot be recovered\. A recovered instance is identical to the original instance, including the instance ID, private IP addresses, Elastic IP addresses, and all instance metadata\.

CloudWatch prevents you from adding a recovery action to an alarm that is on an instance which does not support recovery actions\.

When the `StatusCheckFailed_System` alarm is triggered, and the recover action is initiated, you are notified by the Amazon SNS topic that you chose when you created the alarm and associated the recover action\. During instance recovery, the instance is migrated during an instance reboot, and any data that is in\-memory is lost\. When the process is complete, information is published to the SNS topic you've configured for the alarm\. Anyone who is subscribed to this SNS topic receives an email notification that includes the status of the recovery attempt and any further instructions\. You notice an instance reboot on the recovered instance\.

The recover action can be used only with `StatusCheckFailed_System`, not with `StatusCheckFailed_Instance`\.

The following problems can cause system status checks to fail:
+ Loss of network connectivity
+ Loss of system power
+ Software issues on the physical host
+ Hardware issues on the physical host that impact network reachability

The recover action is supported only on instances with the following characteristics:
+ Use one of the following instance types: A1, C3, C4, C5, C5a, C5n, C6g, Inf1,  M3, M4, M5, M5a, M5n, M6g,  P3, R3, R4, R5, R5a, R5n, R6g,  T2, T3, T3a, X1, or X1e
+ Use `default` or `dedicated` instance tenancy
+ Use EBS volumes only \(do not configure instance store volumes\)\. For more information, see ['Recover this instance' is disabled](https://aws.amazon.com/premiumsupport/knowledge-center/recover-this-instance-cloudwatch-enable/)\.

If your instance has a public IP address, it retains the public IP address after recovery\.

**Important**  
To avoid a race condition between the reboot and recover actions, avoid setting the same number of evaluation periods for a reboot alarm and a recover alarm\. We recommend that you set recover alarms to two evaluation periods of one minute each\. For more information, see [Evaluating an Alarm](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html#alarm-evaluation) in the *Amazon CloudWatch User Guide*\.

**To create an alarm to recover an instance \(Amazon EC2 console\)**

1. Open the Amazon EC2 console at [https://console\.aws\.amazon\.com/ec2/](https://console.aws.amazon.com/ec2/)\.

1. In the navigation pane, choose **Instances**\.

1. Select the instance\. On the **Monitoring** tab, choose **Create Alarm**\.

1. In the **Create Alarm** dialog box, do the following:

   1. To receive an email when the alarm is triggered, for **Send a notification to**, choose an existing Amazon SNS topic, or choose **create topic** to create a new one\.

      To create a new topic, for **Send a notification to**, enter a name for the topic, and for **With these recipients**, enter the email addresses of the recipients \(separated by commas\)\. After you create the alarm, you will receive a subscription confirmation email that you must accept before you can get email for this topic\.
**Note**  
Users must subscribe to the specified SNS topic to receive email notifications when the alarm is triggered\.
The AWS account root user always receives email notifications when automatic instance recovery actions occur, even if an SNS topic is not specified\.
The AWS account root user always receives email notifications when automatic instance recovery actions occur, even if it is not subscribed to the specified SNS topic\.

   1. Select **Take the action**, **Recover this instance**\.

   1. For **Whenever**, choose **Status Check Failed \(System\)**\.

   1. For **For at least**, specify the evaluation period for the alarm\. In this example, enter **2** consecutive period\(s\) of **1 Minute**\.

   1. To change the name of the alarm, for **Name of alarm**, enter a new name\. Alarm names must contain only ASCII characters\.

      If you don't enter a name for the alarm, Amazon CloudWatch automatically creates one for you\.

   1. Choose **Create Alarm**\.

#### Using the Amazon CloudWatch console to view alarm and action history <!-- omit in toc -->

You can view alarm and action history in the Amazon CloudWatch console\. Amazon CloudWatch keeps the last two weeks' worth of alarm and action history\.

**To view the history of triggered alarms and actions \(CloudWatch console\)**

1. Open the CloudWatch console at [https://console\.aws\.amazon\.com/cloudwatch/](https://console.aws.amazon.com/cloudwatch/)\.

1. In the navigation pane, choose **Alarms**\.

1. Select an alarm\.

1. The **Details** tab shows the most recent state transition along with the time and metric values\.

1. Choose the **History** tab to view the most recent history entries\.

#### Amazon CloudWatch alarm action scenarios <!-- omit in toc -->

You can use the Amazon EC2 console to create alarm actions that stop or terminate an Amazon EC2 instance when certain conditions are met\. In the following screen capture of the console page where you set the alarm actions, we've numbered the settings\. We've also numbered the settings in the scenarios that follow, to help you create the appropriate actions\.

![\[Create Alarm for dialog box\]](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/images/CreateAlarmFor.png)

##### Scenario 1: Stop idle development and test instances <!-- omit in toc -->

Create an alarm that stops an instance used for software development or testing when it has been idle for at least an hour\.


| Setting | Value | 
| --- | --- | 
|  1  |  Stop  | 
|  2  |  Maximum  | 
|  3  |  CPUUtilization  | 
|  4  |  <=  | 
|  5  |  10%  | 
|  6  |  60 minutes  | 
|  7  |  1  | 

##### Scenario 2: Stop idle instances <!-- omit in toc -->

Create an alarm that stops an instance and sends an email when the instance has been idle for 24 hours\.


| Setting | Value | 
| --- | --- | 
|  1  |  Stop and email  | 
|  2  |  Average  | 
|  3  |  CPUUtilization  | 
|  4  |  <=  | 
|  5  |  5%  | 
|  6  |  60 minutes  | 
|  7  |  24  | 

##### Scenario 3: Send email about web servers with unusually high traffic <!-- omit in toc -->

Create an alarm that sends email when an instance exceeds 10 GB of outbound network traffic per day\.


| Setting | Value | 
| --- | --- | 
|  1  |  Email  | 
|  2  |  Sum  | 
|  3  |  NetworkOut  | 
|  4  |  >  | 
|  5  |  10 GB  | 
|  6  |  1 day  | 
|  7  |  1  | 

##### Scenario 4: Stop web servers with unusually high traffic <!-- omit in toc -->

Create an alarm that stops an instance and send a text message \(SMS\) if outbound traffic exceeds 1 GB per hour\.


| Setting | Value | 
| --- | --- | 
|  1  |  Stop and send SMS  | 
|  2  |  Sum  | 
|  3  |  NetworkOut  | 
|  4  |  >  | 
|  5  |  1 GB  | 
|  6  |  1 hour  | 
|  7  |  1  | 

##### Scenario 5: Stop an instance experiencing a memory leak <!-- omit in toc -->

Create an alarm that stops an instance when memory utilization reaches or exceeds 90%, so that application logs can be retrieved for troubleshooting\.

**Note**  
The MemoryUtilization metric is a custom metric\. In order to use the MemoryUtilization metric, you must install the Perl scripts for Linux instances\. For more information, see [Monitoring Memory and Disk Metrics for Amazon EC2 Linux Instances](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/mon-scripts.html)\.


| Setting | Value | 
| --- | --- | 
|  1  |  Stop  | 
|  2  |  Maximum  | 
|  3  |  MemoryUtilization  | 
|  4  |  >=  | 
|  5  |  90%  | 
|  6  |  1 minute  | 
|  7  |  1  | 

##### Scenario 6: Stop an impaired instance <!-- omit in toc -->

Create an alarm that stops an instance that fails three consecutive status checks \(performed at 5\-minute intervals\)\.


| Setting | Value | 
| --- | --- | 
|  1  |  Stop  | 
|  2  |  Average  | 
|  3  |  StatusCheckFailed\_System  | 
|  4  |  >=  | 
|  5  |  1  | 
|  6  |  15 minutes  | 
|  7  |  1  | 

##### Scenario 7: Terminate instances when batch processing jobs are complete <!-- omit in toc -->

Create an alarm that terminates an instance that runs batch jobs when it is no longer sending results data\.


| Setting | Value | 
| --- | --- | 
|  1  |  Terminate  | 
|  2  |  Maximum  | 
|  3  |  NetworkOut  | 
|  4  |  <=  | 
|  5  |  100,000 bytes  | 
|  6  |  5 minutes  | 
|  7  |  1  | 

## Endnotes
### Endnote 1 <!-- omit in toc -->
[https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html)

### Endnote 2 <!-- omit in toc -->
[https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html#encryption-examples](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html#encryption-examples)

### Endnote 3 <!-- omit in toc -->
[https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-patch.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-patch.html)

## Capital Group Control Statements 
1. All Data-at-rest must be encrypted and use a CG BYOK encryption key.
2. All Data-in-transit must be encrypted using certificates using CG Certificate Authority.
3. Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.
4. AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch.
5. AWS IAM User accounts are only to be created for use by services or products that do not support IAM Roles. Services are not allowed to create local accounts for human use within the service. All human user authentication will take place within CG’s Identity Provider.
6. Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.
7. Use of AWS IAM accounts are restricted to CG networks.
8. AWS IAM User secrets, including passwords and secret access keys, are to be rotated every 90 days. Accounts created locally within any service must also have their secrets rotated every 90 days.
9. Encryption keys are rotated annually.
10. Administrative access to AWS resources will have MFA enabled

## Capital Group Glossory 
**Data** - Digital pieces of information stored or transmitted for use with an information system from which understandable information is derived. Items that could be considered to be data are: Source code, meta-data, build artifacts, information input and output.  
 
**Information System** - An organized assembly of resources and procedures for the collection, processing, maintenance, use, sharing, dissemination, or disposition of information. All systems, platforms, compute instances including and not limited to physical and virtual client endpoints, physical and virtual servers, software containers, databases, Internet of Things (IoT) devices, network devices, applications (internal and external), Serverless computing instances (i.e. AWS Lambda), vendor provided appliances, and third-party platforms, connected to the Capital Group network or used by Capital Group users or customers.

**Log** - a record of the events occurring within information systems and networks. Logs are composed of log entries; each entry contains information related to a specific event that has occurred within a system or network.

**Information** - communication or representation of knowledge such as facts, data, or opinions in any medium or form, including textual, numerical, graphic, cartographic, narrative, or audiovisual. 

**Cloud computing** - A model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources (e.g., networks, servers, storage, applications, and services) that can be rapidly provisioned and released with minimal management effort or service provider interaction.

**Vulnerability**  - Weakness in an information system, system security procedures, internal controls, or implementation that could be exploited or triggered by a threat source. Note: The term weakness is synonymous for deficiency. Weakness may result in security and/or privacy risks.