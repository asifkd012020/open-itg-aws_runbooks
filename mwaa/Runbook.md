<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# (PoC Only) AWS MWAA (Managed Workflows for Apache Airflow) - Security Playbook <!-- omit in toc -->
## Capgroup Cybersecurity Control Alignment <!-- omit in toc -->

This is a MVP Security Runbook to allow PoC of Managed Workflows for Apache Airflow.  In order to use this service in production, the rest of the runbook will have to be completed with additional cloud security requirements. 

**Generated By:**  
[Philip Phan (PHLP)](https://cgweb3/profile/PHLP)
<br>
Platform Design Services

[Name (Initials)](https://cgweb3/profile/Initials)
<br>
Security Engineering

**Last Update:** *08/17/2021*

## Table of Contents <!-- omit in toc -->
- [Overview](#overview)
- [Cloud Security Requirements](#cloud-security-requirements)
  - [1. MWAA is Encrypted using CG Managed KMS Keys](#1-mwaa-is-encrypted-using-cg-managed-kms-keys)
  - [2. MWAA Utilizes VPC Endpoints to Prevent Public Access](#2-mwaa-utilizes-vpc-endpoints-to-prevent-public-access)
  - [3. Configure MWAA execution roles to enforce least priviledge](#3-configure-mwaa-execution-roles-to-enforce-least-priviledge)
  - [4. CloudTrail logging enabled for MWAA](#4-cloudtrail-logging-enabled-for-mwaa)
- [Other Operational Expectations](#other-operational-expectations)
  - [1. MWAA Resources are tagged according to CG standards](#1-mwaa-resources-are-tagged-according-to-cg-standards)
- [Endnotes](#endnotes)
- [Capital Group Glossary](#capital-group-glossary)
<br><br>

## Overview
Amazon Managed Workflows for Apache Airflow (Amazon MWAA) is a managed orchestration service for Apache Airflow. 
Airflow is an open source tool for programatically authoring, scheduling, and monitoring workflows.  With MWAA you can use Airflow & Python to create workflows without having to managed underlying infrastructure. 
<br>
<img src="/docs/img/mwaa/mwaa_overview.png" width="800"><br>
<br>

## Cloud Security Requirements
<img src="/docs/img/Prevent.png" width="50">

### 1. MWAA is Encrypted using CG Managed KMS Keys

CG's Cloud Security standards require that we ensure that AWS Services that hold sensitive, critical or any other data are encrypted to fulfill compliance requirements for data-at-rest encryption. When creating a MWAA environment, you can specify a customer managed key for encryption.  

**How?**<br>
Users will be uploading DAGs to Amazon S3, reference the runbook for s3 to make sure it is compliant with CG [S3 Controls](https://github.com/open-itg/aws_runbooks/blob/CNTEN-3624-MWAA/s3/RUNBOOK.md) <br>

[MWAA Encryption](https://docs.aws.amazon.com/mwaa/latest/userguide/encryption-at-rest.html)
CMK Requirement as of 08/16 -  MWAA requires you use the same KMS encyrption key used for S3 bucket to encrypt the MWAA environment.  The S3 KMS Key Policy only allows the key to be used to encrypt s3 , so for testing purposes only you will have to update the s3 kms key policy to allow encryption of the MWAA Environment and other supporting services. 

```
{
    "Version": "2012-10-17",
    "Id": "key-default-s3",
    "Statement": [
        {
            "Sid": "Enable IAM User Permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::707172424705:root"
            },
            "Action": "kms:*",
            "Resource": "*"
        },
        {
            "Sid": "Allow access for Key Administrators",
            "Effect": "Allow",
            "Principal": {
                "AWS": [
                    "arn:aws:iam::707172424705:role/EncryptionKeyMgmtAdmin",
                    "arn:aws:iam::707172424705:role/SysAdmin"
                ]
            },
            "Action": [
                "kms:Create*",
                "kms:Describe*",
                "kms:Enable*",
                "kms:List*",
                "kms:Put*",
                "kms:Update*",
                "kms:Revoke*",
                "kms:Disable*",
                "kms:Get*",
                "kms:Delete*",
                "kms:ImportKeyMaterial",
                "kms:TagResource",
                "kms:UntagResource",
                "kms:ScheduleKeyDeletion",
                "kms:CancelKeyDeletion"
            ],
            "Resource": "*"
        },
        {
            "Sid": "Allow use of the key",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": [
                "kms:Encrypt",
                "kms:Decrypt",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:DescribeKey"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "kms:ViaService": [
                        "s3.us-west-2.amazonaws.com",
                        "airflow.us-west-2.amazonaws.com",
                        "sqs.us-west-2.amazonaws.com"
                    ],
                    "aws:PrincipalOrgID": "o-1eax4cor5e"
                }
            }
        },
        {
            "Sid": "Allow attachment of persistent resources",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": [
                "kms:CreateGrant",
                "kms:ListGrants",
                "kms:RevokeGrant"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "kms:CallerAccount": "707172424705",
                    "kms:ViaService": [
                        "s3.us-west-2.amazonaws.com",
                        "airflow.us-west-2.amazonaws.com",
                        "sqs.us-west-2.amazonaws.com"
                    ]
                },
                "Bool": {
                    "kms:GrantIsForAWSResource": "true"
                }
            }
        },
        {
            "Sid": "Allow all principals within the account to describe and list key information",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": [
                "kms:Describe*",
                "kms:List*"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "aws:PrincipalOrgID": "o-1eax4cor5e"
                }
            }
        },
        {
            "Sid": "LogSupport",
            "Effect": "Allow",
            "Principal": {
                "Service": "logs.us-west-2.amazonaws.com"
            },
            "Action": [
                "kms:Encrypt*",
                "kms:Decrypt*",
                "kms:ReEncrypt*",
                "kms:GenerateDataKey*",
                "kms:Describe*"
            ],
            "Resource": "*"
        }
    ]
}
```

During provisioning of MWAA via the AWS Management Console: 
1. Scroll down to Encryption Section 
2. Check Box "Customize encryption settings(advanced)" 
3. Select your CMK ARN for S3
<br>
<img src="/docs/img/mwaa/mwaa_cmk.png" width="800"><br>
<br> <br>

### 2. MWAA Utilizes VPC Endpoints to Prevent Public Access
MWAA currently supports VPC Interface Endpoints, and as such allows the service to meet CG's stringent Public Access control requirements.
<br>

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|[CS0012300](https://capitalgroup.service-now.com/cg_grc?sys_id=80df48c01bac20506a50beef034bcb47&table=sn_compliance_policy_statement&id=cg_grc_action_item_details&view=sp)|Cloud products and services must be deployed on private subnets and public access must be disabled for these services.|

**Why?**<br>
MWAA is a service that allows for the storage and processing of data from multiple services such as S3, SQS, and ECR. Due to the possibility of sensitive data being stored and processed while using this service, we need to make sure that this traffic is not transmitted directly over the Public Internet. 
<br>

**How?**<br>
https://docs.aws.amazon.com/mwaa/latest/userguide/vpc-vpe-create-access.html#vpc-vpe-create-view-endpoints-examples
To establish a private connection between your virtual private cloud (VPC),  MWAA and other integrated services you should create VPC private endpoints. You can use these connections to call the services from your VPC without sending traffic over the Internet. The endpoint provides secure connectivity to the APIs without requiring an Internet gateway (IGW), NAT instance, or virtual private network (VPN) connection.

Interface VPC endpoints are powered by AWS PrivateLink, a feature that enables private communication between AWS services using private IP addresses. To use AWS PrivateLink, create an interface VPC endpoint for supported services in your VPC using the Amazon VPC console, API, or CLI. Doing this creates an elastic network interface in your subnet with a private IP address that serves requests. You can also access a VPC endpoint from on-premises environments or from other VPCs using AWS VPN, AWS Direct Connect, or VPC peering. Below are the steps to implement Interface VPC Endpoints for requires for MWAA: 

***Pre-requisites for Private MWAA*** <br>
Before deploying a private MWAA , you'll need to create all of the required VPC endpoints. You can either deploy them manually or use the CloudFormation template provided below. <br>

**Creation of VPC Endpoints via console(manual)**
1. Follow the instructions on the AWS Documentation below to create all the required VPC Endpoints required for a private MWAA
  - https://docs.aws.amazon.com/mwaa/latest/userguide/vpc-vpe-create-access.html#vpc-vpe-create-view-endpoints-attach-all
<br><br>

**Creation of VPC Endpoints via Cloud Formation**
1. Here's a CloudFormation template you can use to create all the required VPC endpoints & security group.  You will have to select your VPC and Subnets during the stack deployment. 
<br>

``` <br>
AWSTemplateFormatVersion: "2010-09-09"

Parameters:
   VPC:
     Description: The VPC ID
     Type: String
     Default: "vpc-09fb3082379020967"

   SubnetIDList:
     Description: The IP range (CIDR notation) for this VPC
     Type: List<AWS::EC2::Subnet::Id>
     Default: "subnet-06fb0261137cd23c2, subnet-0f1e437e66b4c0445, subnet-0e5aa37a04c50bb0e, subnet-012b4723e96663325"
     
Resources:
   SecurityGroup:
     Type: AWS::EC2::SecurityGroup
     Properties:
       VpcId: !Ref VPC
       GroupDescription: Security Group for Amazon MWAA Environments to access VPC endpoints
       GroupName: !Sub "${AWS::StackName}-mwaa-vpc-endpoints"
   
   SecurityGroupIngress:
     Type: AWS::EC2::SecurityGroupIngress
     Properties:
       GroupId: !Ref SecurityGroup
       IpProtocol: "-1"
       SourceSecurityGroupId: !Ref SecurityGroup
   
   SqsVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.sqs"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup
     
   CloudWatchLogsVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.logs"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup
     
   CloudWatchMonitoringVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.monitoring"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup
     
   KmsVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.kms"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup
     
   EcrApiVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.ecr.api"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup
     
   EcrDkrVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.ecr.dkr"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup

   AirflowApiVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.airflow.api"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup  
        
   AirflowEnvVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.airflow.env"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup   
                                         
   AirflowOpsVpcEndoint:
     Type: AWS::EC2::VPCEndpoint
     Properties:
       ServiceName: !Sub "com.amazonaws.${AWS::Region}.airflow.ops"
       VpcEndpointType: Interface
       VpcId: !Ref VPC
       PrivateDnsEnabled: true
       SubnetIds: !Ref SubnetIDList
       SecurityGroupIds:
        - !Ref SecurityGroup

Outputs:
   MwaaSecurityGroupId:
     Description: Associates the Security Group to the environment to allow access to the VPC endpoints 
     Value: !Ref SecurityGroup  
```
<br>

**Deploying a private MWAA environment** <br>
After deploying the private endpoints and security group to allow access to the endpoints, you can proceed with provisioning of a private MWAA. 

During provisioning of MWAA via the AWS Management Console: 
1. In the Networking Section 
2. Select your private VPCs and Subnets to deploy MWAA in. 
3. Select the private network setting
4. Select the security group created as part of the Cloud Formation Template to allow access to your VPC Endpoints 

<br>
<img src="/docs/img/mwaa/mwaa_private_network.png" width="800"><br>


### 3. Configure MWAA execution roles to enforce least priviledge

`This Section will be updated soon.`

### 4. CloudTrail logging enabled for MWAA

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|Control Definition Needed|Control Definition Description Needed

`This Section will be updated soon.`



## Other Operational Expectations
<img src="/docs/img/Operations.png" width="50">

### 1. MWAA Resources are tagged according to CG standards
**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|N/A| No security control currently defined.|

**What, Why & How?**

Tagging resources in the cloud is an easy way for teams to provide information related to who owns the resource, what the resource is used for, as well as other important information related to the deployment lifecycle of the resource. CG has mandated that all cloud resources are to be tagged with certain important for cross-team use. Although most of the mandatory tags will be added through automation, one should still check to make sure that all newly deployed recources have the appropriate tags attached. please see the documentation below for the latest tagging standards.

[CG Cloud Tagging Strategy](https://confluence.capgroup.com/display/HCEA/Resource+Tagging+standards)
<br><br>



<br><br>

## Endnotes
**Resources**<br>
1. https://aws.amazon.com/managed-workflows-for-apache-airflow/
2. https://docs.aws.amazon.com/mwaa/latest/userguide/encryption-at-rest.html
3. 
4. 
5. 
6. 
<br><br>

## Capital Group Glossary 
**Data** - Digital pieces of information stored or transmitted for use with an information system from which understandable information is derived. Items that could be considered to be data are: Source code, meta-data, build artifacts, information input and output.  
 
**Information System** - An organized assembly of resources and procedures for the collection, processing, maintenance, use, sharing, dissemination, or disposition of information. All systems, platforms, compute instances including and not limited to physical and virtual client endpoints, physical and virtual servers, software containers, databases, Internet of Things (IoT) devices, network devices, applications (internal and external), Serverless computing instances (i.e. AWS Lambda), vendor provided appliances, and third-party platforms, connected to the Capital Group network or used by Capital Group users or customers.

**Log** - a record of the events occurring within information systems and networks. Logs are composed of log entries; each entry contains information related to a specific event that has occurred within a system or network.

**Information** - communication or representation of knowledge such as facts, data, or opinions in any medium or form, including textual, numerical, graphic, cartographic, narrative, or audiovisual. 

**Cloud computing** - A model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources (e.g., networks, servers, storage, applications, and services) that can be rapidly provisioned and released with minimal management effort or service provider interaction.

**Vulnerability**  - Weakness in an information system, system security procedures, internal controls, or implementation that could be exploited or triggered by a threat source. Note: The term weakness is synonymous for deficiency. Weakness may result in security and/or privacy risks.