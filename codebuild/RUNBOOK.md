<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# AWS CodeBuild - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1. Permissions within the service are established in line with individual need and least-privilege is enforced](#1-permissions-within-the-service-are-established-in-line-with-individual-need-and-least-privilege-is-enforced)
  - [2. Data is protected All Data at rest must be encrypted and use a CG BYOK encryption key|](#2-data-is-protected-all-data-at-rest-must-be-encrypted-and-use-a-cg-byok-encryption-key)
  - [3. Inter-network traffic privacy](#3-inter-network-traffic-privacy)
  - [4. Restrict Access to Deny Regions Outside US](#4-Restrict-Access-to-Deny-Regions-Outside-US)
- [Detective](#detective)
  - [1. Auditing of all interactions with AWS CodeBuild](#1-auditing-of-all-interactions-with-aws-codebuild)
- [Respond/Recover](#respondrecover)
  - [1. Utilize an event-based solution for automated incident response](#1-utilize-an-event-based-solution-for-automated-incident-response)
- [Endnotes](#endnotes)
- [Capital Group Control Statements](#capital-group-control-statements)

## Overview
AWS provides a number of security features for AWS CodeBuild which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: ID, PR.AC-2, PR.AT, PR.DS (Unless stated), PR.IP (Unless Stated), PR.MA, PR.PT-2, PR.PT-3, DE.AE-4, DE.AE-5, DE.CM-2, DE.CM-6, DE.DP, RS.RP, RS.CO, RS.MI, RS.IM, RC

These Capital Group control statements are not applicable to this service: 5, 7, 8, 9, 10

## Preventative Controls
### 1. Permissions within the service are established in line with individual need and least-privilege is enforced
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individualsâ€™ security and privacy risks and other organizational risks)|
|PR.PT-3|The principle of least functionality is incorporated by configuring systems to provide only essential capabilities|

**Why?** Different users/services will require different levels of access within the service. Having clearly defined policies and limiters will ensure that a user is not able to manage build projects in ways that they shouldn't be able to.

**How?**
- Use IAM for appropriate user access restrictions
- Limit sensitive functions (for both console and CLI access) to authorized individuals; at a minimum, Update Project and Create Project.
- Leverage tags to restrict user access based on tag value.

You can use a wildcard (\*) to specify multiple actions or resources. For example, `codebuild:*` specifies all CodeBuild actions and `codebuild:Batch*` specifies all CodeBuild actions that begin with the word `Batch`. The following example grants access to all build project with names that begin with `my`: 
```ruby
arn:aws:codebuild:us-east-2:123456789012:project/my*
```

For more information on setting up IAM permissions for CodeBuild, including examples, see [Endnote 1](#endnote-1).

### 2. Data is protected All Data at rest must be encrypted and use a CG BYOK encryption key|

NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|1|All Data-at-rest must be encrypted and use a Capital Group BYOK encryption key|
|2|All Data-in-transit must be encrypted using certificates using Capital Group Certificate Authority.|
|3|Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.|

*All data-in-transit will be encrypted according to the AWS standard (TLS 1.2 and AES-256), which meets Capital Group's encryption standard, however, all AWS service to service communication utilizes AWS generated certificates.*

**Why?** Encryption is an important part of CodeBuild security. Some encryption, such as for data in-transit, is provided by default and does not require you to do anything. Other encryption, such as for data at-rest, you can configure when you create your project or build. 

**How?** Build artifacts (cache, logs, build results) are encrypted by default using the AWS-managed CMK for Amazon S3 in your AWS account. To use a customer-managed CMK, you must create and configure the CMK and specify it during project configuration.  
To configure a CMK for use by CodeBuild, follow the instructions in the "How to Modify a Key Policy" section of [Modifying a Key Policy](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-modifying.html) in the AWS KMS Developer Guide. Then add the following statements (between *### BEGIN ADDING STATEMENTS HERE ###* and *### END ADDING STATEMENTS HERE ###*) to the key policy. Ellipses (...) are used for brevity and to help you locate where to add the statements. Do not remove any statements, and do not type these ellipses into the key policy.
```json
{
  "Version": "2012-10-17",
  "Id": "...",
  "Statement": [
    ### BEGIN ADDING STATEMENTS HERE ###
    {
      "Sid": "Allow access through Amazon S3 for all principals in the account that are authorized to use Amazon S3",
      "Effect": "Allow",
      "Principal": {
        "AWS": "*"
      },
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "kms:ViaService": "s3.region-ID.amazonaws.com",
          "kms:CallerAccount": "account-ID"
        }
      }
    },
    {
      "Effect": "Allow", 
      "Principal": {
        "AWS": "arn:aws:iam::account-ID:role/CodeBuild-service-role"
      },
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "*"
    },
    ### END ADDING STATEMENTS HERE ###
    {
      "Sid": "Enable IAM User Permissions",
      ...
    },
    {
      "Sid": "Allow access for Key Administrators",
      ...
    },
    {
      "Sid": "Allow use of the key",
      ...
    },
    {
      "Sid": "Allow attachment of persistent resources",
      ...
    }
  ]
}
```

The EBS volumes of the build fleet are encrypted by default using the AWS-managed CMK for EBS. **This key cannot be changed and a Capital Group Key cannot be used (no BYOK)**.  
EFS file systems attached to the build fleet can be encrypted with customer-managed keys.  
All communication between customers and CodeBuild and between CodeBuild and its downstream dependencies are encrypted using TLS.  

For more information about data encryption within CodeBuild, see [Endnote 2](#endnote-2).

### 3. Inter-network traffic privacy
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.PT-4|Communications and control networks are protected|
|PR.PT-5|Mechanisms (e.g., failsafe, load balancing, hot swap) are implemented to achieve resilience requirements in normal and adverse situations|
|PR.AC-3|Remote access is managed|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|6|Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.|

**Why?** Traffic between services and between regions on AWS uses the AWS backbone by default. In the event of network interruption, though, the traffic will traverse the public Internet. In addition to this, access to services like CodeBuild that don't reside within a VPC is done using publicly-routeable IP addresses. These measures will help isolate your traffic by ensuring it stays on the AWS backbone at all times, and by setting up private IP addresses to communicate between services.

**How?** You can improve the security of your builds by configuring AWS CodeBuild to use an interface VPC endpoint. Interface endpoints are powered by PrivateLink, a technology that enables you to privately access Amazon EC2 and CodeBuild by using private IP addresses. PrivateLink restricts all network traffic between your managed instances, CodeBuild, and Amazon EC2 to the Amazon network. Also, you don't need an internet gateway, NAT device, or virtual private gateway.

To create a VPC endpoint, a network administrator must follow the instructions in [Creating an interface endpoint](https://docs.aws.amazon.com/vpc/latest/userguide/vpce-interface.html#create-interface-endpoint) to create the endpoint `com.amazonaws.`_`region`_`.codebuild`. This is a VPC endpoint for AWS CodeBuild.

Endpoint policies allow you to control which principals are allowed to use the endpoint, and what they are allowed to do through the endpoint. These policies do not override any IAM policies. The following example policy specifies that all principals can only start and view builds for the `project-name` project.
```json
{
    "Statement": [
        {
            "Action": [
                "codebuild:ListBuildsForProject",
                "codebuild:StartBuild",
                "codebuild:BatchGetBuilds"
            ],
            "Effect": "Allow",
            "Resource": "arn:aws:codebuild:region-ID:account-ID:project/project-name",
            "Principal": "*"
        }
    ]
}
```
To limit use of the gateway endpoint to a specific principal, you must use the `Condition` element in your endpoint policy and specify the aws:PrincipalArn condition key, for example:
```json
"Condition": {
    "StringEquals": {
        "aws:PrincipalArn": "arn:aws:iam::123456789012:user/endpointuser"
    }
}
```

For more information on setting up VPC Endpoints for CodeBuild, see [Endnote 3](#endnote-3).

### 4. Restrict Access to Deny Regions Outside US region
 *Policy resticts the access to Deny any resources outside of US Region*
 ```
 {
            "Sid": "DenyAllOutsideUS",
            "Effect": "Deny",
            "NotAction": [
                "support:*",
                "sts:*"
            ],
            "Resource": "*",
            "Condition": {
                "StringNotEquals": {
                    "aws:RequestedRegion": [
                        "us-west-1",
                        "us-west-2",
                        "us-east-1",
                    ]
                },
                "StringNotLike": {
                    "aws:PrincipalArn": [
                        "arn:aws:iam::*:role/OrganizationAccountAccessRole"
                    ]
                }
            }
        },
 
 ```

## Detective
### 1. Auditing of all interactions with AWS CodeBuild
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed| 

Capital Group:
|Control Statement|Description|
|------|----------------------|
|4|AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch.|

**Why?** Monitoring is an important part of maintaining the reliability, availability, and performance of AWS CodeBuild and your AWS solutions. You should collect monitoring data from all of the parts of your AWS solution so that you can more easily debug a multi-point failure, if one occurs. AWS provides the following tools for monitoring your CodeBuild resources and builds and for responding to potential incidents. 

**How?** AWS CodeBuild is integrated with AWS CloudTrail, a service that provides a record of actions taken by a user, role, or an AWS service in CodeBuild. As long as CloudTrail is enabled in your AWS account, there are no additional steps required to send logs to it. CloudTrail captures all API calls for CodeBuild as events, including calls from the CodeBuild console and from code calls to the CodeBuild APIs. If you create a trail, you can enable continuous delivery of CloudTrail events to an Amazon S3 bucket, including events for CodeBuild. If you don't configure a trail, you can still view the most recent events in the CloudTrail console in Event history. Using the information collected by CloudTrail, you can determine the request that was made to CodeBuild, the IP address from which the request was made, who made the request, when it was made, and additional details.  
To protect sensitive information, AWS access key IDs, strings specified using the Parameter Store, and strings specified using AWS Secrets Manager are hidden in CodeBuild logs.

The following example shows a CloudTrail log entry that demonstrates creating a build project in CodeBuild.
```json
{    
  "eventVersion": "1.05",   
  "userIdentity": {       
    "type": "FederatedUser",       
    "principalId": "account-ID:user-name",       
    "arn": "arn:aws:sts::account-ID:federated-user/user-name",       
    "accountId": "account-ID",       
    "accessKeyId": "access-key-ID",       
    "sessionContext": {
      "attributes": {
        "mfaAuthenticated": "false",
        "creationDate": "2016-09-06T17:59:10Z"
      },
      "sessionIssuer": {
        "type": "IAMUser",
        "principalId": "access-key-ID",
        "arn": "arn:aws:iam::account-ID:user/user-name",
        "accountId": "account-ID",
        "userName": "user-name"
      }       
    }   
  },   
  "eventTime": "2016-09-06T17:59:11Z",   
  "eventSource": "codebuild.amazonaws.com",   
  "eventName": "CreateProject",   
  "awsRegion": "region-ID",   
  "sourceIPAddress": "127.0.0.1",   
  "userAgent": "user-agent",   
  "requestParameters": {       
    "awsActId": "account-ID"   
  },   
  "responseElements": {       
    "project": {
      "environment": {
        "image": "image-ID",
        "computeType": "BUILD_GENERAL1_SMALL",
        "type": "LINUX_CONTAINER",
        "environmentVariables": []
      },
      "name": "codebuild-demo-project",
      "description": "This is my demo project",
      "arn": "arn:aws:codebuild:region-ID:account-ID:project/codebuild-demo-project:project-ID",
      "encryptionKey": "arn:aws:kms:region-ID:key-ID",
      "timeoutInMinutes": 10,
      "artifacts": {
        "location": "arn:aws:s3:::codebuild-region-ID-account-ID-output-bucket",
        "type": "S3",
        "packaging": "ZIP",
        "outputName": "MyOutputArtifact.zip"
      }, 
      "serviceRole": "arn:aws:iam::account-ID:role/CodeBuildServiceRole",
      "lastModified": "Sep 6, 2016 10:59:11 AM",
      "source": {      
        "type": "GITHUB",
        "location": "https://github.com/my-repo.git"
      },
      "created": "Sep 6, 2016 10:59:11 AM"       
    }   
  },   
  "requestID": "9d32b228-745b-11e6-98bb-23b67EXAMPLE",   
  "eventID": "581f7dd1-8d2e-40b0-aeee-0dbf7EXAMPLE",   
  "eventType": "AwsApiCall",   
  "recipientAccountId": "account-ID" 
}
```

## Respond/Recover
### 1. Utilize an event-based solution for automated incident response
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN-1|Notifications from detection systems are investigated|
|RS.AN-2|The impact of the incident is understood|
|RS.AN-3|Forensics are performed|
|RS.AN-4|Incidents are categorized consistent with response plans|
|RS.AN-5|Processes are established to receive, analyze and respond to vulnerabilities disclosed to the organization from internal and external sources (e.g. internal testing, security bulletins, or security researchers)|

**Why?** Using an event-based solution, you can automatically report and respond to incidents of almost any kind, including failed builds, unauthorized project creation, or builds taking too long to run.

**How?**  You can use Amazon CloudWatch to watch your builds, report when something is wrong, and take automatic actions when appropriate. You can monitor your builds at two levels:
- Project level: These metrics are for all builds in the specified project only. To see metrics for a project, specify ProjectName for the dimension in CloudWatch.
- AWS account level: These metrics are for all builds in one account. To see metrics at the AWS account level, do not enter a dimension in CloudWatch.  
For more information on setting up CloudWatch Metrics and Alarms, see [Endnote 4](#endnote-4) and [Endnote 5](#endnote-5).

The following metrics can be tracked per AWS account or build project. 
|Metric|Description|
|------|-----------|
|BuildDuration|Measures the duration of the build's BUILD phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended(, Maximum, Minimum|
|Builds|Measures the number of builds triggered.<br>Units: Count<br>Valid CloudWatch statistics: Sum|
|DownloadSourceDuration|Measures the duration of the build's DOWNLOAD_SOURCE phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|Duration|Measures the duration of all builds over time.<br>Units: Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|FailedBuilds|Measures the number of builds that failed because of client error or a timeout.<br>Units: Count<br>Valid CloudWatch statistics: Sum|
|FinalizingDuration|Measures the duration of the build's FINALIZING phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|InstallDuration|Measures the duration of the build's INSTALL phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|PostBuildDuration|Measures the duration of the build's POST_BUILD phase<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|PreBuildDuration|Measures the duration of the build's PRE_BUILD phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|ProvisioningDuration|Measures the duration of the build's PROVISIONING phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|QueuedDuration|Measures the duration of the build's QUEUED phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|SubmittedDuration|Measures the duration of the build's SUBMITTED phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|
|SucceededBuilds|Measures the number of successful builds.<br>Units: Count<br>Valid CloudWatch statistics: Sum|
|UploadArtifactsDuration|Measures the duration of the build's UPLOAD_ARTIFACTS phase.<br>Units:Seconds<br>Valid CloudWatch statistics: Average (recommended), Maximum, Minimum|

## Endnotes
### Endnote 1 <!-- omit in toc -->
[https://docs.aws.amazon.com/codebuild/latest/userguide/auth-and-access-control-iam-identity-based-access-control.html](https://docs.aws.amazon.com/codebuild/latest/userguide/auth-and-access-control-iam-identity-based-access-control.html)
### Endnote 2 <!-- omit in toc -->
[https://docs.aws.amazon.com/codebuild/latest/userguide/security-encryption.html](https://docs.aws.amazon.com/codebuild/latest/userguide/security-encryption.html)
### Endnote 3 <!-- omit in toc -->
[https://docs.aws.amazon.com/codebuild/latest/userguide/use-vpc-endpoints-with-codebuild.html](https://docs.aws.amazon.com/codebuild/latest/userguide/use-vpc-endpoints-with-codebuild.html)
### Endnote 4 <!-- omit in toc -->
[https://docs.aws.amazon.com/codebuild/latest/userguide/monitoring-metrics.html](https://docs.aws.amazon.com/codebuild/latest/userguide/monitoring-metrics.html)
### Endnote 5 <!-- omit in toc -->
[https://docs.aws.amazon.com/codebuild/latest/userguide/monitoring-alarms.html](https://docs.aws.amazon.com/codebuild/latest/userguide/monitoring-alarms.html)

## Capital Group Control Statements 

1. All Data-at-rest must be encrypted and use a CG BYOK encryption key.
2. All Data-in-transit must be encrypted using certificates using CG Certificate Authority.
3. Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.
4. AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch.
5. Local AWS IAM accounts are restricted to services and no user accounts are to be provisioned including IaaS resources.
6. Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.
7. Use of AWS IAM accounts are restricted to CG networks.
8. Local IAM secrets are rotated every 90 days, including accounts IaaS resources.
9. Encryption keys are rotated annually.
10. Root accounts must have 2FA/MFA enabled.