<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# AWS CodeDeploy - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1.Use CodeDeploy Identity-based policies to ensure least-privilege is enforced to create, delete, or update deployment configurations and deployment groups.](#1-use-codedeploy-identity-based-policies-to-ensure-least-privilege-is-enforced-to-create-delete-or-update-deployment-configurations-and-deployment-groups)
- [Detective](#detective)
  - [1. Audit and monitor all interactions with AWS CodeDeploy using AWS Cloudtrail](#1-Audit-and-monitor-all-interactions-with-AWS-CodeDeploy-using-AWS-Cloudtrail)
  - [2. Centrailaize and View AWS CodeDeploy logs in Amazon CloudWatch utilizing Cloudwatch Events](#2-centrailaize-and-view-aws-codedeploy-logs-in-amazon-cloudWatch-utilizing-cloudwatch-events)
- [Respond/Recover](#respondrecover)
  - [1. Utilize AWS CloudWatch alarm actions to automatically stop, terminate, reboot, or recover EC2 instances when a deployment or instance event you specify occurs](#1-utilize-aws-cloudWatch-alarm-actions-to-automatically-stop-terminate-reboot-or-recover-ec-instances-when-a-deployment-or-instance-event-you-specify-occurs)
- [Endnotes](#endnotes)

## Overview
AWS provides a number of security features for AWS CodeDeploy which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: ID, PR.AC-2, PR.AC-5, PR.AT, PR.DS-3, PR.DS-7, PR.DS-8, PR.IP (Unless Stated), PR.MA, PR.PT-2, PR.PT-3, DE.CM-2, DE.CM-6, DE.DP, RS.RP, RS.CO, RS.MI, RS.IM, RC

These Capital Group Control statements are not applicable to this service 5,7,8,9,10

## Preventative Controls
### 1. Use CodeDeploy Identity-based policies to ensure least-privilege is enforced to create, delete, or update deployment configurations and deployment groups. 
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|  
|PR.AC-6|Identities are protected and bound to credentials and asserted in interactios
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individuals’ security and privacy risks and other organizational risks)|
|PR.PT-3|The principle of least functionality is incorporated by configuring systems to provide only essential capabilities|

**Why?** With AWS COdeDeploy IAM identity-based policies, you can specify allowed or denied actions and resources and the conditions under which actions are allowed or denied.

**How?**
- CodeDeploy identity-based policies supports **Actions**, **Resources**, **Condition Keys**, and **Service Roles** 
    - **Actions** – The Action element of an IAM idenity-based policy describesd the specific actions or actions that will be allowed ot denied by the policy. Policy actions usually have the same name as the associated AWS API operation. The action is used in a policy to grant permissions to perform the associated operation. Policy statements must include an **Action** or **NotAction** element.
    For information on Actions defined by CodeDeploy, see [Endnote 1](#endnote-1).
    - **Resources** - The Resources element specifies the object or objects to which the action applies. Statements must include either a **Resources** or **NotResource** statement. 
    - **Condition Keys** - Use the availble Global Condition Keys to further refine the conditions under which a policy statement applies. 
    - **Service Roles** - The service role feature allows a service to assume a service role on your behalf. This allows service to access resources in other services to complete an action on your behalf.

# AWS CodeDeploy Identity\-Based Policy Examples<a name="security_iam_id-based-policy-examples"></a>

By default, IAM users and roles don't have permission to create or modify CodeDeploy resources\. They also can't perform tasks using the AWS Management Console, AWS CLI, or AWS API\. An IAM administrator must create IAM policies that grant users and roles permission to perform API operations on the specified resources they need\. The administrator must then attach those policies to the IAM users or groups who require those permissions\.

To learn how to create an IAM identity\-based policy using these example JSON policy documents, see [Creating Policies on the JSON Tab](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create.html#access_policies_create-json-editor) in the *IAM User Guide*\.

In CodeDeploy, identity\-based policies are used to manage permissions to the various resources related to the deployment process\. You can control access to the following resource types:
+ Applications and application revisions\.
+ Deployments\.
+ Deployment configurations\.
+ Instances and on\-premises instances\.

The capabilities controlled by resource policies vary depending on the resource type, as outlined in the following table:


****  

|  Resource types  |  Capabilities  | 
| --- | --- | 
|  All  |  View and list details about resources  | 
|  Applications Deployment configurations Deployment groups  |  Create resources Delete resources  | 
|  Deployments  |  Create deployments Stop deployments  | 
|  Application revisions  |  Register application revisions  | 
|  Applications Deployment groups  |  Update resources  | 
|  On\-premises instances  |  Add tags to instances Remove tags from instances Register instances Deregister instances  | 

The following example shows a permissions policy that allows a user to delete the deployment group named **WordPress\_DepGroup** associated with the application named **WordPress\_App** in the **us\-west\-2** Region\.

```
{
  "Version": "2012-10-17",
  "Statement" : [
    {
      "Effect" : "Allow",
      "Action" : [
        "codedeploy:DeleteDeploymentGroup"
      ],
      "Resource" : [
        "arn:aws:codedeploy:us-west-2:80398EXAMPLE:deploymentgroup:WordPress_App/WordPress_DepGroup"
      ]
    }
  ]
}
```

**Topics**
+ [AWS Managed \(Predefined\) Policies for CodeDeploy](#managed-policies)
+ [Customer\-Managed Policy Examples](#customer-managed-policies)
+ [Policy Best Practices](#security_iam_service-with-iam-policy-best-practices)
+ [Using the CodeDeploy Console](#security_iam_id-based-policy-examples-console)
+ [Allow Users to View Their Own Permissions](#security_iam_id-based-policy-examples-view-own-permissions)

## AWS Managed \(Predefined\) Policies for CodeDeploy<a name="managed-policies"></a>

AWS addresses many common use cases by providing standalone IAM policies that are created and administered by AWS\. These AWS\-managed policies grant permissions for common use cases so you can avoid having to investigate which permissions are required\. For more information, see [AWS Managed Policies](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html#aws-managed-policies) in the *IAM User Guide*\.

The following AWS managed policies, which you can attach to users in your account, are specific to CodeDeploy:
+ `AWSCodeDeployFullAccess`: Grants full access to CodeDeploy\.
**Note**  
AWSCodeDeployFullAccess does not provide permissions to operations in other services required to deploy your applications, such as Amazon EC2 and Amazon S3, only to operations specific to CodeDeploy\.
+ `AWSCodeDeployDeployerAccess`: Grants access to an IAM user to register and deploy revisions\.

   
+ `AWSCodeDeployReadOnlyAccess`: Grants read\-only access to CodeDeploy\.

   
+ `AWSCodeDeployRole`: Allows CodeDeploy to identify EC2 instances by their Amazon EC2 tags or Amazon EC2 Auto Scaling group names, and on\-premises instances by their on\-premises instance tags, and to deploy application revisions to them accordingly\. Provides permissions required to publish notifications to an Amazon SNS topic and retrieve information about alarms from CloudWatch\.

   
+ `AWSCodeDeployRoleForLambda`: Grants CodeDeploy permission to access AWS Lambda and any other resource required for a deployment\.

   
+  `AWSCodeDeployRoleForECS`: Grants CodeDeploy permission to access Amazon ECS and any other resource required for a deployment\. 

   
+  `AWSCodeDeployRoleForECSLimited`: Grants CodeDeploy permission to access Amazon ECS and any other resource required for a deployment with the following exceptions: 
  +  In the `hooks` section of the AppSpec file, only Lambda functions with names that begin with `CodeDeployHook_` can be used\. For more information, see [AppSpec 'hooks' Section for an Amazon ECS Deployment](reference-appspec-file-structure-hooks.md#appspec-hooks-ecs)\. 
  +  S3 bucket access is limited to S3 buckets with a registration tag, `UseWithCodeDeploy`, that has a value of `true`\. For more information, see [Object Tagging](https://docs.aws.amazon.com/AmazonS3/latest/dev/object-tagging.html)\. 

Permissions for some aspects of the deployment process are granted to two other role types that act on behalf of CodeDeploy, rather than to IAM users:
+ **IAM instance profile**: An IAM role that you attach to your Amazon EC2 instances\. This profile includes the permissions required to access the Amazon S3 buckets or GitHub repositories where the applications are stored\. For more information, see [Step 4: Create an IAM Instance Profile for Your Amazon EC2 Instances](getting-started-create-iam-instance-profile.md)\.
+ **Service role**: An IAM role that grants permissions to an AWS service so it can access AWS resources\. The policies you attach to the service role determine which AWS resources the service can access and the actions it can perform with those resources\. For CodeDeploy, a service role is used for the following:
  + To read either the tags applied to the instances or the Amazon EC2 Auto Scaling group names associated with the instances\. This enables CodeDeploy to identify instances to which it can deploy applications\.
  + To perform operations on instances, Amazon EC2 Auto Scaling groups, and Elastic Load Balancing load balancers\.
  + To publish information to Amazon SNS topics so that notifications can be sent when specified deployment or instance events occur\.
  + To retrieve information about CloudWatch alarms to set up alarm monitoring for deployments\.

  For more information, see [Step 3: Create a Service Role for CodeDeploy](getting-started-create-service-role.md)\.

You can also create custom IAM policies to grant permissions for CodeDeploy actions and resources\. You can attach these custom policies to the IAM users or groups who require those permissions\.

### CodeDeploy Managed Policies and Notifications<a name="notifications-permissions"></a>

CodeDeploy supports notifications to make users aware of important changes to deployments\.  Managed policies for CodeDeploy include policy statements for notification functionality\. For more information, see [What are notifications?](https://docs.aws.amazon.com/codestar-notifications/latest/userguide/welcome.html)\.

#### Permissions for Notifications in Full Access Managed Policies<a name="notifications-fullaccess"></a>

The `AWSCodeDeployFullAccess` managed policy includes the following statements to allow full access to notifications\. Users with this managed policy applied can also create and manage Amazon SNS topics for notifications, subscribe and unsubscribe users to topics, and list topics to choose as targets for notification rules\.

```
    {
        "Sid": "CodeStarNotificationsReadWriteAccess",
        "Effect": "Allow",
        "Action": [
            "codestar-notifications:CreateNotificationRule",
            "codestar-notifications:DescribeNotificationRule",
            "codestar-notifications:UpdateNotificationRule",
            "codestar-notifications:DeleteNotificationRule",
            "codestar-notifications:Subscribe",
            "codestar-notifications:Unsubscribe"
        ],
        "Resource": "*",
        "Condition" : {
            "StringLike" : {"codestar-notifications:NotificationsForResource" : "arn:aws:codedeploy:*"} 
        }
    },    
    {
        "Sid": "CodeStarNotificationsListAccess",
        "Effect": "Allow",
        "Action": [
            "codestar-notifications:ListNotificationRules",
            "codestar-notifications:ListTargets",
            "codestar-notifications:ListTagsforResource"
        ],
        "Resource": "*"
    },
    {
        "Sid": "CodeStarNotificationsSNSTopicCreateAccess",
        "Effect": "Allow",
        "Action": [
            "sns:CreateTopic",
            "sns:SetTopicAttributes"
        ],
        "Resource": "arn:aws:sns:*:*:codestar-notifications*"
    },
    {
        "Sid": "SNSTopicListAccess",
        "Effect": "Allow",
        "Action": [
            "sns:ListTopics"
        ],
        "Resource": "*"
    }
```

#### Permissions for Notifications in Read\-Only Managed Policies<a name="notifications-readonly"></a>

The `AWSCodeDeployReadOnlyAccess` managed policy includes the following statements to allow read\-only access to notifications\. Users with this managed policy applied can view notifications for resources, but cannot create, manage, or subscribe to them\. 

```
   {
        "Sid": "CodeStarNotificationsPowerUserAccess",
        "Effect": "Allow",
        "Action": [
            "codestar-notifications:DescribeNotificationRule"
        ],
        "Resource": "*",
        "Condition" : {
            "StringLike" : {"codestar-notifications:NotificationsForResource" : "arn:aws:codedeploy:*"} 
        }
    },    
    {
        "Sid": "CodeStarNotificationsListAccess",
        "Effect": "Allow",
        "Action": [
            "codestar-notifications:ListNotificationRules"
        ],
        "Resource": "*"
    }
```

For more information, see [Identity and Access Management for AWS CodeStar Notifications](https://docs.aws.amazon.com/codestar-notifications/latest/userguide/security-iam.html)\.

## Customer\-Managed Policy Examples<a name="customer-managed-policies"></a>

In this section, you can find example user policies that grant permissions for various CodeDeploy actions\. These policies work when you are using the CodeDeploy API, AWS SDKs, or the AWS CLI\. You must grant additional permissions for actions you perform in the console\. To learn more about granting console permissions, see [Using the CodeDeploy Console](#security_iam_id-based-policy-examples-console) \.

**Note**  
All examples use the US West \(Oregon\) Region \(`us-west-2`\) and contain fictitious account IDs\.

 **Examples**
+ [Example 1: Allow a User to Perform CodeDeploy Operations in a Single Region](#identity-based-policies-example-1)
+ [Example 2: Allow a User to Register Revisions for a Single Application](#identity-based-policies-example-2)
+ [Example 3: Allow a User to Create Deployments for a Single Deployment Group](#identity-based-policies-example-3)

### Example 1: Allow a User to Perform CodeDeploy Operations in a Single Region<a name="identity-based-policies-example-1"></a>

The following example grants permissions to perform CodeDeploy operations in the **us\-west\-2** Region only:

```
{
  "Version": "2012-10-17",
  "Statement" : [
    {
      "Effect" : "Allow",
      "Action" : [
        "codedeploy:*"
      ],
      "Resource" : [
        "arn:aws:codedeploy:us-west-2:80398EXAMPLE:*"
      ]
    }
  ]
}
```

### Example 2: Allow a User to Register Revisions for a Single Application<a name="identity-based-policies-example-2"></a>

The following example grants permissions to register application revisions for all applications that begin with **Test** in the **us\-west\-2** Region:

```
{
  "Version": "2012-10-17",
  "Statement" : [
    {
      "Effect" : "Allow",
      "Action" : [
        "codedeploy:RegisterApplicationRevision"
      ],
      "Resource" : [
        "arn:aws:codedeploy:us-west-2:80398EXAMPLE:application:Test*"
      ]
    }
  ]
}
```

### Example 3: Allow a User to Create Deployments for a Single Deployment Group<a name="identity-based-policies-example-3"></a>

The following example allows the specified user to create deployments for the deployment group named **WordPress\_DepGroup** associated with the application named **WordPress\_App**, the custom deployment configuration named **ThreeQuartersHealthy**, and any application revisions associated with the application named **WordPress\_App**\. All of these resources are in the **us\-west\-2** Region\.

```
{
  "Version": "2012-10-17",
  "Statement" : [
    {
      "Effect" : "Allow",
      "Action" : [
        "codedeploy:CreateDeployment"
      ],
      "Resource" : [
        "arn:aws:codedeploy:us-west-2:80398EXAMPLE:deploymentgroup:WordPress_App/WordPress_DepGroup"
      ]
    },
    {
      "Effect" : "Allow",
      "Action" : [
        "codedeploy:GetDeploymentConfig"
      ],
      "Resource" : [
        "arn:aws:codedeploy:us-west-2:80398EXAMPLE:deploymentconfig:ThreeQuartersHealthy"
      ]
    },
    {
      "Effect" : "Allow",
      "Action" : [
        "codedeploy:GetApplicationRevision"
      ],
      "Resource" : [
        "arn:aws:codedeploy:us-west-2:80398EXAMPLE:application:WordPress_App"
      ]
    }
  ]
}
```

## Policy Best Practices<a name="security_iam_service-with-iam-policy-best-practices"></a>

Identity\-based policies are very powerful\. They determine whether someone can create, access, or delete CodeDeploy resources in your account\. These actions can incur costs for your AWS account\. When you create or edit identity\-based policies, follow these guidelines and recommendations:
+ **Get Started Using AWS Managed Policies** – To start using CodeDeploy quickly, use AWS managed policies to give your employees the permissions they need\. These policies are already available in your account and are maintained and updated by AWS\. For more information, see [Get Started Using Permissions With AWS Managed Policies](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#bp-use-aws-defined-policies) in the *IAM User Guide*\.
+ **Grant Least Privilege** – When you create custom policies, grant only the permissions required to perform a task\. Start with a minimum set of permissions and grant additional permissions as necessary\. Doing so is more secure than starting with permissions that are too lenient and then trying to tighten them later\. For more information, see [Grant Least Privilege](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege) in the *IAM User Guide*\.
+ **Enable MFA for Sensitive Operations** – For extra security, require IAM users to use multi\-factor authentication \(MFA\) to access sensitive resources or API operations\. For more information, see [Using Multi\-Factor Authentication \(MFA\) in AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html) in the *IAM User Guide*\.
+ **Use Policy Conditions for Extra Security** – To the extent that it's practical, define the conditions under which your identity\-based policies allow access to a resource\. For example, you can write conditions to specify a range of allowable IP addresses that a request must come from\. You can also write conditions to allow requests only within a specified date or time range, or to require the use of SSL or MFA\. For more information, see [IAM JSON Policy Elements: Condition](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition.html) in the *IAM User Guide*\.

## Using the CodeDeploy Console<a name="security_iam_id-based-policy-examples-console"></a>

If you use the CodeDeploy console, you must have a minimum set of permissions that allows you to describe other AWS resources for your AWS account\. To use CodeDeploy in the CodeDeploy console, you must have permissions from the following services:
+ Amazon EC2 Auto Scaling
+ AWS CodeDeploy
+ Amazon Elastic Compute Cloud
+ Elastic Load Balancing
+ AWS Identity and Access Management
+ Amazon Simple Storage Service
+ Amazon Simple Notification Service
+ Amazon CloudWatch

If you create an IAM policy that is more restrictive than the minimum required permissions, the console won't function as intended for users with that IAM policy\. To ensure that those users can still use the CodeDeploy console, also attach the `AWSCodeDeployReadOnlyAccess` managed policy to the user, as described in [AWS Managed \(Predefined\) Policies for CodeDeploy](#managed-policies)\.

You don't need to allow minimum console permissions for users who are making calls only to the AWS CLI or the CodeDeploy API\.

## Allow Users to View Their Own Permissions<a name="security_iam_id-based-policy-examples-view-own-permissions"></a>

This example shows how you might create a policy that allows IAM users to view the inline and managed policies that are attached to their user identity\. This policy includes permissions to complete this action on the console or programmatically using the AWS CLI or AWS API\.

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ViewOwnUserInfo",
            "Effect": "Allow",
            "Action": [
                "iam:GetUserPolicy",
                "iam:ListGroupsForUser",
                  "iam:ListAttachedUserPolicies",
                "iam:ListUserPolicies",
                "iam:GetUser"
            ],
            "Resource": ["arn:aws:iam::*:user/${aws:username}"]
        },
        {
            "Sid": "NavigateInConsole",
            "Effect": "Allow",
            "Action": [
                "iam:GetGroupPolicy",
                "iam:GetPolicyVersion",
                "iam:GetPolicy",
                "iam:ListAttachedGroupPolicies",
                "iam:ListGroupPolicies",
                "iam:ListPolicyVersions",
                "iam:ListPolicies",
                "iam:ListUsers"
            ],
            "Resource": "*"
        }
    ]
}
```

# CodeDeploy Permissions Reference<a name="auth-and-access-control-permissions-reference"></a>

Use the following table when you are setting up access and writing permissions policies that you can attach to an IAM identity \(identity\-based policies\)\. The table lists each CodeDeploy API operation, the actions for which you can grant permissions to perform the action, and the format of the resource ARN to use for granting permissions\. You specify the actions in the policy's `Action` field\. You specify an ARN, with or without a wildcard character \(\*\), as the resource value in the policy's `Resource` field\.

You can use AWS\-wide condition keys in your CodeDeploy policies to express conditions\. For a complete list of AWS\-wide keys, see [Available Keys](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#AvailableKeys) in the *IAM User Guide*\.

To specify an action, use the `codedeploy:` prefix followed by the API operation name \(for example, `codedeploy:GetApplication` and `codedeploy:CreateApplication`\)\. To specify multiple actions in a single statement, separate them with commas \(for example, `"Action": ["codedeploy:action1", "codedeploy:action2"]`\)\.

**Using Wildcard Characters**

You can use a wildcard character \(\*\) in your ARN to specify multiple actions or resources\. For example, `codedeploy:*` specifies all CodeDeploy actions and `codedeploy:Get*` specifies all CodeDeploy actions that begin with the word `Get`\. The following example grants access to all deployment groups with names that begin with `West` and are associated with applications that have names beginning with `Test`\. 

```
arn:aws:codedeploy:us-west-2:80398EXAMPLE:deploymentgroup:Test*/West*
```

You can use wildcards with the following resources listed in the table:
+ *application\-name*
+ *deployment\-group\-name*
+ *deployment\-configuration\-name*
+ *instance\-ID*

Wildcards can't be used with *region* or *account\-id*\. For more information about wildcards, see [IAM Identifiers](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html) in *IAM User Guide*\. 

**Note**  
 In the ARN for each action, a colon \(:\) follows the resource\. You can also follow the resource with a forward slash \(/\)\. For more information, see [CodeDeploy Example ARNs](https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html#arn-syntax-codedeploy)\. 

Use the scroll bars to see the rest of the table\.


**CodeDeploy API Operations and Required Permissions for Actions**  

| CodeDeploy API Operations | Required Permissions \(API Actions\) | Resources | 
| --- | --- | --- | 
|  [AddTagsToOnPremisesInstances](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_AddTagsToOnPremisesInstances.html)  |  `codedeploy:AddTagsToOnPremisesInstances` Required to add tags to one or more on\-premises instances\.  |  arn:aws:codedeploy:*region*:*account\-id*:instance:*instance\-ID*  | 
|  [BatchGetApplicationRevisions](https://docs.aws.amazon.com/codedeploy/latest/APIReference/BatchGetApplicationRevisions.html)  |  `codedeploy:BatchGetApplicationRevisions` Required to get information about multiple application revisions associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:*application\-name*  | 
|  [BatchGetApplications](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_BatchGetApplications.html)  |  `codedeploy:BatchGetApplications` Required to get information about multiple applications associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:\*  | 
| [BatchGetDeploymentGroups](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_BatchGetDeploymentGroups.html) |  `codedeploy:BatchGetDeploymentGroups` Required to get information about multiple deployment groups associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
| [BatchGetDeploymentInstances](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_BatchGetDeploymentInstances.html) | codedeploy:BatchGetDeploymentInstancesRequired to get information about one or more instance in a deployment group\. |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [BatchGetDeployments](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_BatchGetDeployments.html)  |  `codedeploy:BatchGetDeployments` Required to get information about multiple deployments associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [BatchGetOnPremisesInstances](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_BatchGetOnPremisesInstances.html)  |  `codedeploy:BatchGetOnPremisesInstances` Required to get information about one or more on\-premises instances\.  |  arn:aws:codedeploy:*region*:*account\-id*:\*  | 
|  [ContinueDeployment](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ContinueDeployment.html)  |  `codedeploy:ContinueDeployment` Required during a blue/green deployment to start the process of registering instances in a replacement environment with an Elastic Load Balancing load balancer\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [CreateApplication](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_CreateApplication.html)  |  `codedeploy:CreateApplication` Required to create an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:*application\-name*  | 
|  [CreateDeployment](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_CreateDeployment.html) ¹  |  `codedeploy:CreateDeployment` Required to create a deployment for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [CreateDeploymentConfig](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_CreateDeploymentConfig.html)  |  `codedeploy:CreateDeploymentConfig` Required to create a custom deployment configuration associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentconfig:*deployment\-configuration\-name*   | 
|  [CreateDeploymentGroup](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_CreateDeploymentGroup.html)  |  `codedeploy:CreateDeploymentGroup` Required to create a deployment group for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [DeleteApplication](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_DeleteApplication.html)  |  `codedeploy:DeleteApplication` Required to delete an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:*application\-name*  | 
|  [DeleteDeploymentConfig](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_DeleteDeploymentConfig.html)  |  `codedeploy:DeleteDeploymentConfig` Required to delete a custom deployment configuration associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentconfig:*deployment\-configuration\-name*   | 
|  [DeleteDeploymentGroup](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_DeleteDeploymentGroup.html)  |  `codedeploy:DeleteDeploymentGroup` Required to delete a deployment group for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [DeregisterOnPremisesInstance](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_DeregisterOnPremisesInstance.html)  |  `codedeploy:DeregisterOnPremisesInstance` Required to deregister an on\-premises instance\.  |  arn:aws:codedeploy:*region*:*account\-id*:instance:*instance\-ID*  | 
|  [GetApplication](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_GetApplication.html)  |  `codedeploy:GetApplication` Required to get information about a single application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:*application\-name*  | 
|  [GetApplicationRevision](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_GetApplicationRevision.html)  |  `codedeploy:GetApplicationRevision` Required to get information about a single application revision for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:*application\-name*  | 
|  [GetDeployment](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_GetDeployment.html)  |  `codedeploy:GetDeployment` Required to get information about a single deployment to a deployment group for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [GetDeploymentConfig](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_GetDeploymentConfig.html)  |  `codedeploy:GetDeploymentConfig` Required to get information about a single deployment configuration associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentconfig:*deployment\-configuration\-name*   | 
|  [GetDeploymentGroup](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_GetDeploymentGroup.html)  |  `codedeploy:GetDeploymentGroup` Required to get information about a single deployment group for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [GetDeploymentInstance](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_GetDeploymentInstance.html)  |  `codedeploy:GetDeploymentInstance` Required to get information about a single instance in a deployment associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [GetDeploymentTarget](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_GetDeploymentTarget.html)  |  `codedeploy:GetDeploymentTarget` Required to get information about a target in a deployment associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [GetOnPremisesInstance](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_GetOnPremisesInstance.html)  |  `codedeploy:GetOnPremisesInstance` Required to get information about a single on\-premises instance\.  |  arn:aws:codedeploy:*region*:*account\-id*:instance:*instance\-ID*  | 
|  [ListApplicationRevisions](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListApplicationRevisions.html)  |  `codedeploy:ListApplicationRevisions` Required to get information about all application revisions for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:\*  | 
|  [ListApplications](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListApplications.html)  |  `codedeploy:ListApplications` Required to get information about all applications associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:\*  | 
|  [ListDeploymentConfigs](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListDeploymentConfigs.html)  |  `codedeploy:ListDeploymentConfigs` Required to get information about all deployment configurations associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentconfig:\*  | 
|  [ListDeploymentGroups](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListDeploymentGroups.html)  |  `codedeploy:ListDeploymentGroups` Required to get information about all deployment groups for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/\*  | 
|  [ListDeploymentInstances](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListDeploymentInstances.html)  |  `codedeploy:ListDeploymentInstances` Required to get information about all instances in a deployment associated with the IAM user or AWS account\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [ListDeployments](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListDeployments.html)  |  `codedeploy:ListDeployments` Required to get information about all deployments to a deployment group associated with the IAM user, or to get all deployments associated with the IAM user or AWS account\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [ListDeploymentTargets](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListDeploymentTargets.html)  |  `codedeploy:ListDeploymentTargets` Required to get information about all targets in a deployment associated with the IAM user or AWS account\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [ListGitHubAccountTokenNames](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListGitHubAccountTokenNames.html)  |  `codedeploy:ListGitHubAccountTokenNames` Required to get a list of the names of stored connections to GitHub accounts\.   |  arn:aws:codedeploy:*region*:*account\-id*:\*  | 
|  [ListOnPremisesInstances](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_ListOnPremisesInstances.html)  |  `codedeploy:ListOnPremisesInstances` Required to get a list of one or more on\-premises instance names\.  |  arn:aws:codedeploy:*region*:*account\-id*:\*  | 
|  PutLifecycleEventHookExecutionStatus  |  `codedeploy:PutLifecycleEventHookExecutionStatus` Required to provide notification of the status of the execution of a lifecycle hook event\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [RegisterApplicationRevision](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_RegisterApplicationRevision.html)  |  `codedeploy:RegisterApplicationRevision` Required to register information about an application revision for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:*application\-name*  | 
|  [RegisterOnPremisesInstance](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_RegisterOnPremisesInstance.html)  |  `codedeploy:RegisterOnPremisesInstance` Required to register an on\-premises instance with CodeDeploy\.  |  arn:aws:codedeploy:*region*:*account\-id*:instance:*instance\-ID*  | 
|  [RemoveTagsFromOnPremisesInstances](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_RemoveTagsFromOnPremisesInstances.html)  |  `codedeploy:RemoveTagsFromOnPremisesInstances` Required to remove tags from one or more on\-premises instances\.  |  arn:aws:codedeploy:*region*:*account\-id*:instance:*instance\-ID*  | 
|  [SkipWaitTimeForInstanceTermination](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_SkipWaitTimeForInstanceTermination.html)  |  `codedeploy:SkipWaitTimeForInstanceTermination` Required in a blue/green deployment to override a specified wait time and start terminating instances in the original environment immediately\.  |  arn:aws:codedeploy:*region*:*account\-id*:instance:*instance\-ID*  | 
|  [StopDeployment](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_StopDeployment.html)  |  `codedeploy:StopDeployment` Required to stop an in\-progress deployment to a deployment group for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  [UpdateApplication](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_UpdateApplication.html) ³  |  `codedeploy:UpdateApplication` Required to change information about an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:application:*application\-name*  | 
|  [UpdateDeploymentGroup](https://docs.aws.amazon.com/codedeploy/latest/APIReference/API_UpdateDeploymentGroup.html) ³  |  `codedeploy:UpdateDeploymentGroup` Required to change information about a single deployment group for an application associated with the IAM user\.  |  arn:aws:codedeploy:*region*:*account\-id*:deploymentgroup:*application\-name*/*deployment\-group\-name*  | 
|  ¹ When you specify `CreateDeployment` permissions, you must also specify `GetDeploymentConfig` permissions for the deployment configuration and `GetApplicationRevision` or `RegisterApplicationRevision` permissions for the application revision\.  ² Valid for `ListDeployments` when providing a specific deployment group, but not when listing all of the deployments associated with the IAM user\. ³ For `UpdateApplication`, you must have `UpdateApplication` permissions for both the old and new application names\. For `UpdateDeploymentGroup` actions that involve changing a deployment group's name, you must have `UpdateDeploymentGroup` permissions for both the old and new deployment group names\.   | 

For more information on IAM identity-based policies for CodeDeploy, including examples, see [Endnote 2](#endnote-2).


## Detective

### 1. Audit and monitor all interactions with AWS CodeDeploy using AWS Cloudtrail 
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|  

**Why?** Using the information collected by CloudTrail, you can determine which request was made to CodeDeploy, the source IP address from which the request was made, who made the request, when it was made, and so on.

**How?** CodeDeploy is integrated with AWS CloudTrail, a service that captures API calls made by or on behalf of CodeDeploy in your AWS account and delivers the log files to an S3 bucket you specify. CloudTrail captures API calls from the CodeDeploy console, from CodeDeploy commands through the AWS CLI, or from the CodeDeploy APIs directly.

# Creating a Trail<a name="cloudtrail-create-a-trail-using-the-console-first-time"></a>

Follow the procedure to create a trail that applies to all Regions\. A trail that applies to all Regions delivers log files from all Regions to an S3 bucket\. After you create the trail, CloudTrail automatically starts logging the events that you specified\. 

**Note**  
After you create a trail, you can configure other AWS services to further analyze and act upon the event data collected in CloudTrail logs\. For more information, see [CloudTrail Supported Services and Integrations](cloudtrail-aws-service-specific-topics.md)\.

**Contents**
+ [Creating a Trail in the Console](#creating-a-trail-in-the-console)
+ [Configuring Advanced Settings for Your Trail](#advanced-settings-for-your-trail)
+ [Next Steps](#cloudtrail-create-a-trail-using-the-console-first-time-next-steps)

## Creating a Trail in the Console<a name="creating-a-trail-in-the-console"></a>

 You can configure your trail for the following: 
+ Specify if you want the trail to apply to all Regions or a single Region\.
+ Specify an Amazon S3 bucket to receive log files\.
+ For management and data events, specify if you want to log read\-only, write\-only, or all events\.

**To create a CloudTrail trail with the AWS Management Console**

1. Sign in to the AWS Management Console and open the CloudTrail console at [https://console\.aws\.amazon\.com/cloudtrail/](https://console.aws.amazon.com/cloudtrail/)\.

1. Choose the AWS Region where you want the trail to be created\.

1. Choose **Get Started Now**\.
**Tip**  
If you do not see **Get Started Now**, choose **Trails**, and then choose **Create trail**\.

1. On the **Create Trail** page, for **Trail name**, type a name for your trail\. For more information, see [CloudTrail Trail Naming Requirements](cloudtrail-trail-naming-requirements.md)\.

1. For **Apply trail to all regions**, choose **Yes** to receive log files from all Regions\. This is the default and recommended setting\. If you choose **No**, the trail logs files only from the Region in which you create the trail\.

1. For **Management events**, do the following\.

   1. For **Read/Write events**, choose if you want your trail to log **All**, **Read\-only**, **Write\-only**, or **None**, and then choose **Save**\. By default, trails log all management events\. For more information, see [Management Events](logging-management-events-with-cloudtrail.md#logging-management-events)\.

   1. For **Log AWS KMS events**, choose **Yes** to log AWS Key Management Service \(AWS KMS\) events in your trail\. Choose **No** to filter AWS KMS events out of your trail\. The default setting is **Yes**\.

1. In **Insights events**, for **Log Insights events**, choose **Yes** if you want your trail to log Insights events\. By default, trails don't log Insights events\. For more information about Insights events, see [Logging Insights Events for Trails](logging-insights-events-with-cloudtrail.md)\. Additional charges apply for logging Insights events\. For CloudTrail pricing, see [AWS CloudTrail Pricing](https://aws.amazon.com/cloudtrail/pricing/)\.

   Insights events are delivered to a different folder named `/CloudTrail-Insight`of the same S3 bucket that is specified in the **Storage location** area of the trail details page\. CloudTrail creates the new prefix for you\. For example, if your current destination S3 bucket is named `S3bucketName/AWSLogs/CloudTrail/`, the S3 bucket name with a new prefix is named `S3bucketName/AWSLogs/CloudTrail-Insight/`\.

1. For **Data events**, you can specify logging data events for Amazon S3 buckets, for AWS Lambda functions, or both\. By default, trails don't log data events\. Additional charges apply for logging data events\. For CloudTrail pricing, see [AWS CloudTrail Pricing](https://aws.amazon.com/cloudtrail/pricing/)\.

   You can select the option to log all S3 buckets and Lambda functions, or you can specify individual buckets or functions\. 

   For Amazon S3 buckets:
   + Choose the **S3** tab\.
   + To specify a bucket, choose **Add S3 bucket**\. Type the S3 bucket name and prefix \(optional\) for which you want to log data events\. For each bucket, specify whether you want to log **Read** events, such as `GetObject`, **Write** events, such as `PutObject`, or both\. For more information, see [Data Events](logging-data-events-with-cloudtrail.md#logging-data-events)\.
   + To log data events for all S3 buckets in your AWS account, select **Select all S3 buckets in your account**\. Then choose whether you want to log **Read** events, such as `GetObject`, **Write** events, such as `PutObject`, or both\. This setting takes precedence over individual settings you configure for individual buckets\. For example, if you specify logging **Read** events for all S3 buckets, and then choose to add a specific bucket for data event logging, **Read** is already selected for the bucket you added\. You cannot clear the selection\. You can only configure the option for **Write**\. 
**Note**  
Selecting the **Select all S3 buckets in your account** option enables data event logging for all buckets currently in your AWS account and any buckets you create after you finish creating the trail\. It also enables logging of data event activity performed by any user or role in your AWS account, even if that activity is performed on a bucket that belongs to another AWS account\.  
If the trail applies only to one Region, selecting the **Select all S3 buckets in your account** option enables data event logging for all buckets in the same Region as your trail and any buckets you create later in that Region\. It will not log data events for Amazon S3 buckets in other Regions in your AWS account\.

   For Lambda functions:
   + Choose the **Lambda** tab\.
   + To specify logging individual functions, select them from the list\. 
**Note**  
If you have more than 15,000 Lambda functions in your account, you cannot view or select all functions in the CloudTrail console when creating a trail\. You can still select the option to log all functions, even if they are not displayed\. If you want to log data events for specific functions, you can manually add a function if you know its ARN\. You can also finish creating the trail in the console, and then use the AWS CLI and the put\-event\-selectors command to configure data event logging for specific Lambda functions\. For more information, see [Managing Trails With the AWS CLI](cloudtrail-additional-cli-commands.md)\.
   + To log data events for all Lambda functions in your AWS account, select **Log all current and future functions**\. This setting takes precedence over individual settings you configure for individual functions\. All functions are logged, even if all functions are not displayed\.
**Note**  
If you are creating a trail for all Regions, this selection enables data event logging for all functions currently in your AWS account, and any Lambda functions you might create in any Region after you finish creating the trail\. If you are creating a trail for a single Region, this selection enables data event logging for all functions currently in that Region in your AWS account, and any Lambda functions you might create in that Region after you finish creating the trail\. It does not enable data event logging for Lambda functions created in other Regions\.  
Logging data events for all functions also enables logging of data event activity performed by any user or role in your AWS account, even if that activity is performed on a function that belongs to another AWS account\.

1. For **Storage location**, for **Create a new S3 bucket**, choose **Yes** to create a bucket\. When you create a bucket, CloudTrail creates and applies the required bucket policies\.
**Note**  
If you chose **No**, choose an existing S3 bucket\. The bucket policy must grant CloudTrail permission to write to it\. For information about manually editing the bucket policy, see [Amazon S3 Bucket Policy for CloudTrail](create-s3-bucket-policy-for-cloudtrail.md)\.

1. For **S3 bucket**, type a name for the bucket you want to designate for log file storage\. The name must be globally unique\. For more information, see [Amazon S3 Bucket Naming Requirements](cloudtrail-s3-bucket-naming-requirements.md)\.

1. For **Tags**, add one or more custom tags \(key\-value pairs\) to your trail\. Tags can help you identify both your CloudTrail trails and the Amazon S3 buckets that contain CloudTrail log files\. You can then use resource groups for your CloudTrail resources\. For more information, see [AWS Resource Groups](https://docs.aws.amazon.com/ARG/latest/userguide/welcome.html) and [Why Use Tags For Trails?](cloudtrail-concepts.md#cloudtrail-concepts-tags)\.

1. To configure advanced settings, see [Configuring Advanced Settings for Your Trail](#advanced-settings-for-your-trail)\. Otherwise, choose **Create**\.

1. The new trail appears on the **Trails** page\. The **Trails** page shows the trails in your account from all Regions\. In about 15 minutes, CloudTrail publishes log files that show the AWS API calls made in your account\. You can see the log files in the S3 bucket that you specified\. It can take up to 36 hours for CloudTrail to deliver the first Insights event, if you have enabled Insights event logging, and unusual activity is detected\.

**Note**  
You can't rename a trail after it has been created\. Instead, you can delete the trail and create a new one\.

## Configuring Advanced Settings for Your Trail<a name="advanced-settings-for-your-trail"></a>

You can configure the following settings for your trail:
+ Specify a log file prefix for the S3 bucket receiving log files\.
+ Encrypt log files with AWS Key Management Service \(SSE\-KMS\) instead of the default encryption \([Amazon S3\-managed encryption keys \(SSE\-S3\)\)](https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingServerSideEncryption.html)\.
+ Enable log file validation for logs\.
+ Configure Amazon SNS to notify you when log files are delivered\.

**To configure advanced settings for your trail**

1. For **Storage location**, choose **Advanced**\.

1. In the **Log file prefix** field, type a prefix for your Amazon S3 bucket\. The prefix is an addition to the URL for an Amazon S3 object that creates a folder\-like organization in your bucket\. The location where your log files will be stored appears under the text field\.

1. For **Encrypt log files with SSE\-KMS**, choose **Yes** if you want to encrypt your log files with SSE\-KMS instead of SSE\-S3\.

1. For **Create a new KMS key**, choose **Yes** to create an AWS KMS customer master key or **No** to use an existing one\.

1. If you chose **Yes**, in the **KMS key** field, type an alias\. CloudTrail encrypts your log files with the field, type an alias\. CloudTrail encrypts your log files with the customer master key and adds the policy for you\.
**Note**  
If you chose **No**, choose an existing AWS KMS customer master key\. You can also type the ARN of a key from another account\. For more information, see [Updating a Trail to Use Your CMK](create-kms-key-policy-for-cloudtrail-update-trail.md)\. The key policy must allow CloudTrail to use the key to encrypt your log files, and allow the users you specify to read log files in unencrypted form\. For information about manually editing the key policy, see [Configure AWS KMS Key Policies for CloudTrail](create-kms-key-policy-for-cloudtrail.md)\.

1. For **Enable log file validation**, choose **Yes** to have log digests delivered to your S3 bucket\. You can use the digest files to verify that your log files did not change after CloudTrail delivered them\. For more information, see [Validating CloudTrail Log File Integrity](cloudtrail-log-file-validation-intro.md)\. 

1. For **Send SNS notification for every log file delivery**, choose **Yes** if you want to be notified each time a log is delivered to your bucket\. CloudTrail stores multiple events in a log file\. SNS notifications are sent for every log file, not for every event\. 

1. For **Create a new SNS topic**, choose **Yes** to create a topic, or choose **No** to use an existing topic\. If you are creating a trail that applies to all Regions, SNS notifications for log file deliveries from all Regions are sent to the single SNS topic that you create\.
**Note**  
If you chose **No**, choose an existing topic\. You can also enter the ARN of a topic from another Region or from an account with appropriate permissions\. For more information, see [Amazon SNS Topic Policy for CloudTrail](cloudtrail-permissions-for-sns-notifications.md)\.

1. If you chose **Yes**, in the **SNS topic** field, type a name\.

   If you create a topic, you must subscribe to the topic to be notified of log file delivery\. You can subscribe from the Amazon SNS console\. Due to the frequency of notifications, we recommend that you configure the subscription to use an Amazon SQS queue to handle notifications programmatically\. For more information, see the [Amazon Simple Notification Service Getting Started Guide](https://docs.aws.amazon.com/sns/latest/gsg/)\.

1. Choose **Create**\.

## Next Steps<a name="cloudtrail-create-a-trail-using-the-console-first-time-next-steps"></a>

After you create your trail, you can return to the trail to make changes:
+ Configure CloudTrail to send log files to CloudWatch Logs\. For more information, see [Sending Events to CloudWatch Logs](send-cloudtrail-events-to-cloudwatch-logs.md)\.
+ Create a table and use it to run a query in Amazon Athena to analyze your AWS service activity\. For more information, see [Creating a Table for CloudTrail Logs in the CloudTrail Console](https://docs.aws.amazon.com/athena/latest/ug/cloudtrail-logs.html#create-cloudtrail-table-ct) in the [Amazon Athena User Guide](https://docs.aws.amazon.com/athena/latest/ug/)\.
+ Add custom tags \(key\-value pairs\) to the trail\.
+ To create another trail, return to the **Trails** page and choose **Add new trail**\.

**Note**  
When configuring a trail, you can choose an S3 bucket and SNS topic that belong to another account\. However, if you want CloudTrail to deliver events to a CloudWatch Logs log group, you must choose a log group that exists in your current account\.

## CodeDeploy Information in CloudTrail<a name="service-name-info-in-cloudtrail"></a>

When CloudTrail logging is enabled in your AWS account, API calls made to CodeDeploy actions are tracked in log files\. CodeDeploy records are written together with other AWS service records in a log file\. CloudTrail determines when to create and write to a new file based on a time period and file size\.

All of the CodeDeploy actions are logged and documented in the [AWS CodeDeploy Command Line Reference](https://docs.aws.amazon.com/cli/latest/reference/deploy/index.html) and the [AWS CodeDeploy API Reference](https://docs.aws.amazon.com/codedeploy/latest/APIReference/)\. For example, calls to create deployments, delete applications, and register application revisions generate entries in CloudTrail log files\. 

Every log entry contains information about who generated the request\. The user identity information in the log helps you determine whether the request was made with root or IAM user credentials, with temporary security credentials for a role or federated user, or by another AWS service\. For more information, see the **userIdentity** field in the [CloudTrail Event Reference](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/event_reference_top_level.html)\.

You can store your log files in your bucket for as long as you want, but you can also define Amazon S3 lifecycle rules to archive or delete log files automatically\. By default, Amazon S3 server\-side encryption \(SSE\) is used to encrypt your log files\.

You can have CloudTrail publish Amazon SNS notifications when new log files are delivered\. For more information, see [Configuring Amazon SNS Notifications for CloudTrail](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/getting_notifications_top_level.html)\.

You can also aggregate CodeDeploy log files from multiple AWS regions and multiple AWS accounts into a single Amazon S3 bucket\. For more information, see [Receiving CloudTrail Log Files from Multiple Regions](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/aggregating_logs_top_level.html)\.

## Understanding CodeDeploy Log File Entries<a name="understanding-service-name-entries"></a>

CloudTrail log files can contain one or more log entries where each entry is made up of multiple JSON\-formatted events\. A log entry represents a single request from any source and includes information about the requested action, any parameters, the date and time of the action, and so on\. The log entries are not guaranteed to be in any particular order\. That is, they are not an ordered stack trace of the public API calls\.

The following example shows a CloudTrail log entry that demonstrates the CodeDeploy create deployment group action:

```
{
	"Records": [{
		"eventVersion": "1.02",
		"userIdentity": {
			"type": "AssumedRole",
			"principalId": "AKIAI44QH8DHBEXAMPLE:203.0.113.11",
			"arn": "arn:aws:sts::123456789012:assumed-role/example-role/203.0.113.11",
			"accountId": "123456789012",
			"accessKeyId": "AKIAIOSFODNN7EXAMPLE",
			"sessionContext": {
				"attributes": {
					"mfaAuthenticated": "false",
					"creationDate": "2014-11-27T03:57:36Z"
				},
				"sessionIssuer": {
					"type": "Role",
					"principalId": "AKIAI44QH8DHBEXAMPLE",
					"arn": "arn:aws:iam::123456789012:role/example-role",
					"accountId": "123456789012",
					"userName": "example-role"
				}
			}
		},
		"eventTime": "2014-11-27T03:57:36Z",
		"eventSource": "codedeploy.amazonaws.com",
		"eventName": "CreateDeploymentGroup",
		"awsRegion": "us-west-2",
		"sourceIPAddress": "203.0.113.11",
		"userAgent": "example-user-agent-string",
		"requestParameters": {
			"applicationName": "ExampleApplication",
			"serviceRoleArn": "arn:aws:iam::123456789012:role/example-instance-group-role",
			"deploymentGroupName": "ExampleDeploymentGroup",
			"ec2TagFilters": [{
                "value": "CodeDeployDemo",
				"type": "KEY_AND_VALUE",
				"key": "Name"
            }],
            "deploymentConfigName": "CodeDeployDefault.HalfAtATime"
		},
		"responseElements": {
			"deploymentGroupId": "7d64e680-e6f4-4c07-b10a-9e117EXAMPLE"
		},
		"requestID": "86168559-75e9-11e4-8cf8-75d18EXAMPLE",
		"eventID": "832b82d5-d474-44e8-a51d-093ccEXAMPLE",
		"eventType": "AwsApiCall",
		"recipientAccountId": "123456789012"
	},
    ... additional entries ...
    ]
}
```

# Sending Events to CloudWatch Logs<a name="send-cloudtrail-events-to-cloudwatch-logs"></a>

When you configure your trail to send events to CloudWatch Logs, CloudTrail sends only the events that match your trail settings\. For example, if you configure your trail to log data events only, your trail sends data events only to your CloudWatch Logs log group\. CloudTrail supports sending data, Insights, and management events to CloudWatch Logs\. For more information, see [Working with CloudTrail Log Files](cloudtrail-working-with-log-files.md)\.

To send events to a CloudWatch Logs log group:
+ Make sure you have sufficient permissions to create or specify an IAM role\. For more information, see [Granting Permission to View and Configure Amazon CloudWatch Logs Information on the CloudTrail Console](security_iam_id-based-policy-examples.md#grant-cloudwatch-permissions-for-cloudtrail-users)\.
+ Create a new trail or specify an existing one\. For more information, see [Creating and Updating a Trail with the Console](cloudtrail-create-and-update-a-trail-by-using-the-console.md)\.
+ Create a log group or specify an existing one\.
+ Specify an IAM role\. If you are modifying an existing IAM role for an organization trail, you must manually update the policy to allow logging for the organization trail\. For more information, see [this policy example](#policy-cwl-org) and [Creating a Trail for an Organization](creating-trail-organization.md)\.
+ Attach a role policy or use the default\.

**Contents**
+ [Configuring CloudWatch Logs Monitoring with the Console](#send-cloudtrail-events-to-cloudwatch-logs-console)
  + [Creating a Log Group or Specifying an Existing Log Group](#send-cloudtrail-events-to-cloudwatch-logs-console-create-log-group)
  + [Specifying an IAM Role](#send-cloudtrail-events-to-cloudwatch-logs-console-create-role)
  + [Viewing Events in the CloudWatch Console](#viewing-events-in-cloudwatch)
+ [Configuring CloudWatch Logs Monitoring with the AWS CLI](#send-cloudtrail-events-to-cloudwatch-logs-cli)
  + [Creating a Log Group](#send-cloudtrail-events-to-cloudwatch-logs-cli-create-log-group)
  + [Creating a Role](#send-cloudtrail-events-to-cloudwatch-logs-cli-create-role)
  + [Creating a Policy Document](#send-cloudtrail-events-to-cloudwatch-logs-cli-create-policy-document)
  + [Updating the Trail](#send-cloudtrail-events-to-cloudwatch-logs-cli-update-trail)
+ [Limitation](#send-cloudtrail-events-to-cloudwatch-logs-limitations)

## Configuring CloudWatch Logs Monitoring with the Console<a name="send-cloudtrail-events-to-cloudwatch-logs-console"></a>

You can use the AWS Management Console to configure your trail to send events to CloudWatch Logs for monitoring\.

### Creating a Log Group or Specifying an Existing Log Group<a name="send-cloudtrail-events-to-cloudwatch-logs-console-create-log-group"></a>

CloudTrail uses a CloudWatch Logs log group as a delivery endpoint for log events\. You can create a log group or specify an existing one\.

**To create or specify a log group**

1. Make sure you are logged in with an administrative IAM user or role with sufficient permissions to configure CloudWatch Logs integration\. For more information, see [Granting Permission to View and Configure Amazon CloudWatch Logs Information on the CloudTrail Console](security_iam_id-based-policy-examples.md#grant-cloudwatch-permissions-for-cloudtrail-users)\.

1. Open the CloudTrail console at [https://console\.aws\.amazon\.com/cloudtrail/](https://console.aws.amazon.com/cloudtrail/)\.

1.  Choose the trail name\. If you choose a trail that applies to all regions, you will be redirected to the region in which the trail was created\. You can create a log group or choose an existing log group in the same region as the trail\.
**Note**  
A trail that applies to all regions sends log files from all regions to the CloudWatch Logs log group that you specify\.

1. For **CloudWatch Logs**, choose **Configure**\.

1. For **New or existing log group**, type the log group name , and then choose **Continue**\. For more information, see [CloudWatch Log Group and Log Stream Naming for CloudTrail](cloudwatch-log-group-log-stream-naming-for-cloudtrail.md)\.

1. For the IAM role, choose an existing role or create one\. If you create an IAM role, type a role name\.

1. Choose **Allow** to grant CloudTrail permissions to create a CloudWatch Logs log stream and deliver events\. 

### Specifying an IAM Role<a name="send-cloudtrail-events-to-cloudwatch-logs-console-create-role"></a>

You can specify a role for CloudTrail to assume to deliver events to the log stream\.

**To specify a role**

1. By default, the `CloudTrail_CloudWatchLogs_Role` is specified for you\. The default role policy has the required permissions to create a CloudWatch Logs log stream in a log group that you specify, and to deliver CloudTrail events to that log stream\. 
**Note**  
If you want to use this role for a log group for an organization trail, you must manually modify the policy after you create the role\. For more information, see [this policy example](#policy-cwl-org) and [Creating a Trail for an Organization](creating-trail-organization.md)\.

   1. To verify the role, go to the AWS Identity and Access Management console at [https://console\.aws\.amazon\.com/iam/](https://console.aws.amazon.com/iam/)\.

   1. Choose **Roles** and then choose the **CloudTrail\_CloudWatchLogs\_Role**\.

   1. To see the contents of the role policy, choose **View Policy Document**\.

1. You can specify another role, but you must attach the required role policy to the existing role if you want to use it to send events to CloudWatch Logs\. For more information, see [Role Policy Document for CloudTrail to Use CloudWatch Logs for Monitoring](cloudtrail-required-policy-for-cloudwatch-logs.md)\.

### Viewing Events in the CloudWatch Console<a name="viewing-events-in-cloudwatch"></a>

After you configure your trail to send events to your CloudWatch Logs log group, you can view the events in the CloudWatch console\. CloudTrail typically delivers events to your log group within a few minutes of an API call\. 

**To view events in the CloudWatch console**

1. Open the CloudWatch console at [https://console\.aws\.amazon\.com/cloudwatch/](https://console.aws.amazon.com/cloudwatch/)\.

1. Choose **Logs**\.

1. Choose the log group that you specified for your trail\.

1. Choose the log stream name\.

1. To see the details of the event that your trail logged, choose an event\.

**Note**  
The **Time \(UTC\) **column in the CloudWatch console shows when the event was delivered to your log group\. To see the actual time that the event was logged by CloudTrail, see the `eventTime` field\.

## Configuring CloudWatch Logs Monitoring with the AWS CLI<a name="send-cloudtrail-events-to-cloudwatch-logs-cli"></a>

You can use the AWS CLI to configure CloudTrail to send events to CloudWatch Logs for monitoring\.

### Creating a Log Group<a name="send-cloudtrail-events-to-cloudwatch-logs-cli-create-log-group"></a>

1. If you don't have an existing log group, create a CloudWatch Logs log group as a delivery endpoint for log events using the CloudWatch Logs `create-log-group` command\.

   ```
   aws logs create-log-group --log-group-name name
   ```

   The following example creates a log group named `CloudTrail/logs`:

   ```
   aws logs create-log-group --log-group-name CloudTrail/logs
   ```

1. Retrieve the log group Amazon Resource Name \(ARN\)\.

   ```
   aws logs describe-log-groups
   ```

### Creating a Role<a name="send-cloudtrail-events-to-cloudwatch-logs-cli-create-role"></a>

Create a role for CloudTrail that enables it to send events to the CloudWatch Logs log group\. The IAM `create-role` command takes two parameters: a role name and a file path to an assume role policy document in JSON format\. The policy document that you use gives `AssumeRole` permissions to CloudTrail\. The `create-role` command creates the role with the required permissions\. 

To create the JSON file that will contain the policy document, open a text editor and save the following policy contents in a file called `assume_role_policy_document.json`\. 

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "",
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudtrail.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

Run the following command to create the role with `AssumeRole` permissions for CloudTrail\. 

```
aws iam create-role --role-name role_name --assume-role-policy-document file://<path to assume_role_policy_document>.json
```

When the command completes, take a note of the role ARN in the output\.

### Creating a Policy Document<a name="send-cloudtrail-events-to-cloudwatch-logs-cli-create-policy-document"></a>

Create the following role policy document for CloudTrail\. This document grants CloudTrail the permissions required to create a CloudWatch Logs log stream in the log group you specify and to deliver CloudTrail events to that log stream\.

```
{
  "Version": "2012-10-17",
  "Statement": [
    {

      "Sid": "AWSCloudTrailCreateLogStream2014110",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream"
      ],
      "Resource": [
        "arn:aws:logs:region:accountID:log-group:log_group_name:log-stream:accountID_CloudTrail_region*"
      ]

    },
    {
      "Sid": "AWSCloudTrailPutLogEvents20141101",
      "Effect": "Allow",
      "Action": [
        "logs:PutLogEvents"
      ],
      "Resource": [
        "arn:aws:logs:region:accountID:log-group:log_group_name:log-stream:accountID_CloudTrail_region*"
      ]
    }
  ]
}
```

Save the policy document in a file called `role-policy-document.json`\.<a name="policy-cwl-org"></a>

If you're creating a policy that might be used for organization trails as well, you will need to configure it slightly differently\. For example, the following policy grants CloudTrail the permissions required to create a CloudWatch Logs log stream in the log group you specify and to deliver CloudTrail events to that log stream for both trails in the AWS account 111111111111 and for organization trails created in the 111111111111 account that are applied to the AWS Organizations organization with the ID of *o\-exampleorgid*:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AWSCloudTrailCreateLogStream20141101",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogStream"
            ],
            "Resource": [
                "arn:aws:logs:us-east-2:111111111111:log-group:CloudTrail/DefaultLogGroupTest:log-stream:111111111111_CloudTrail_us-east-2*",
                "arn:aws:logs:us-east-2:111111111111:log-group:CloudTrail/DefaultLogGroupTest:log-stream:o-exampleorgid_*",
            ]
        },
        {
            "Sid": "AWSCloudTrailPutLogEvents20141101",
            "Effect": "Allow",
            "Action": [
                "logs:PutLogEvents"
            ],
            "Resource": [
                "arn:aws:logs:us-east-2:111111111111:log-group:CloudTrail/DefaultLogGroupTest:log-stream:111111111111_CloudTrail_us-east-2*",             
                "arn:aws:logs:us-east-2:111111111111:log-group:CloudTrail/DefaultLogGroupTest:log-stream:o-exampleorgid_*",
            ]
        }
    ]
}
```

For more information about organization trails, see [Creating a Trail for an Organization](creating-trail-organization.md)\.

Run the following command to apply the policy to the role\.

```
aws iam put-role-policy --role-name role_name --policy-name cloudtrail-policy --policy-document file://<path to role-policy-document>.json
```

### Updating the Trail<a name="send-cloudtrail-events-to-cloudwatch-logs-cli-update-trail"></a>

Update the trail with the log group and role information using the CloudTrail `update-trail` command\.

```
aws cloudtrail update-trail --name trail_name --cloud-watch-logs-log-group-arn log_group_arn --cloud-watch-logs-role-arn role_arn
```

For more information about the AWS CLI commands, see the [AWS CloudTrail Command Line Reference](https://docs.aws.amazon.com/cli/latest/reference/cloudtrail/index.html)\. 

## Limitation<a name="send-cloudtrail-events-to-cloudwatch-logs-limitations"></a>

Because CloudWatch Logs has an [event size limitation of 256 KB](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/cloudwatch_limits_cwl.html), CloudTrail does not send events larger than 256 KB to CloudWatch Logs\. For example, a call to the EC2 `RunInstances` API to launch 500 instances will exceed the 256 KB limit\. CloudTrail does not send the event to CloudWatch Logs\. To ensure that CloudTrail sends events to CloudWatch Logs, break large requests into smaller batches\.

### 2. Centrailaize and View AWS CodeDeploy logs in Amazon CloudWatch utilizing Cloudwatch Events 
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.AE-4|Impact of events is determined
|DE.AE-5|Incident Alert thresholds are established
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|  

**Why?** You can use Amazon CloudWatch Events to detect and react to changes in the state of an instance or a deployment (an event) in your CodeDeploy operations. Then, based on rules you create, CloudWatch Events invokes one or more target actions when a deployment or instance enters the state you specify in a rule. Depending on the type of state change, you might want to send notifications, capture state information, take corrective action, initiate events, or take other actions

**How?** Install and configure the CloudWatch Log agent and add the required IAM permissions to each instance profile.  
For instruction on installing the AWS CloudWatch Logs Agent, see [Endnote 3](#endnote-3).

# Grant CloudWatch Permissions to a CodeDeploy Service Role<a name="monitoring-create-alarms-grant-permissions"></a>

Before you can use CloudWatch alarm monitoring with your deployments, the service role you use in your CodeDeploy operations must be granted permission to access the CloudWatch resources\. 

**To grant CloudWatch permissions to a service role**

1. Sign in to the AWS Management Console and open the IAM console at [https://console\.aws\.amazon\.com/iam/](https://console.aws.amazon.com/iam/)\.

1. In the IAM console, in the navigation pane, choose **Roles**\.

1. Choose the name of the service role you use in your AWS CodeDeploy operations\.

1. On the **Permissions** tab, in the **Inline Policies** area, choose **Create Role Policy**\.

   –or–

   If the **Create Role Policy** button is not available, expand the **Inline Policies** area, and then choose **click here**\.

1. On the **Set Permissions** page, choose **Custom Policy**, and then choose **Select**\.

1. On the **Review Policy** page, in the **Policy Name** field, type a name to identify this policy, such as `CWAlarms`\.

1. Paste the following into the **Policy Document** field: 

   ```
   {
       "Version": "2012-10-17",
       "Statement": [
           {
               "Effect": "Allow",
               "Action": "cloudwatch:DescribeAlarms",
               "Resource": "*"
           }
       ]
   }
   ```

1. Choose **Apply Policy**\.



## Respond/Recover
### 1. Utilize AWS CloudWatch alarm actions to automatically stop, terminate, reboot, or recover EC2 instances when a deployment or instance event you specify occurs
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN-1|Notifications from detection systems are investigated|
|RS.AN-2|The impact of the incident is understood|
|RS.AN-3|Forensics are performed|
|RS.AN-4|Incidents are categorized consistent with response plans|
|RS.AN-5|Processes are established to receive, analyze and respond to vulnerabilities disclosed to the organization from internal and external sources (e.g. internal testing, security bulletins, or security researchers)|

**Why?** An alarm watches a single metric over a time period you specify and performs one or more actions based on the value of the metric relative to a given threshold over a number of time periods. CloudWatch alarms invoke actions when their state changes (for example, from OK to ALARM).

**How?** Using native CloudWatch alarm functionality, you can specify any of the actions supported by CloudWatch when an instance you are using in a deployment fails, such as sending an Amazon SNS notification or stopping, terminating, rebooting, or recovering an instance. For your CodeDeploy operations, you can configure a deployment group to stop a deployment whenever any CloudWatch alarm you associate with the deployment group is activated.

You can associate up to ten CloudWatch alarms with a CodeDeploy deployment group. If any of the specified alarms are activated, the deployment stops, and the status is updated to Stopped. To use this option, you must grant CloudWatch permissions to your CodeDeploy service role.  

# Using Amazon CloudWatch Alarms<a name="AlarmThatSendsEmail"></a>

You can create both *metric alarms* and *composite alarms* in CloudWatch\.
+ A *metric alarm* watches a single CloudWatch metric or the result of a math expression based on CloudWatch metrics\. The alarm performs one or more actions based on the value of the metric or expression relative to a threshold over a number of time periods\. The action can be an Amazon EC2 action, an Amazon EC2 Auto Scaling action, or a notification sent to an Amazon SNS topic\.
+ A *composite alarm* includes a rule expression that takes into account the alarm states of other alarms that you have created\. The composite alarm goes into ALARM state only if all conditions of the rule are met\. The alarms specified in a composite alarm's rule expression can include metric alarms and other composite alarms\.

  Using composite alarms can reduce alarm noise\. You can create multiple metric alarms, and also create a composite alarm and set up alerts only for the composite alarm\. For example, a composite might go into ALARM state only when all of the underlying metric alarms are in ALARM state\.

  Composite alarms can send Amazon SNS notifications when they change state, but cannot perform EC2 actions or Auto Scaling actions\.

You can add alarms to CloudWatch dashboards and monitor them visually\. When an alarm is on a dashboard, it turns red when it is in the `ALARM` state, making it easier for you to monitor its status proactively\.

Alarms invoke actions for sustained state changes only\. CloudWatch alarms don't invoke actions simply because they are in a particular state, the state must have changed and been maintained for a specified number of periods\. 

After an alarm invokes an action due to a change in state, its subsequent behavior depends on the type of action that you have associated with the alarm\. For Amazon EC2 Auto Scaling actions, the alarm continues to invoke the action for every period that the alarm remains in the new state\. For Amazon SNS notifications, no additional actions are invoked\.

**Note**  
CloudWatch doesn't test or validate the actions that you specify, nor does it detect any Amazon EC2 Auto Scaling or Amazon SNS errors resulting from an attempt to invoke nonexistent actions\. Make sure that your alarm actions exist\.

## Metric Alarm States<a name="alarm-states"></a>

A metric alarm has the following possible states:
+ `OK` – The metric or expression is within the defined threshold\.
+ `ALARM` – The metric or expression is outside of the defined threshold\.
+ `INSUFFICIENT_DATA` – The alarm has just started, the metric is not available, or not enough data is available for the metric to determine the alarm state\.

## Evaluating an Alarm<a name="alarm-evaluation"></a>

When you create an alarm, you specify three settings to enable CloudWatch to evaluate when to change the alarm state:
+ **Period** is the length of time to evaluate the metric or expression to create each individual data point for an alarm\. It is expressed in seconds\. If you choose one minute as the period, there is one data point every minute\.
+ **Evaluation Period** is the number of the most recent periods, or data points, to evaluate when determining alarm state\.
+ **Datapoints to Alarm** is the number of data points within the evaluation period that must be breaching to cause the alarm to go to the `ALARM` state\. The breaching data points don't have to be consecutive, they just must all be within the last number of data points equal to **Evaluation Period**\.

In the following figure, the alarm threshold for a metric alarm is set to three units\. The alarm is configured to go to the `ALARM` state and both **Evaluation Period** and **Datapoints to Alarm** are 3\. That is, when all existing data points in the most recent three consecutive periods are above the threshold, the alarm goes to the `ALARM` state\. In the figure, this happens in the third through fifth time periods\. At period six, the value dips below the threshold, so one of the periods being evaluated is not breaching, and the alarm state changes to `OK`\. During the ninth time period, the threshold is breached again, but for only one period\. Consequently, the alarm state remains `OK`\.

![\[Alarm threshold trigger alarm\]](http://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/images/alarm_graph.png)

When you configure **Evaluation Period** and **Datapoints to Alarm** as different values, you're setting an "M out of N" alarm\. **Datapoints to Alarm** is \("M"\) and **Evaluation Period** is \("N"\)\. The evaluation interval is the number of data points multiplied by the period\. For example, if you configure 4 out of 5 data points with a period of 1 minute, the evaluation interval is 5 minutes\. If you configure 3 out of 3 data points with a period of 10 minutes, the evaluation interval is 30 minutes\.

## Configuring How CloudWatch Alarms Treat Missing Data<a name="alarms-and-missing-data"></a>

Sometimes some data points for a metric with an alarm don't get reported to CloudWatch\. For example, this can happen when a connection is lost, a server goes down, or when a metric reports data only intermittently by design\.

CloudWatch enables you to specify how to treat missing data points when evaluating an alarm\. This can help you configure your alarm to go to the `ALARM` state when appropriate for the type of data being monitored\. You can avoid false positives when missing data doesn't indicate a problem\.

Similar to how each alarm is always in one of three states, each specific data point reported to CloudWatch falls under one of three categories:
+ Not breaching \(within the threshold\)
+ Breaching \(violating the threshold\)
+ Missing

For each alarm, you can specify CloudWatch to treat missing data points as any of the following:
+ `notBreaching` – Missing data points are treated as "good" and within the threshold,
+ `breaching` – Missing data points are treated as "bad" and breaching the threshold
+ `ignore` – The current alarm state is maintained
+ `missing` – The alarm doesn't consider missing data points when evaluating whether to change state

The best choice depends on the type of metric\. For a metric that continually reports data, such as `CPUUtilization` of an instance, you might want to treat missing data points as `breaching`, because they might indicate that something is wrong\. But for a metric that generates data points only when an error occurs, such as `ThrottledRequests` in Amazon DynamoDB, you would want to treat missing data as `notBreaching`\. The default behavior is `missing`\.

Choosing the best option for your alarm prevents unnecessary and misleading alarm condition changes, and also more accurately indicates the health of your system\.

### How Alarm State Is Evaluated When Data Is Missing<a name="alarms-evaluating-missing-data"></a>

No matter what value you set for how to treat missing data, when an alarm evaluates whether to change state, CloudWatch attempts to retrieve a higher number of data points than specified by **Evaluation Periods**\. The exact number of data points it attempts to retrieve depends on the length of the alarm period and whether it is based on a metric with standard resolution or high resolution\. The time frame of the data points that it attempts to retrieve is the *evaluation range*\.

Once CloudWatch retrieves these data points, the following happens:
+ If no data points in the evaluation range are missing, CloudWatch evaluates the alarm based on the most recent data points collected\.
+ If some data points in the evaluation range are missing, but the number of existing data points retrieved is equal to or more than the alarm's **Evaluation Periods**, CloudWatch evaluates the alarm state based on the most recent existing data points that were successfully retrieved\. In this case, the value you set for how to treat missing data is not needed and is ignored\.
+ If some data points in the evaluation range are missing, and the number of existing data points that were retrieved is lower than the alarm's number of evaluation periods, CloudWatch fills in the missing data points with the result you specified for how to treat missing data, and then evaluates the alarm\. However, any real data points in the evaluation range, no matter when they were reported, are included in the evaluation\. CloudWatch uses missing data points only as few times as possible\. 

In all of these situations, the number of data points evaluated is equal to the value of **Evaluation Periods**\. If fewer than the value of **Datapoints to Alarm** are breaching, the alarm state is set to `OK`\. Otherwise, the state is set to `ALARM`\. The exception is if you have set the alarm to treat missing data points as `missing`\. In this case, if CloudWatch could not retrieve enough actual data points during the evaluation range, then the alarm state is set to `INSUFFICIENT_DATA`\.

**Note**  
A particular case of this behavior is that CloudWatch alarms might repeatedly re\-evaluate the last set of data points for a period of time after the metric has stopped flowing\. This re\-evaluation might cause the alarm to change state and re\-execute actions, if it had changed state immediately prior to the metric stream stopping\. To mitigate this behavior, use shorter periods\.

The following tables illustrate examples of the alarm evaluation behavior\. In the first table, **Datapoints to Alarm** and **Evaluation Periods** are both 3\. CloudWatch retrieves the 5 most recent data points when evaluating the alarm, in case some of the most recent 3 data points are missing\. 5 is the evaluation range for the alarm\.

Column 2 shows how many of the 3 necessary data points are missing\. Even though the most recent 5 data points are evaluated, only 3 \(the setting for **Evaluation Periods**\) are necessary to evaluate the alarm state\. The number of data points in Column 2 is the number of data points that must be "filled in", using the setting for how missing data is being treated\. 

Columns 3\-6 show the alarm state that would be set for each setting of how missing data should be treated, shown at the top of each column\. In the data points column, 0 is a non\-breaching data point, X is a breaching data point, and \- is a missing data point\.


| Data points | \# of missing data points | MISSING | IGNORE | BREACHING | NOT BREACHING | 
| --- | --- | --- | --- | --- | --- | 
|  0 \- X \- X  |  0  |  `OK`  |  `OK`  |  `OK`  |  `OK`  | 
|  0 \- \- \- \-  |  2  |  `OK`  |  `OK`  |  `OK`  |  `OK`  | 
|  \- \- \- \- \-  |  3  |  `INSUFFICIENT_DATA`  |  Retain current state  |  `ALARM`  |  `OK`  | 
|  0 X X \- X  |  0  |  `ALARM`  |  `ALARM`  |  `ALARM`  |  `ALARM`  | 
|  \- \- X \- \-   |  2  |  `ALARM`  |  `ALARM`  |  `ALARM`  |  `OK`  | 

In the second row of the preceding table, the alarm stays `OK` even if missing data is treated as breaching, because the one existing data point is not breaching, and this is evaluated along with two missing data points which are treated as breaching\. The next time this alarm is evaluated, if the data is still missing it will go to `ALARM`, as that non\-breaching data point will no longer be among the 5 most recent data points retrieved\.

In the fourth row, the alarm goes to `ALARM` state in all cases because there are enough real data points so that the setting for how to treat missing data doesn't need to be considered\.

In the final row, the alarm goes to ALARM state because when an alarm's most recent three data points are either breaching or don't exist, the alarm goes to ALARM state\.

In the next table, the **Period** is again set to 5 minutes, and **Datapoints to Alarm** is only 2 while **Evaluation Periods** is 3\. This is a 2 out of 3, M out of N alarm\.

The evaluation range is 5\. This is the maximum number of recent data points that are retrieved and can be used in case some data points are missing\.


| Data points | \# of missing data points | MISSING | IGNORE | BREACHING | NOT BREACHING | 
| --- | --- | --- | --- | --- | --- | 
|  0 \- X \- X  |  0  |  `ALARM`  |  `ALARM`  |  `ALARM`  |  `ALARM`  | 
|  0 0 X 0 X  |  0  |  `ALARM`  |  `ALARM`  |  `ALARM`  |  `ALARM`  | 
|  0 \- X \- \-  |  1  |  `OK`  |  `OK`  |  `ALARM`  |  `OK`  | 
|  \- \- \- \- 0  |  2  |  `OK`  |  `OK`  |  `ALARM`  |  `OK`  | 
|  \- \- X \- \-  |  2  |  `ALARM`  |  Retain current state  |  `ALARM`  |  `OK`  | 

If data points are missing soon after you create an alarm, and the metric was being reported to CloudWatch before you created the alarm, CloudWatch retrieves the most recent data points from before the alarm was created when evaluating the alarm\.

## High\-Resolution Alarms<a name="high-resolution-alarms"></a>

 If you set an alarm on a high\-resolution metric, you can specify a high\-resolution alarm with a period of 10 seconds or 30 seconds, or you can set a regular alarm with a period of any multiple of 60 seconds\. There is a higher charge for high\-resolution alarms\. For more information about high\-resolution metrics, see [Publishing Custom Metrics](publishingMetrics.md)\.

## Alarms on Math Expressions<a name="alarms-on-metric-math-expressions"></a>

 You can set an alarm on the result of a math expression that is based on one or more CloudWatch metrics\. A math expression used for an alarm can include as many as 10 metrics\. Each metric must be using the same period\.

For an alarm based on a math expression, you can specify how you want CloudWatch to treat missing data points for the underlying metrics when evaluating the alarm\. 

Alarms based on math expressions can't perform Amazon EC2 actions\.

For more information about metric math expressions and syntax, see [Using Metric Math](using-metric-math.md)\.

## Percentile\-Based CloudWatch Alarms and Low Data Samples<a name="percentiles-with-low-samples"></a>

When you set a percentile as the statistic for an alarm, you can specify what to do when there is not enough data for a good statistical assessment\. You can choose to have the alarm evaluate the statistic anyway and possibly change the alarm state\. Or, you can have the alarm ignore the metric while the sample size is low, and wait to evaluate it until there is enough data to be statistically significant\.

For percentiles between 0\.5 \(inclusive\) and 1\.00 \(exclusive\), this setting is used when there are fewer than 10/\(1\-percentile\) data points during the evaluation period\. For example, this setting would be used if there were fewer than 1000 samples for an alarm on a p99 percentile\. For percentiles between 0 and 0\.5 \(exclusive\), the setting is used when there are fewer than 10/percentile data points\.

## Common Features of CloudWatch Alarms<a name="common-features-of-alarms"></a>

The following features apply to all CloudWatch alarms:
+ You can create up to 5000 alarms per Region per AWS account\. To create or update an alarm, you use the `PutMetricAlarm` API action \(`mon-put-metric-alarm` command\)\.
+ Alarm names must contain only ASCII characters\.
+ You can list any or all of the currently configured alarms, and list any alarms in a particular state using `DescribeAlarms` \(`mon-describe-alarms`\)\. You can further filter the list by time range\. 
+ You can disable and enable alarms by using `DisableAlarmActions` and `EnableAlarmActions` \(`mon-disable-alarm-actions` and `mon-enable-alarm-actions`\)\.
+ You can test an alarm by setting it to any state using `SetAlarmState` \(`mon-set-alarm-state`\)\. This temporary state change lasts only until the next alarm comparison occurs\.
+ You can create an alarm using `PutMetricAlarm` \(`mon-put-metric-alarm`\) before you've created a custom metric\. For the alarm to be valid, you must include all of the dimensions for the custom metric in addition to the metric namespace and metric name in the alarm definition\.
+ You can view an alarm's history using `DescribeAlarmHistory` \(`mon-describe-alarm-history`\)\. CloudWatch preserves alarm history for two weeks\. Each state transition is marked with a unique timestamp\. In rare cases, your history might show more than one notification for a state change\. The timestamp enables you to confirm unique state changes\.
+ The number of evaluation periods for an alarm multiplied by the length of each evaluation period can't exceed one day\.

**Note**  
Some AWS resources don't send metric data to CloudWatch under certain conditions\.  
For example, Amazon EBS might not send metric data for an available volume that is not attached to an Amazon EC2 instance, because there is no metric activity to be monitored for that volume\. If you have an alarm set for such a metric, you might notice its state change to `INSUFFICIENT_DATA`\. This might indicate that your resource is inactive, and might not necessarily mean that there is a problem\.

## Alerting and Incident Management<a name="incident-response-alerting"></a>

You can use Amazon CloudWatch Events to detect and react to changes in the state of an instance or a deployment \(an *event*\) in your CodeDeploy operations\. Then, based on rules you create, CloudWatch Events invokes one or more target actions when a deployment or instance enters the state you specify in a rule\. Depending on the type of state change, you might want to send notifications, capture state information, take corrective action, initiate events, or take other actions\. You can select the following types of targets when you use CloudWatch Events as part of your CodeDeploy operations:
+ AWS Lambda functions
+ Kinesis streams
+ Amazon SQS SQS queues
+ Built\-in targets \(CloudWatch alarm actions\) 
+ Amazon SNS topics 

The following are some use cases: 
+ Use a Lambda function to pass a notification to a Slack channel whenever deployments fail\. 
+ Push data about deployments or instances to a Kinesis stream to support comprehensive, real\-time status monitoring\.
+ Use CloudWatch alarm actions to automatically stop, terminate, reboot, or recover EC2 instances when a deployment or instance event you specify occurs\. 

For more information, see [What Is Amazon CloudWatch Events](https://docs.aws.amazon.com/AmazonCloudWatch/latest/DeveloperGuide/WhatIsCloudWatchEvents.html) in the *Amazon CloudWatch User Guide*\.

See [Endnote 4](#endnote-4) for more information on Using Amazon CloudWatch Alamrs.

## Endnotes
### Endnote 1 <!-- omit in toc -->
[https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscodedeploy.html#awscodedeploy-actions-as-permissions](https://docs.aws.amazon.com/IAM/latest/UserGuide/list_awscodedeploy.html#awscodedeploy-actions-as-permissions)
### Endnote 2 <!-- omit in toc -->
[https://docs.aws.amazon.com/codedeploy/latest/userguide/security_iam_id-based-policy-examples.html](https://docs.aws.amazon.com/codedeploy/latest/userguide/security_iam_id-based-policy-examples.html)
### Endnote 3 <!-- omit in toc -->
[https://aws.amazon.com/blogs/devops/view-aws-codedeploy-logs-in-amazon-cloudwatch-console/](https://aws.amazon.com/blogs/devops/view-aws-codedeploy-logs-in-amazon-cloudwatch-console/)
### Endnote 4 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html)

## Capital Group Control Statements
1. All Data-at-rest must be encrypted and use a CG BYOK encryption key.
2. All Data-in-transit must be encrypted using certificates using CG Certificate Authority.
3. Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.
4. AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch.
5. Local AWS IAM accounts are restricted to services and no user accounts are to be provisioned including IaaS resources.
6. Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.
7. Use of AWS IAM accounts are restricted to CG networks.
8. Local IAM secrets are rotated every 90 days, including accounts IaaS resources.
9. Encryption keys are rotated annually.
10. Root accounts must have 2FA/MFA enabled.