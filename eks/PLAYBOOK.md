<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# Amazon Elastic Kubernetes Service (EKS) - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1. Implement strict IAM policies around who/what is allowed to use the service](#1-implement-strict-iam-policies-around-whowhat-is-allowed-to-use-the-service)
  - [2. Take measures to ensure data is protected](#2-take-measures-to-ensure-data-is-protected)
  - [3. Disable public API access](#3-disable-public-api-access)
- [Detective](#detective)
  - [1. Establish Config rules to monitor for deviations from normal configuration](#1-establish-config-rules-to-monitor-for-deviations-from-normal-configuration)
  - [2. Utilize vulnerability scanning via Amazon Inspector](#2-utilize-vulnerability-scanning-via-amazon-inspector)
- [Respond/Recover](#respondrecover)
  - [1. Utilize Amazon EventBridge for automated incident response](#1-utilize-amazon-eventbridge-for-automated-incident-response)
- [Endnotes](#endnotes)

## Overview
AWS provides a number of security features for Amazon Elastic Kubernetes Service (EKS) which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: ID, PR.AC-2, PR.AT, PR.DS-3, PR.DS-7, PR.DS-8, PR.IP (Unless Stated), PR.MA, PR.PT-2, PR.PT-3, DE.AE-4, DE.AE-5, DE.CM-2, DE.CM-6, DE.DP, RS.RP, RS.CO, RS.MI, RS.IM, RC

## Preventative Controls
### 1. Implement strict IAM policies around who/what is allowed to use the service
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|
|PR.AC-6|Identities are proofed and bound to credentials and asserted in interactions|
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individualsâ€™ security and privacy risks and other organizational risks)|

**Why?** EKS is used to manage fleets of containers that run some of your company's most important applications and services. Implement levels of privilege and have authorization mechanisms in place to enforce the separation of privileges, mandate multi-factor authentication, and similar protections based on sensitivity.

**How?** EKS is fully integrated with AWS IAM for authentication and access control. Use IAM to create IAM users, groups and roles with appropriate permissions, and then add users to appropriate groups and roles. Use Multifactor Authentication for extra security (especially for users with administrative privileges).  
Before creating an Amazon EKS cluster, create an IAM role that the Kubernetes service can assume to create AWS resources; for example, when a load balancer is created, Kubernetes assumes the role to create an Elastic Load Balancing load balancer in the account. (Note, this only needs to be done one time and can be used for multiple EKS clusters in a given account.)  
Once the cluster is created and configured, you can to configure IAM role-based permissions within the cluster using kubectl. (Note, in order to manage your cluster with IAM users/roles, you will need to configure kubectl, create/update kubconfig, and edit the aws-auth ConfigMap within Kubernetes.)

### 2. Data is protected
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|
|PR.DS-5|Protections against data leaks are implemented|
|PR.DS-6|Integrity checking mechanisms are used to verify software, firmware, and information integrity|
|PR.IP-1|A baseline configuration of information technology/industrial control systems is created and maintained incorporating security principles (e.g. concept of least functionality)|

**Why?** Data should be protected in-transit between the customer and AWS, as well as within AWS Services using NIST-approved encryption mechanism.

**How?** Communication with the Amazon EKS API endpoint enforces HTTPS and Kubernetes default management communications on EKS are TLS encrypted between kubectl, kubelet, AWS IAM Auth and the kubernetes cluster API.  
Master Servers in the Control Plane are EBS-encrypted volumes with AWS-managed KMS encryption by default; encryption of Worker node volumes is managed by customers, and therefore can use customer-managed KMS keys.  
The Amazon EKS-optimized AMI is not encrypted by default; however, encryption can be accomplished through AMI customization as with other EC2 instances and images.  
When creating Kubernetes storage classes within your cluster, you are available to specify that the EBS storage class is encrypted, and you are able to set a defined storage class as a default. Kubernetes storage classes on EBS are encrypted with AWS-managed or customer-managed KMS keys.  
Encryption can be implemented as a preventative control by leveraging a CFN_nag rule to prevent a worker node from being created with an unencrypted EBS volume.  
Enable Envelope Encryption for Secrets in EKS. This allows you to encrypt your secrets with a separate key, inside of the encrypted EBS volume.

### 3. Disable public API access
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.PT-1|Audit/log records are determined, documented, implemented, and reviewed in accordance with policy|
|PR.PT-4|Communications and control networks are protected|
|PR.PT-5|Mechanisms (e.g., failsafe, load balancing, hot swap) are implemented to achieve resilience requirements in normal and adverse situations|
|PR.AC-3|Remote access is managed|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|
|PR.DS-4|Adequate capacity to ensure availability is maintained|  

**Why?** When creating a new cluster, Amazon EKS creates an endpoint for the managed Kubernetes API server used to communicate with the cluster (using Kubernetes management tools such as kubectl). By default, this API server endpoint is public to the internet, and access to the API server is secured using a combination of AWS Identity and Access Management (IAM) and native Kubernetes Role Based Access Control

**How?** Private access can be enabled to the Kubernetes API server so that all communication between worker nodes and the API server stays within the VPC; public access to the API can also be entirely disabled to remove all accessibility from the internet. This is done by either adjusting Security Groups and NACLs to not allow access, or removing the Internet-bound route from the VPC's route table. If you only need to manage the Kubernetes cluster from within a VPC, a private Cluster API endpoint can be leveraged, which prevents traffic from traversing the open internet.  
To prevent clusters from being accessed from outside private VPC endpoint, there are two options: (1) EventBridge rule when create_cluster() is called and endpointPublicAccess is set to True; reaction to Lambda to delete the cluster or set endpointPublicAccess to False; and, (2) EventBridge rule when update_cluster_config() is called and endpointPublicAccess is set to True; reaction to Lambda to set endpointPublicAccess to False.

## Detective
### 1. Establish configuration management rules to monitor for deviations from normal configuration
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|

**Why?** Having additional layers of protection helps keep the service within the organization's expected configuration. In the event that a cluster is incorrectly configured, and preventative controls somehow miss it, Config can be set up to monitor for this.

**How?** The list of rules below shows options that can be put in place. This is not exhaustive, or final, but provides a good starting point for some rules to start with.
|Detection|Rule|
|-------|------|
|Confirm cluster operational health|Detect EKS cluster whose updates have failed|
|Confirm cluster running approved Kubernetes version|Detect EKS clusters with unapproved Kubernetes versions|
|Detect unauthorized node creation|Detect when worker node is running an unauthorized AMI; reaction to Terminate node|
|Confirm network connectivity is restricted between working and cluster node|Detect when worker node OR security plane security group deviates from AWS recommended minimum inbound and outbound traffic restriction; reaction to Reset security group|

### 2. Utilize vulnerability scanning
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-4|Malicious code is detected|
|DE.CM-8|Vulnerability scans are performed|  

**Why?** Vulnerability scanning helps ensure that software running on the worker nodes is not susceptible to new or existing threats. 

**How?** Amazon Inspector can be leveraged to check for unintended network accessibility of your worker nodes and for vulnerabilities on those Amazon EC2 instances.  

## Respond/Recover
### 1. Utilize an event-based solution for automated incident response
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN-1|Notifications from detection systems are investigated|
|RS.AN-2|The impact of the incident is understood|
|RS.AN-3|Forensics are performed|
|RS.AN-4|Incidents are categorized consistent with response plans|
|RS.AN-5|Processes are established to receive, analyze and respond to vulnerabilities disclosed to the organization from internal and external sources (e.g. internal testing, security bulletins, or security researchers)|  
**Why?** Using an event-based solution, you can automatically report and respond to incidents, including EC2 actions taken on worker nodes, or EKS API Calls via CloudTrail.

**How?** For various incident types, an appropriate response rule should be determined and added to Amazon EventBridge. Depending on the organization's Incident Response Plan, there may be need for human interaction in some cases, or fully automated remediation in other cases.  
A few examples of some events worth triggering on include; Updates to, or removal of, EC2 instances. Changes to Security Groups or NACLs. The unauthorized creation or deletion of a cluster.

## Endnotes
