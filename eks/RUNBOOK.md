<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# Amazon Elastic Kubernetes Service (EKS) - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1. Implement strict IAM policies around who/what is allowed to use the service](#1-implement-strict-iam-policies-around-whowhat-is-allowed-to-use-the-service)
  - [2. Data is protected](#2-data-is-protected)
  - [3. Disable public API access](#3-disable-public-api-access)
- [Detective](#detective)
  - [1. Establish configuration management rules to monitor for deviations from normal configuration](#1-establish-configuration-management-rules-to-monitor-for-deviations-from-normal-configuration)
  - [2. Utilize vulnerability scanning on EC2 worker nodes](#2-utilize-vulnerability-scanning-on-ec2-worker-nodes)
  - [3. Auditing of all interactions with Amazon EKS](#3-auditing-of-all-interactions-with-amazon-eks)
- [Respond/Recover](#respondrecover)
  - [1. Utilize an event-based solution for automated incident response](#1-utilize-an-event-based-solution-for-automated-incident-response)
- [Endnotes](#endnotes)
- [Capital Group Control Statements](#capital-group-control-statements)

## Overview
AWS provides a number of security features for Amazon Elastic Kubernetes Service (EKS) which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: ID, PR.AC-2, PR.AT, PR.DS-3, PR.DS-7, PR.DS-8, PR.IP (Unless Stated), PR.MA, PR.PT-2, PR.PT-3, DE.AE-4, DE.AE-5, DE.CM-2, DE.CM-6, DE.DP, RS.RP, RS.CO, RS.MI, RS.IM, RC

These Capital Group control statements are not applicable to this service: 5, 7, 8, 9, 10

## Preventative Controls
### 1. Implement strict IAM policies around who/what is allowed to use the service
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|
|PR.AC-6|Identities are proofed and bound to credentials and asserted in interactions|
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individualsâ€™ security and privacy risks and other organizational risks)|

**Why?** EKS is used to manage fleets of containers that run some of your company's most important applications and services. Implement levels of privilege and have authorization mechanisms in place to enforce the separation of privileges, mandate multi-factor authentication, and similar protections based on sensitivity.

**How?** EKS is fully integrated with AWS IAM for authentication and access control. Use IAM to create IAM users, groups and roles with appropriate permissions, and then add users to appropriate groups and roles. Use Multifactor Authentication for extra security (especially for users with administrative privileges).  
Before creating an Amazon EKS cluster, create an IAM role that the Kubernetes service can assume to create AWS resources; for example, when a load balancer is created, Kubernetes assumes the role to create an Elastic Load Balancing load balancer in the account. (Note, this only needs to be done one time and can be used for multiple EKS clusters in a given account.)  
Once the cluster is created and configured, you can to configure IAM role-based permissions within the cluster using kubectl. (Note, in order to manage your cluster with IAM users/roles, you will need to configure kubectl, create/update kubconfig, and edit the aws-auth ConfigMap within Kubernetes.)

Amazon EKS uses IAM to provide authentication to your Kubernetes cluster, but it still relies on native Kubernetes Role Based Access Control (RBAC) for authorization. For more information on setting up Kubernetes RBAC, see [Endnote 1](#endnote-1).

### 2. Data is protected
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|
|PR.DS-5|Protections against data leaks are implemented|
|PR.DS-6|Integrity checking mechanisms are used to verify software, firmware, and information integrity|
|PR.IP-1|A baseline configuration of information technology/industrial control systems is created and maintained incorporating security principles (e.g. concept of least functionality)|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|1|All Data-at-rest must be encrypted and use a CG BYOK encryption key.|
|2|All Data-in-transit must be encrypted using certificates using CG Certificate Authority.|
|3|Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.|

**Why?** Data should be protected in-transit between the customer and AWS, as well as within AWS Services using NIST-approved encryption mechanism.

**How?** Communication with the Amazon EKS API endpoint enforces HTTPS and Kubernetes default management communications on EKS are TLS encrypted between kubectl, kubelet, AWS IAM Auth and the kubernetes cluster API.  
Master Servers in the Control Plane have EBS-encrypted volumes with AWS-managed KMS keys. **This key cannot be changed, and BYOK is not possible on EKS Master Servers**.  
Encryption of Worker node volumes is managed by customers, and therefore can use customer-managed KMS keys.  
The Amazon EKS-optimized AMI is not encrypted by default; however, encryption can be accomplished through AMI customization just like with other EC2 instances and images.  
When creating Kubernetes storage classes within your cluster, you are available to specify that the EBS storage class is encrypted, and you are able to set a defined storage class as a default. Kubernetes storage classes on EBS are encrypted with AWS-managed or customer-managed KMS keys.  
Enable Envelope Encryption for Secrets in EKS. This allows you to encrypt your secrets with a customer-managed key, inside of the encrypted EBS volume that uses the AWS-managed key.

_If using Fargate pods with EKS, keep this note in mind._  
Fargate runs each pod in a VM-isolated environment without sharing resources with other pods. However, because Kubernetes is a single-tenant orchestrator, Fargate cannot guarantee pod-level security isolation. **You should run sensitive workloads or untrusted workloads that need complete security isolation using separate Amazon EKS clusters.**

### 3. Disable public API access
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.PT-1|Audit/log records are determined, documented, implemented, and reviewed in accordance with policy|
|PR.PT-4|Communications and control networks are protected|
|PR.PT-5|Mechanisms (e.g., failsafe, load balancing, hot swap) are implemented to achieve resilience requirements in normal and adverse situations|
|PR.AC-3|Remote access is managed|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|
|PR.DS-4|Adequate capacity to ensure availability is maintained|

Capital Group:
|Control Statement|Description|
|------|----------------------|
|6|Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.|

**Why?** When creating a new cluster, Amazon EKS creates an endpoint for the managed Kubernetes API server used to communicate with the cluster (using Kubernetes management tools such as kubectl). By default, this API server endpoint is public to the internet, and access to the API server is secured using a combination of AWS Identity and Access Management (IAM) and native Kubernetes Role Based Access Control

**How?** Private access can be enabled to the Kubernetes API server so that all communication between worker nodes and the API server stays within the VPC. If you only need to manage the Kubernetes cluster from within a VPC, a private Cluster API endpoint can be leveraged, which prevents traffic from traversing the open internet. *Because this endpoint is for the Kubernetes API server and not a traditional AWS PrivateLink endpoint for communicating with an AWS API, it doesn't appear as an endpoint in the Amazon VPC console.*

Enabling private cluster access and disabling public access is done by updating two settings in the cluster's Networking options within the console. For **Private access**, choose whether to enable or disable private access for your cluster's Kubernetes API server endpoint. If you enable private access, Kubernetes API requests that originate from within your cluster's VPC use the private VPC endpoint. *You must enable private access to disable public access.*  
For **Public access**, choose whether to enable or disable public access for your cluster's Kubernetes API server endpoint. If you disable public access, your cluster's Kubernetes API server can only receive requests from within the cluster VPC.  
This can also be done in a single command in the AWS CLI:
<pre>
aws eks update-cluster-config \
    --region <i>region-code</i> \
    --name <i>dev</i> \
    --resources-vpc-config endpointPublicAccess=<b>false</b>,endpointPrivateAccess=<b>true</b>
</pre>

To prevent clusters from being created or updated to allow public access, there are two options: (1) EventBridge rule when `create_cluster()` is called and `endpointPublicAccess` is set to `True`; reaction to Lambda to delete the cluster or set `endpointPublicAccess` to `False`; and, (2) EventBridge rule when `update_cluster_config()` is called and `endpointPublicAccess` is set to `True`; reaction to Lambda to set `endpointPublicAccess` to `False`.

## Detective
### 1. Establish configuration management rules to monitor for deviations from normal configuration
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|

**Why?** Having additional layers of protection helps keep the service within the organization's expected configuration. In the event that a cluster is incorrectly configured, and preventative controls somehow miss it, Config can be set up to monitor for this.

**How?** The list of rules below shows options that can be put in place. This is not exhaustive, or final, but provides a good starting point for some rules to start with.

|Detection|Rule|
|-------|------|
|Confirm cluster operational health|Detect EKS cluster whose updates have failed|
|Confirm cluster running approved Kubernetes version|Detect EKS clusters with unapproved Kubernetes versions|
|Detect unauthorized node creation|Detect when worker node is running an unauthorized AMI; reaction to Terminate node|
|Confirm network connectivity is restricted between working and cluster node|Detect when worker node OR security plane security group deviates from AWS recommended minimum inbound and outbound traffic restriction; reaction to Reset security group|

### 2. Utilize vulnerability scanning on EC2 worker nodes
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-4|Malicious code is detected|
|DE.CM-8|Vulnerability scans are performed|  

**Why?** Vulnerability scanning helps ensure that software running on the worker nodes is not susceptible to new or existing threats. 

**How?** Amazon Inspector can be leveraged to check for unintended network accessibility of your worker nodes and for vulnerabilities on those Amazon EC2 instances. Amazon Inspector can run assessments on up to 500 EC2 instances simultaneously per AWS account. 

The Amazon Inspector agent is installed when the target EC2 instances are chosen during Inspector assessment creation. It is also possible to install the Amazon Inspector agent on multiple EC2 instances at once using the Systems Manager Run Command.  
Within the Systems Manager console, select Instances & Nodes, and then select Run Command. There is a pre-defined command document named **AmazonInspector-ManageAWSAgent** that scripts out the installation of the Inspector agent. For the targets of the Run Command, select the EC2 instances in your EKS worker nodes cluster, or select a common tag (recommended).

For more information on how to use Amazon Inspector, see [Endnote 2](#endnote-2).

### 3. Auditing of all interactions with Amazon EKS
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-2|Detected events are analyzed to understand attack targets and methods|
|DE.AE-3|Event data are collected and correlated from multiple sources and sensors|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-3|Personnel activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed| 

Capital Group:
|Control Statement|Description|
|------|----------------------|
|4|AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch.|

**Why?** Monitoring is an important part of maintaining the reliability, availability, and performance of Amazon EKS and your AWS solutions. You should collect monitoring data from all of the parts of your AWS solution so that you can more easily debug a multi-point failure, if one occurs. AWS provides the following tools for monitoring your EKS resources and for responding to potential incidents. 

**How?** Amazon EKS is integrated with AWS CloudTrail, a service that provides a record of actions taken by a user, role, or an AWS service in EKS. All that is needed for setting up logging to CloudTrail is to select which type of control plane logs you want to be collected. This is done on a per-cluster basis during cluster configuration, and can be changed at any time. CloudTrail captures all API calls for EKS as events, including calls from the EKS console and from code calls to the EKS APIs. If you create a trail, you can enable continuous delivery of CloudTrail events to an Amazon S3 bucket, including events for EKS. If you don't configure a trail, you can still view the most recent events in the CloudTrail console in Event history. Using the information collected by CloudTrail, you can determine the request that was made to EKS, the IP address from which the request was made, who made the request, when it was made, and additional details.  
To protect sensitive information, AWS access key IDs, strings specified using the Parameter Store, and strings specified using AWS Secrets Manager are hidden in EKS logs.

The following example shows a CloudTrail log entry that demonstrates the `CreateCluster` action:
```json
{
  "eventVersion": "1.05",
  "userIdentity": {
    "type": "IAMUser",
    "principalId": "AKIAIOSFODNN7EXAMPLE",
    "arn": "arn:aws:iam::111122223333:user/username",
    "accountId": "111122223333",
    "accessKeyId": "AKIAIOSFODNN7EXAMPLE",
    "userName": "username"
  },
  "eventTime": "2018-05-28T19:16:43Z",
  "eventSource": "eks.amazonaws.com",
  "eventName": "CreateCluster",
  "awsRegion": "region-code",
  "sourceIPAddress": "205.251.233.178",
  "userAgent": "PostmanRuntime/6.4.0",
  "requestParameters": {
    "resourcesVpcConfig": {
      "subnetIds": [
        "subnet-a670c2df",
        "subnet-4f8c5004"
      ]
    },
    "roleArn": "arn:aws:iam::111122223333:role/AWSServiceRoleForAmazonEKS-CAC1G1VH3ZKZ",
    "clusterName": "test"
  },
  "responseElements": {
    "cluster": {
      "clusterName": "test",
      "status": "CREATING",
      "createdAt": 1527535003.208,
      "certificateAuthority": {},
      "arn": "arn:aws:eks:region-code:111122223333:cluster/test",
      "roleArn": "arn:aws:iam::111122223333:role/AWSServiceRoleForAmazonEKS-CAC1G1VH3ZKZ",
      "version": "1.10",
      "resourcesVpcConfig": {
        "securityGroupIds": [],
        "vpcId": "vpc-21277358",
        "subnetIds": [
          "subnet-a670c2df",
          "subnet-4f8c5004"
        ]
      }
    }
  },
  "requestID": "a7a0735d-62ab-11e8-9f79-81ce5b2b7d37",
  "eventID": "eab22523-174a-499c-9dd6-91e7be3ff8e3",
  "readOnly": false,
  "eventType": "AwsApiCall",
  "recipientAccountId": "111122223333"
}
```

## Respond/Recover
### 1. Utilize an event-based solution for automated incident response
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN-1|Notifications from detection systems are investigated|
|RS.AN-2|The impact of the incident is understood|
|RS.AN-3|Forensics are performed|
|RS.AN-4|Incidents are categorized consistent with response plans|
|RS.AN-5|Processes are established to receive, analyze and respond to vulnerabilities disclosed to the organization from internal and external sources (e.g. internal testing, security bulletins, or security researchers)|

**Why?** Using an event-based solution, you can automatically report and respond to incidents. This significantly reduces time-to-response and time-to-resolution. 

**How?** For various incident types, an appropriate response rule should be determined and added to Amazon EventBridge. Depending on the organization's Incident Response Plan, there may be need for human interaction in some cases, or fully automated remediation in other cases.  
A few examples of some events worth triggering on include; Updates to, or removal of, EC2 instances. Changes to Security Groups or NACLs. The unauthorized creation or deletion of a cluster.

For more information on setting up EventBridge rules that trigger off of CloudTrail events, see [Endnote 3](#endnote-3).

## Endnotes
### Endnote 1 <!-- omit in toc -->
[https://docs.aws.amazon.com/eks/latest/userguide/managing-auth.html](https://docs.aws.amazon.com/eks/latest/userguide/managing-auth.html)

### Endnote 2 <!-- omit in toc -->
[https://docs.aws.amazon.com/inspector/latest/userguide/inspector_introduction.html](https://docs.aws.amazon.com/inspector/latest/userguide/inspector_introduction.html)

### Endnote 3 <!-- omit in toc -->
[https://docs.aws.amazon.com/eventbridge/latest/userguide/event-types.html#events-for-services-not-listed](https://docs.aws.amazon.com/eventbridge/latest/userguide/event-types.html#events-for-services-not-listed)

## Capital Group Control Statements 

1. All Data-at-rest must be encrypted and use a CG BYOK encryption key.
2. All Data-in-transit must be encrypted using certificates using CG Certificate Authority.
3. Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.
4. AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch.
5. Local AWS IAM accounts are restricted to services and no user accounts are to be provisioned including IaaS resources.
6. Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.
7. Use of AWS IAM accounts are restricted to CG networks.
8. Local IAM secrets are rotated every 90 days, including accounts IaaS resources.
9. Encryption keys are rotated annually.
10. Root accounts must have 2FA/MFA enabled.