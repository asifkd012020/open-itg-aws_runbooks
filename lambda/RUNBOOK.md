<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# AWS Lambda - Security Runbook <!-- omit in toc -->
## Capgroup Cybersecurity Control Alignment <!-- omit in toc -->

**Generated By:**  
[Josh Linus (JHZL)](https://cgweb3/profile/JHZL)  
Security Engineering

**Last Update:** *09/20/2021*

Table of Contents
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Cloud Security Requirements](#cloud-security-requirements)
  - [1. Enforce least privilege for all Lambda users, roles, and policies](#1-Enforce-least-privilege-for-all-Lambda-users,-roles,-and-policies)
  - [2. Environment variables are encrypted using CG CMK](#2-Environment-variables-are-encrypted-using-CG-CMK)
  - [3. Data in Transit is encrypted using TLS 1.2](#3-Data-in-Transit-is-encrypted-using-TLS-12)
  - [4. Lambda deployed in VPC and utilizes VPC Endpoints to Prevent Public Access](#4-Lambda-deployed-in-VPC-and-utilizes-VPC-Endpoints-to-Prevent-Public-Access) 
  - [5. Utilize Secrets Management for sensitive data](#5-Utilize-Secrets-Management-for-sensitive-data)
  - [6. CloudTrail logging enabled for Lambda](#6-CloudTrail-logging-enabled-for-Lambda)
  - [7. CloudWatch alarms enabled for lambda](#7-CloudWatch-alarms-enabled-for-lambda)
- [Operational Best Practices](#operational-best-practices)
  - [1. Enable Resource Tags](#1-Enable-Resource-Tags)
  - [2. Enable Versioning](#2-Enable-Versioning)
  - [3. Cleanup unused functions, and associated Logs](#3-Cleanup-unused-functions,-and-associated-Logs)
  - [4. Use Appropriate retension policies for CloudWatch Log groups associated with individual lambda functions](#4-Use-Appropriate-retension-policies-for-CloudWatch-Log-groups-associated-with-individual-lambda-functions)
- [Endnotes](#endnotes)
- [Capital Group Control Statements](#capital-group-control-statements)
- [Glossary](#glossary)



## Overview
AWS Lambda is a serverless compute service that lets you run code without provisioning or managing servers, creating workload-aware cluster scaling logic, maintaining event integrations, or managing runtimes. With Lambda, you can run code for virtually any type of application or backend service - all with zero administration. Just upload your code as a ZIP file or container image, and Lambda automatically and precisely allocates compute execution power and runs your code based on the incoming request or event, for any scale of traffic. You can set up your code to automatically trigger from over 200 AWS services and SaaS applications or call it directly from any web or mobile app. You can write Lambda functions in your favorite language (Node.js, Python, Go, Java, and more) and use both serverless and container tools, such as AWS SAM or Docker CLI, to build, test, and deploy your functions.

<img src="/docs/img/lambda/example.png" width="800">
<br>

### Features & Benefits
 - No servers to manage
 - Continuous scaling
 - Cost optimized with millisecond metering
 - Consistent performance at any scale
 <br><br>

## Cloud Security Requirements
<img src="/docs/img/Prevent.png" width="50">

### 1. Enforce Strict Access Policies for Lambda Users and Roles

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|CS0012298 |Access to change cloud identity access and service control policies is restricted to authorized cloud administrative personnel.|

<br>

**Why?** 

By default, IAM users and roles don't have permission to create or modify Lambda resources. They also can't perform tasks using the AWS Management Console, AWS CLI, or AWS API. An IAM administrator must create IAM policies that grant users and roles permission to perform specific API operations on the specified resources they need. The administrator must then attach those policies to the IAM users or groups that require those permissions.

**How?** 

Identity-based policies are very powerful. They determine whether someone can create, access, or delete Lambda resources in your account. When you create or edit identity-based policies, follow these guidelines and recommendations:

- **Start Out Using AWS Managed Policies**: To start using Lambda quickly, use AWS managed policies to give your users the permissions they need. These policies are already available in your account and are maintained and updated by AWS.
- **Grant Least Privilege**: When you create custom policies, grant only the permissions required to perform a task. Start with a minimum set of permissions and grant additional permissions as necessary. Doing so is more secure than starting with permissions that are too lenient and then trying to tighten them later.

**MFA**

CG require IAM users to use multi-factor authentication (MFA) to access sensitive resources or API operations. For more information, see [MFA](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html).

**Execution Policies**

A Lambda function's execution role is an AWS Identity and Access Management (IAM) role that grants the function permission to access AWS services and resources. You provide this role when you create a function, and Lambda assumes the role when your function is invoked.

Create Execution Role:
1. Open the Roles page in the IAM console.
2. Choose Create role.
3. Under Common use cases, choose Lambda.
4. Choose Next: Permissions.
5. Under Attach permissions policies, choose the AWS managed policies AWSLambdaBasicExecutionRole and AWSXRayDaemonWriteAccess.
6. Choose Next: Tags.
7. Choose Next: Review.
8. For Role name, enter `lambda-role`.
9. Choose Create role.

**Resource Policies**

AWS Lambda supports resource-based permissions policies for Lambda functions and layers. Resource-based policies let you grant usage permission to other AWS accounts on a per-resource basis. You also use a resource-based policy to allow an AWS service to invoke your function on your behalf.

More info on resource policies: https://docs.aws.amazon.com/lambda/latest/dg/access-control-resource-based.html 

**Lambda Policies**

You can use identity-based policies in AWS Identity and Access Management (IAM) to grant users in your account access to Lambda. Identity-based policies can apply to users directly, or to groups and roles that are associated with a user.

More info on user policies: https://docs.aws.amazon.com/lambda/latest/dg/access-control-identity-based.html

> **NOTE:**  
> **Use Policy Conditions for Extra Security**: To the extent that it's practical, define the conditions under which your identity-based policies allow access to a resource. For example, you can write conditions to specify a range of allowable IP addresses that a request must come from. You can also write conditions to allow requests only within a specified date or time range, or to require the use of SSL or MFA.
<br><br>

### 2. Environment variables are encrypted using CG CMK

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|CS0012168|Strong encryption key management controls are in place for cloud provider services to protect data at rest.|

<br>

**Why?** 

You can use environment variables to store secrets securely for use with Lambda functions. Lambda always encrypts environment variables at rest. Additionally, you can use the following features to customize how environment variables are encrypted.

**How?**  

You can use environment variables to store secrets securely for use with Lambda functions. Lambda always encrypts environment variables at rest. Additionally, you can use the following features to customize how environment variables are encrypted.

- **Key configuration**: On a per-function basis, configure Lambda to use an encryption key that you create and manage in AWS Key Management Service. These are referred to as **customer managed customer master keys (CMKs)** or **customer managed keys**.
- **Encryption helpers**: The Lambda console lets you encrypt environment variable values client side, before sending them to Lambda. This enhances security further by preventing secrets from being displayed unencrypted in the Lambda console, or in function configuration that's returned by the Lambda API. The console also provides sample code that you can adapt to decrypt the values in your function handler.

Lambda always encrypts files that you upload to Lambda, including deployment packages and layer archives.

Amazon CloudWatch Logs and AWS X-Ray also encrypt data by default, and should be configured to use a customer managed key. For details on setting up encryption in Amazon CloudWatch Logs, see [Cloudwatch encryption](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/encrypt-log-data-kms.html).


> **NOTE:**  
>Each Lambda execution environment also includes a writeable file system, available at `/tmp`. This storage is not accessible to other execution environments. As with the process state, files written to `/tmp` remain for the lifetime of the execution environment. This allows expensive transfer operations—such as downloading machine learning (ML) models—to be amortized across multiple invocations. Functions that do not want to persist data between invocations should either not write to `/tmp`, or delete their files from `/tmp` after each invocation. While `/tmp` is only accessible to a single invocation environment, it should be purged between invocations to help prevent disclosure or persistence of potentially sensitive data.

<br><br>

## 3. Data in Transit is encrypted using TLS 1.2

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|CS0012261|Cloud based data in transit must be encrypted with enterprise approved algorithms.|

<br>

**Why?**
TLS 1.2 and above is the standard when it comes to network security. CG requirements also need a service to support at least TLS1.2. 

**How?**
Lambda API endpoints only support secure connections over HTTPS. When you manage Lambda resources with the AWS Management Console, AWS SDK, or the Lambda API, all communication is encrypted with Transport Layer Security (TLS).

When you connect your function to a file system, Lambda uses Encryption in transit for all connections.

More info on enforcing TLS: https://docs.aws.amazon.com/cli/latest/userguide/cli-security-enforcing-tls.html

<br>

>**NOTE:**   
> Always use **TLS 1.2** or above when communicating with AWS services

<br><br>

### 4. Lambda Utilizes VPC Endpoints to Prevent Public Access

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|[CS0012300](https://capitalgroup.service-now.com/cg_grc?sys_id=80df48c01bac20506a50beef034bcb47&table=sn_compliance_policy_statement&id=cg_grc_action_item_details&view=sp)|Cloud products and services must be deployed on private subnets and public access must be disabled for these services.|

<br>

**Why?** 
When Lambdas are not attached to CG VPC's, it reduces traffic traversal of CG managed data through the public internet to reach CG assets. 

As it routes through the CXDC, it allows CG network controls to be enforced, and provides an additional layer of prevention to erroneous public exposure / publishing of data, while allowing IAM permissions limiting access to only CG sourced traffic to be viable. 

**How?** 
You can attach a VPC at creation or update an existing function with a VPC. 

```
aws lambda create-function --function-name my-function \
--runtime nodejs12.x --handler index.js --zip-file fileb://function.zip \
--role arn:aws:iam::123456789012:role/lambda-role \
--vpc-config SubnetIds=subnet-071f712345678e7c8,subnet-07fd123456788a036,SecurityGroupIds=sg-085912345678492fb
```

```
aws lambda update-function-configuration --function-name my-function \
--vpc-config SubnetIds=subnet-071f712345678e7c8,subnet-07fd123456788a036,SecurityGroupIds=sg-085912345678492fb
```

<br><br>

## 5. Utilize Secrets Management for sensitive data

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|CS0012301|Encryption key lifecycle activities must be managed through an enterprise approved key management platform. (Statement of Direction)|

<br>

**Why**

A secret is a set of credentials, such as a user name and password, that you store in an encrypted form in Secrets Manager. The secret also includes the connection information to access a database or other service, which Secrets Manager doesn't encrypt.

Use of secure storage is imperative for your secrets and sensitive credentials. Storing keys in a secret storage mitigates the risks of sensitive information stored in static files in a source code repository, or environment variables, and greatly reduces the chance of sensitive information exposure.

**How?**

There are several optional steps that are always changing when it comes to creating a secret. Follow the link to get the most up-to-date version of [how to create a secret](https://docs.aws.amazon.com/secretsmanager/latest/userguide/manage_create-basic-secret.html).

More information on secrets: https://docs.aws.amazon.com/secretsmanager/latest/userguide/managing-secrets.html

<br><br>

## 6. CloudTrail logging enabled for Lambda

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|Control|Control Definition|

<br>

**What, Why & How?**  

AWS CloudTrail is a service that provides a record of actions taken by a user, role, or an AWS service. CloudTrail captures API calls as events. For an ongoing record of events in your AWS account, you create a trail. A trail enables CloudTrail to deliver log files of events to an Amazon S3 bucket.

- A `default trail` should have been enabled through automation to allow for the continuous delivery of CloudTrail events to an Amazon S3 bucket, including events for Lambda. This will enable the forwarding of logs into Splunk for long term archival and reporting.

More info on monitoring and CloudTrail Events: https://docs.aws.amazon.com/lambda/latest/dg/with-cloudtrail.html

<br><br>

## 7. CloudWatch alarms enabled for lambda 

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|Control |Control Definition|

<br>

**What, Why & How?**  
AWS Lambda Serice allows for the collection of CloudWatch Events, Logs and Alarms. Use any and all features that best suits your situation. Uses include daily storage metrics for buckets, request metrics, and replication metrics.

 - **Amazon CloudWatch Alarms** – Watch a single metric over a time period that you specify, and perform one or more actions based on the value of the metric relative to a given threshold over a number of time periods.
 - **Amazon CloudWatch Logs** – Monitor, store, and access your log files from Amazon CloudTrail or other sources.
 - **Amazon CloudWatch Events** – Match events and route them to one or more target functions or streams to make changes, capture state information, and take corrective action.

 Utilizing these [CloudWatch](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/WhatIsCloudWatch.html) tools together can be useful in detecting anomolous activity and patterns in data access within the S3 service. It is recommended that CloudWatch is used to monitor any critical services in use at CG. Please see the [CloudWatch Runbook](https://github.com/open-itg/aws_runbooks/blob/master/cloudwatch/RUNBOOK.md) for further information.

More info on monitoring for Lambda: https://docs.aws.amazon.com/lambda/latest/dg/services-cloudwatchevents.html

<br><br>

## Operational Best Practices

## 1. Enable Resource Tags 

**What, Why & How?**  

Identification of your IT assets is a crucial aspect of governance and security. You need to have visibility of all your Amazon S3 resources to assess their security posture and take action on potential areas of weakness.

Tagging resources in the cloud is an easy way for teams to provide information related to who owns the resource, what the resource is used for, as well as other important information related to the deployment lifecycle of the resource. CG has mandated that all cloud resources are to be tagged with for cross-team use. Although most of the mandatory tags will be added through automation, one should still check to make sure that all newly deployed recources have the appropriate tags attached. Please see the documentation below for the latest tagging standards.

<br><br>

## 2. Enable Versioning 

**What, Why & How?** 

You can use versions to manage the deployment of your functions. You can use versioning in Lambda to save your function's code and configuration as you develop it. For example, you can publish a new version of a function for beta testing without affecting users of the stable production version. Lambda creates a new version of your function each time that you publish the function.
Together with aliases, you can use versioning to perform blue/green and rolling deployments.

A function version includes the following information:

- The function code and all associated dependencies.
- The Lambda runtime that invokes the function.
- All of the function settings, including the environment variables.
- A unique Amazon Resource Name (ARN) to identify the specific version of the function.

To create a new function version:

1. Open the Functions page on the Lambda console.
2. Choose a function and then choose Versions.
3. On the versions configuration page, choose Publish new version.
4. (Optional) Enter a version description.
5. Choose Publish.

<br><br>

## 3. Cleanup unused functions (dependent on team)

**What, Why & How?** 

Dead AWS Lambda functions are functions that have been cold for a long time. Usually, those AWS Lambda functions are useless, and should probably be removed.Specific retension policies and best practices will be based on your team, and the environment being used.(Dev, QA and Prod)

1. Management: Code and error management are common issues in every complex serverless architecture — but when you add dozens of unused functions, things become much more complicated.
2. Security: More functions means more opportunities for an attacker to try and take advantage of your code. A function that hasn’t been used for a long time is most likely outdated and may have wrong permissions or contain old external libraries.
3. Performance analysis: When trying to obtain a deep understanding of the entire architecture, such as the end-to-end performance, or the costs of specific transactions, having unused resources makes everything a lot harder.

<br><br>

## 4. Use appropriate retension policies for CloudWatch log groups associated with individual Lambda functions  (dependent on team)

**What, Why & How?** 

By default Cloudwatch logs are stored for an indefinite amount of time. While great, long term storage cost be unnessary and add up over time. Having a log retention policy can help mitigate some of these costs. Specific retension policies and best practices will be based on your team, and the environment being used.(Dev, QA and Prod) 

<br><br>

## Endnotes

## Capital Group Control Statements 
1. All Data-at-rest must be encrypted and use a CG BYOK encryption key.
2. All Data-in-transit must be encrypted using certificates using CG Certificate Authority.
3. Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.
4. AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch.
5. AWS IAM User accounts are only to be created for use by services or products that do not support IAM Roles. Services are not allowed to create local accounts for human use within the service. All human user authentication will take place within CG’s Identity Provider.
6. Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.
7. Use of AWS IAM accounts are restricted to CG networks.
8. AWS IAM User secrets, including passwords and secret access keys, are to be rotated every 90 days. Accounts created locally within any service must also have their secrets rotated every 90 days.
9. Encryption keys are rotated annually.
10. Administrative access to AWS resources will have MFA enabled

## Glossary
**Data** - Digital pieces of information stored or transmitted for use with an information system from which understandable information is derived. Items considered to be data are: Source code, meta-data, build artifacts, information input and output.  
 
**Information System** - An organized assembly of resources and procedures for the collection, processing, maintenance, use, sharing, dissemination, or disposition of information. All systems, platforms, compute instances including and not limited to physical and virtual client endpoints, physical and virtual servers, software containers, databases, Internet of Things (IoT) devices, network devices, applications (internal and external), Serverless computing instances (i.e. AWS Lambda), vendor provided appliances, and third-party platforms, connected to the Capital Group network or used by Capital Group users or customers.
 
**Log** - a record of the events occurring within information systems and networks. Logs are composed of log entries; each entry contains information related to a specific event that has occurred within a system or network.
 
**Information** - communication or representation of knowledge such as facts, data, or opinions in any medium or form, including textual, numerical, graphic, cartographic, narrative, or audiovisual. 
 
**Cloud Computing** - A model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources (e.g., networks, servers, storage, applications, and services) that can be rapidly provisioned and released with minimal management effort or service provider interaction.
 
**Vulnerability**  - Weakness in an information system, system security procedures, internal controls, or implementation that could be exploited or triggered by a threat source. Note: The term weakness is synonymous for deficiency. Weakness may result in security and/or privacy risks.