<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# AWS S3 - Security Runbook <!-- omit in toc -->
## Capgroup Cybersecurity Control Alignment <!-- omit in toc -->

**Generated By:**  
[Josh Linus (JHZL)](https://cgweb3/profile/JHZL)  
Security Engineering

**Last Update:** *08/19/2021*

<!--
Table of Contents
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Cloud Security Requirements](#cloud-security-requirements)
  - [1. Enforce least privilege for all Lambda users and roles](#1-Enforce-least-privilege-for-all-S3-users-and-roles)
  - [2. Environment variables are encrypted using CG CMK](#2-Functions-are-encrypted-using-CG-CMK)
  - [3. Data in Transit is encrypted using TLS 1.2](#3-Data-in-Transit-is-encrypted-using-TLS-12)
  - [4. Lambda Utilizes VPC Endpoints to Prevent Public Access](#5-S3-Utilizes-VPC-Endpoints-to-Prevent-Public-Access) 
  - [5. Utilize Secrets Management for sensitive data] (acm-checkout)
  - [6. CloudTrail logging enabled for Lambda](#8-CloudTrail-logging-enabled-for-S3)
  - [7. CloudWatch alarms enabled for lambda](#9-CloudWatch-alarms-enabled-for-S3)
- [Operational Best Practices](#operational-best-practices)
  - [1. Resource Tags](#1-Resource-Tags)
  - [2. Versioning](#3-Enable-AWS-Trusted-Advisor)
  - [3. Cleanup unused functions](#4-Utilize-Lifecycle-Management)
  - [4. Code Signing](#Enable-AWS-Config)???????????????????? ASK ROB Morning
  - Sanitize input???????????????????? ASK ROB Morning (look at vericode)
  - Monitor Dependancies (vericode does this)
  - API Gateway (When do you need lambda to have a API Gateway?)
- [Endnotes](#endnotes)
- [Capital Group Control Statements](#capital-group-control-statements)
- [Glossary](#glossary)
-->

## Table of Contents <!-- omit in toc -->
- [Overview](#overview)
- [Cloud Security Requirements](#cloud-security-requirements)
  - [1. Enforce Strict Access Policies for Lambda Users and Roles](#1-enforce-strict-access-policies-for-lambda-users-and-roles)
  - [2. Data Protection](#2-data-protection)
  - [3. Log AWS Lambda API Calls with AWS CloudTrail](#3-log-aws-lambda-api-calls-with-aws-cloudtrail)
  - [4. Utilize Amazon CloudWatch logs for AWS Lambda](#4-utilize-amazon-cloudwatch-logs-for-aws-lambda)
  - [5. Monitor AWS Lambda Function metrics in AWS CLoudwatch](#5-monitor-aws-lambda-function-metrics-in-aws-cloudwatch)
- [Operational Best Practices](#other-operational-expectations)
  - [1. Lambda Resources are tagged according to CG standards](#1-lambda-resources-are-tagged-according-to-cg-standards)
- [Endnotes](#endnotes)
- [Capital Group Glossary](#capital-group-glossary)
<br><br>

## Overview
AWS Lambda is a serverless compute service that lets you run code without provisioning or managing servers, creating workload-aware cluster scaling logic, maintaining event integrations, or managing runtimes. With Lambda, you can run code for virtually any type of application or backend service - all with zero administration. Just upload your code as a ZIP file or container image, and Lambda automatically and precisely allocates compute execution power and runs your code based on the incoming request or event, for any scale of traffic. You can set up your code to automatically trigger from over 200 AWS services and SaaS applications or call it directly from any web or mobile app. You can write Lambda functions in your favorite language (Node.js, Python, Go, Java, and more) and use both serverless and container tools, such as AWS SAM or Docker CLI, to build, test, and deploy your functions.

<img src="/docs/img/lambda/example.png" width="800">
<br>

### Features & Benefits
 - No servers to manage
 - Continuous scaling
 - Cost optimized with millisecond metering
 - Consistent performance at any scale
 <br><br>

## Cloud Security Requirements
<img src="/docs/img/Prevent.png" width="50">

### 1. Enforce Strict Access Policies for Lambda Users and Roles

**Why?** By default, IAM users and roles don't have permission to create or modify Lambda resources. They also can't perform tasks using the AWS Management Console, AWS CLI, or AWS API. An IAM administrator must create IAM policies that grant users and roles permission to perform specific API operations on the specified resources they need. The administrator must then attach those policies to the IAM users or groups that require those permissions.

**How?** Identity-based policies are very powerful. They determine whether someone can create, access, or delete Lambda resources in your account. When you create or edit identity-based policies, follow these guidelines and recommendations:

- **Start Out Using AWS Managed Policies**: To start using Lambda quickly, use AWS managed policies to give your users the permissions they need. These policies are already available in your account and are maintained and updated by AWS. For more information, see [Endnote 1](#endnote-1).
- **Grant Least Privilege**: When you create custom policies, grant only the permissions required to perform a task. Start with a minimum set of permissions and grant additional permissions as necessary. Doing so is more secure than starting with permissions that are too lenient and then trying to tighten them later. For more information, see [Endnote 2](#endnote-2).
- **Enable MFA for Sensitive Operations**: For extra security, require IAM users to use multi-factor authentication (MFA) to access sensitive resources or API operations. For more information, see [Endnote 3](#endnote-3).
- **Use Policy Conditions for Extra Security**: To the extent that it's practical, define the conditions under which your identity-based policies allow access to a resource. For example, you can write conditions to specify a range of allowable IP addresses that a request must come from. You can also write conditions to allow requests only within a specified date or time range, or to require the use of SSL or MFA. For more information, see [Endnote 4](#endnote-4).

**Conditions** are an optional policy element that applies additional logic to determine if an action is allowed. In addition to common conditions supported by all actions, Lambda defines condition types that you can use to restrict the values of additional parameters on some actions.

For example, the `lambda:Principal` condition lets you restrict the service or account that a user can grant invocation access to on a function's resource-based policy. The following policy lets a user grant permission to SNS topics to invoke a function named `test`.

Example manage function policy permissions:
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ManageFunctionPolicy",
            "Effect": "Allow",
            "Action": [
                "lambda:AddPermission",
                "lambda:RemovePermission"
            ],
            "Resource": "arn:aws:lambda:us-west-2:123456789012:function:test:*",
            "Condition": {
                "StringEquals": {
                    "lambda:Principal": "sns.amazonaws.com"
                },
                "StringEquals": {
                    "AWS:SourceAccount": "123456789012"
                }
            }
        }
    ]
}
```

The condition requires that the principal is Amazon SNS and not another service or account. The resource pattern requires that the function name is `test` and includes a version number or alias. For example, `test:v1`.

### 2. Environment variables are encrypted using CG CMK

**Why?** 

You can use environment variables to store secrets securely for use with Lambda functions. Lambda always encrypts environment variables at rest. Additionally, you can use the following features to customize how environment variables are encrypted.

**How?**  
#### Encryption At Rest <!-- omit in toc -->
You can use environment variables to store secrets securely for use with Lambda functions. Lambda always encrypts environment variables at rest. Additionally, you can use the following features to customize how environment variables are encrypted.

- **Key configuration**: On a per-function basis, configure Lambda to use an encryption key that you create and manage in AWS Key Management Service. These are referred to as **customer managed customer master keys (CMKs)** or **customer managed keys**.
- **Encryption helpers**: The Lambda console lets you encrypt environment variable values client side, before sending them to Lambda. This enhances security further by preventing secrets from being displayed unencrypted in the Lambda console, or in function configuration that's returned by the Lambda API. The console also provides sample code that you can adapt to decrypt the values in your function handler.

Lambda always encrypts files that you upload to Lambda, including deployment packages and layer archives.

Amazon CloudWatch Logs and AWS X-Ray also encrypt data by default, and should be configured to use a customer managed key. For details on setting up encryption in Amazon CloudWatch Logs, see [Endnote 5](#endnote-5).

To enable encryption for data stored in AWS X-Ray:
```
aws xray put-encryption-config --type KMS --key-id alias/aws/xray
```

#### Consider purging /tmp after every invocation <!-- omit in toc -->
Each Lambda execution environment also includes a writeable file system, available at `/tmp`. This storage is not accessible to other execution environments. As with the process state, files written to `/tmp` remain for the lifetime of the execution environment. This allows expensive transfer operations—such as downloading machine learning (ML) models—to be amortized across multiple invocations. Functions that do not want to persist data between invocations should either not write to `/tmp`, or delete their files from `/tmp` after each invocation. While `/tmp` is only accessible to a single invocation environment, it should be purged between invocations to help prevent disclosure or persistence of potentially sensitive data.

<br><br>

## 3. Data in Transit is encrypted using TLS 1.2
**Why?**
Lambda API endpoints only support secure connections over HTTPS. When you manage Lambda resources with the AWS Management Console, AWS SDK, or the Lambda API, all communication is encrypted with Transport Layer Security (TLS).

When you connect your function to a file system, Lambda uses Encryption in transit for all connections.

**How?**


<br><br>

### 4. Lambda Utilizes VPC Endpoints to Prevent Public Access

**Why?** 
When Lambdas are not attached to CG VPC's, it reduces traffic traversal of CG managed data through the public internet to reach CG assets. 

As it routes through the CXDC, it allows CG network controls to be enforced, and provides an additional layer of prevention to erroneous public exposure / publishing of data, while allowing IAM permissions limiting access to only CG sourced traffic to be viable. 

**How?** 
You can attach a VPC at creation or update an existing function with a VPC. 

```
aws lambda create-function --function-name my-function \
--runtime nodejs12.x --handler index.js --zip-file fileb://function.zip \
--role arn:aws:iam::123456789012:role/lambda-role \
--vpc-config SubnetIds=subnet-071f712345678e7c8,subnet-07fd123456788a036,SecurityGroupIds=sg-085912345678492fb
```

```
aws lambda update-function-configuration --function-name my-function \
--vpc-config SubnetIds=subnet-071f712345678e7c8,subnet-07fd123456788a036,SecurityGroupIds=sg-085912345678492fb
```

<br><br>

## 5. Utilize Secrets Management for sensitive data
**Why**


**How?**


<br><br>

## 6. CloudTrail logging enabled for Lambda

<br><br>

## 7. CloudWatch alarms enabled for lambda 

<br><br>

## Cloud Security Requirements


## Endnotes

## Capital Group Control Statements 
1. All Data-at-rest must be encrypted and use a CG BYOK encryption key.
2. All Data-in-transit must be encrypted using certificates using CG Certificate Authority.
3. Keys storied in a Key Management System (KMS) should be created by Capital Group's hardware security module (HSM) and are a minimum of AES-256.
4. AWS services should have logging enabled and those logs delivered to CloudTrail or Cloud Watch.
5. AWS IAM User accounts are only to be created for use by services or products that do not support IAM Roles. Services are not allowed to create local accounts for human use within the service. All human user authentication will take place within CG’s Identity Provider.
6. Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.
7. Use of AWS IAM accounts are restricted to CG networks.
8. AWS IAM User secrets, including passwords and secret access keys, are to be rotated every 90 days. Accounts created locally within any service must also have their secrets rotated every 90 days.
9. Encryption keys are rotated annually.
10. Administrative access to AWS resources will have MFA enabled

## Glossary
**Data** - Digital pieces of information stored or transmitted for use with an information system from which understandable information is derived. Items considered to be data are: Source code, meta-data, build artifacts, information input and output.  
 
**Information System** - An organized assembly of resources and procedures for the collection, processing, maintenance, use, sharing, dissemination, or disposition of information. All systems, platforms, compute instances including and not limited to physical and virtual client endpoints, physical and virtual servers, software containers, databases, Internet of Things (IoT) devices, network devices, applications (internal and external), Serverless computing instances (i.e. AWS Lambda), vendor provided appliances, and third-party platforms, connected to the Capital Group network or used by Capital Group users or customers.
 
**Log** - a record of the events occurring within information systems and networks. Logs are composed of log entries; each entry contains information related to a specific event that has occurred within a system or network.
 
**Information** - communication or representation of knowledge such as facts, data, or opinions in any medium or form, including textual, numerical, graphic, cartographic, narrative, or audiovisual. 
 
**Cloud Computing** - A model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources (e.g., networks, servers, storage, applications, and services) that can be rapidly provisioned and released with minimal management effort or service provider interaction.
 
**Vulnerability**  - Weakness in an information system, system security procedures, internal controls, or implementation that could be exploited or triggered by a threat source. Note: The term weakness is synonymous for deficiency. Weakness may result in security and/or privacy risks.