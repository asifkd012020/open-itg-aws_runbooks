<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# Amazon Elastic Container Service (ECS) - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->
**Tuesday, May 5, 2020**

**Generated By:**  
Freddie Wilson  
Tony DeMarco

*AWS Professional Services*

## Disclaimer
> The following applies to this document and all other documents, information, data, and responses (written or verbal) provided by Amazon Web Services, Inc. or any of its affiliates (collectively, "**AWS**") in connection with responding to this request and other related requests (collectively, this "**Response**"): This Response is expressly (a) informational only and provided solely for discussion purposes, (b) non-binding and not an offer to contract that can be accepted by any party, (c) provided "as is" with no representations or warranties whatsoever, and (d) based on AWS's current knowledge and may change at any time due to a variety of factors such as changes to your requirements or changes to AWS's service offerings. All obligations must be set forth in a separate, definitive written agreement between the parties. Neither party will have any liability for any failure or refusal to enter into a definitive agreement. All use of AWS's service offerings will be governed by the AWS Customer Agreement available at [http://aws.amazon.com/agreement/](http://aws.amazon.com/agreement/) (or other definitive written agreement between the parties governing the use of AWS's service offerings) (as applicable, the "**Agreement**"). If the parties have an applicable Nondisclosure Agreement ("**NDA**"), then the NDA will apply to all Confidential Information (as defined in the NDA) disclosed in connection with this Response. AWS's pricing is publicly available and subject to change in accordance with the Agreement. Pricing information (if any) provided in this Response is only an estimate and is expressly not a binding quote. Fees and charges will be based on actual usage of AWS services, which may vary from the estimates provided. Nothing in this Response will modify or supplement the terms of the Agreement or the NDA. No part of this Response may be disclosed without AWS's prior written consent. 

## Table of Contents <!-- omit in toc -->
- [Disclaimer](#disclaimer)
- [Overview](#overview)
- [Preventative Controls](#preventative-controls)
  - [1. Implement least privilege IAM Roles for Tasks](#1-implement-least-privilege-iam-roles-for-tasks)
  - [2. Consider using Elastic Container Registry (ECR) for storing and retrieving Docker images](#2-consider-using-elastic-container-registry-ecr-for-storing-and-retrieving-docker-images)
  - [3. Use VPC Endpoints for ECR/ECS](#3-use-vpc-endpoints-for-ecrecs)
  - [4. Consider using AWS Systems Manager Parameter Store or AWS Secrets Manager for reference of secrets into Container Definitions](#4-consider-using-aws-systems-manager-parameter-store-or-aws-secrets-manager-for-reference-of-secrets-into-container-definitions)
  - [5. Take measures to ensure data is encrypted](#5-take-measures-to-ensure-data-is-encrypted)
- [Detective](#detective)
  - [1. Utilize automated monitoring tools such as Amazon CLoudWatch Logs by enabling the awslogs Log Driver](#1-utilize-automated-monitoring-tools-such-as-amazon-cloudwatch-logs-by-enabling-the-awslogs-log-driver)
  - [2. Use CloudTrail to log ECS API activity](#2-use-cloudtrail-to-log-ecs-api-activity)
  - [3. Consider using X-Ray to capture distributed traces from your containerized applications](#3-consider-using-x-ray-to-capture-distributed-traces-from-your-containerized-applications)
  - [4. Utilize AWS CloudWatch Container Insights](#4-utilize-aws-cloudwatch-container-insights)
  - [5. Enable VPC Flow Logs for ECS Cluster VPC (EC2 Launch Types Only)](#5-enable-vpc-flow-logs-for-ecs-cluster-vpc-ec2-launch-types-only)
- [Respond/Recover](#respondrecover)
  - [1. Utilize Amazon ECS Events and EventBridge](#1-utilize-amazon-ecs-events-and-eventbridge)
- [Endnotes](#endnotes)

## Overview
AWS provides a number of security features for Amazon Elastic Container Service (ECS) which help you comply with the NIST Cybersecurity Framework. The following playbook will outline what the AWS best practices are, how they align to NIST, and how to implement these best practices within your organization.

These NIST Controls and Subcategories are not applicable to this service: PR.AT, PR.MA, PR.IP  (Unless stated), PR.AC-2, PR.AC-3, PR.DS-3, PR.DS-8, PR.PT-2, PR.PT-5, DE.DP1, DE.DP-2. DE.DP-3, DE.CM-3, DE.AE-5, RC, RS.MI.

## Preventative Controls
### 1. Implement least privilege IAM Roles for Tasks
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|
|PR.AC-7|Users, devices, and other assets are authenticated (e.g., single-factor, multi-factor) commensurate with the risk of the transaction (e.g., individuals’ security and privacy risks and other organizational risks)|
|PR.PT-3|The principle of least functionality is incorporated by configuring systems to provide only essential capabilities|

**Why?** With IAM roles for Amazon ECS tasks, you can specify an IAM role that can be used by the containers in a task. Having overly permissive IAM Roles for Tasks can lead to unauthorized access to resources not in scope of your application.

**How?** Evaluate task to determine required access. Create a role with an attached policy that grants only that level of access. Review these roles and policies on a regular basis (at least annually).

### 2. Consider using Elastic Container Registry (ECR) for storing and retrieving Docker images
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.IP-1|A baseline configuration of information technology/industrial control systems is created and maintained incorporating security principles (e.g. concept of least functionality)|
|PR.IP-7|Protection processes are improved|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|
|PR.DS-4|Adequate capacity to ensure availability is maintained|
|PR.DS-5|Protections against data leaks are implemented|
|PR.DS-6|Integrity checking mechanisms are used to verify software, firmware, and information integrity|
|PR.PT-4|Communications and control networks are protected|

**Why?** Amazon Elastic Container Registry (Amazon ECR) is a managed AWS Docker registry service that is secure, scalable, and reliable. Amazon ECR supports private Docker repositories with resource-based permissions using AWS IAM so that specific users or roles can access repositories and images. Developers can use the Docker CLI to push, pull, and manage images within ECR. Images stored in ECR are encrypted at-rest and in-transit.

**How?** Authenticate your docker agent with ECR in your AWS account. Create an initial repository in ECR. Store images in ECR. Use ECR images whenever possible to limit use of potentially dangerous public repositories. 

### 3. Use VPC Endpoints for ECR/ECS
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.IP-1|A baseline configuration of information technology/industrial control systems is created and maintained incorporating security principles (e.g. concept of least functionality)|
|PR.IP-7|Protection processes are improved|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|
|PR.DS-4|Adequate capacity to ensure availability is maintained|
|PR.DS-5|Protections against data leaks are implemented|
|PR.DS-6|Integrity checking mechanisms are used to verify software, firmware, and information integrity|
|PR.PT-4|Communications and control networks are protected|

**Why?** You can improve the security posture of your VPC by configuring Amazon ECR to use an interface VPC endpoint. VPC endpoints are powered by AWS PrivateLink, a technology that enables you to privately access Amazon ECR APIs through private IP addresses. AWS PrivateLink restricts all network traffic between your VPC and Amazon ECR to the Amazon network. Also, you don't need an internet gateway, a NAT device, or a virtual private gateway. For Amazon ECS tasks using the Fargate launch type, the VPC endpoint enables the task to pull private images from Amazon ECR without assigning a public IP address to the task. If using EC2 launch types for your ECS tasks, you will need to have both ECS and ECR Endpoints.

**How?** If using the Fargate launch type for instances, create a VPC Endpoint for only the Docker Repository API. If using the EC2 launch type, create a VPC Endpoint for the ECR API as well. Create endpoints for S3 (for image file retrieval) and CloudWatch Logs. If tasks only use Internet access for images, that access to the Internet can now be disabled. For more details, see [Endnote 1](#endnote-1)

### 4. Consider using AWS Systems Manager Parameter Store or AWS Secrets Manager for reference of secrets into Container Definitions
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.AC-1|Identities and credentials are issued, managed, verified, revoked, and audited for authorized devices, users and processes|
|PR.AC-4|Access permissions and authorizations are managed, incorporating the principles of least privilege and separation of duties|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|
|PR.AC-6|Identities are proofed and bound to credentials and asserted in interactions|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|
|PR.DS-5|Protections against data leaks are implemented|
|PR.IP-1|A baseline configuration of information technology/industrial control systems is created and maintained incorporating security principles (e.g. concept of least functionality)|
|PR.IP-7|Protection processes are improved|

**Why?** When you register a task definition, you must specify a list of container definitions that are passed to the Docker daemon on a container instance, such as Name, Image, Memory and Port Mappings. The environment section of the container definition lists the environment variables to pass to a container. This parameter maps to the --env option for **docker run**. We do not recommend using plaintext environment variables for sensitive information, such as credential data. Amazon ECS enables you to inject sensitive data into your containers by storing your sensitive data in either AWS Secrets Manager or AWS Systems Manager Parameter Store, and then referencing them in your container definition. 

**How?** During the creation of a container, expand the Advanced Container Configuration section to specify your Environment Variables. For the value of the variable, enter the ARN of the secret or parameter. For more information on creating and injecting AWS Secrets Manager secrets, see [Endnote 2](#endnote-2). For more information on creating and injecting AWS Systems Manager Parameter Store parameters, see [Endnote 3](#endnote-3).

### 5. Take measures to ensure data is encrypted
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.DS-1|Data-at-rest is protected|
|PR.DS-2|Data-in-transit is protected|
**Why?** Data should be protected within the AWS Service using NIST-approved encryption mechanisms. Some features of ECS employ automatic encryption, but other measures can be taken in other services to ensure all data is protected.

**How?** Amazon ECS can be integrated with Amazon Elastic Container Registry (ECR). ECR transfers your container images over HTTPS and automatically encrypts your images at rest.  
Amazon ECS can be configured to use data volumes in task definitions. Docker volumes driver options include the ability to configure the EBS storage to use encryption. The specific options vary depending on the volume plugin that you are using. In addition, it is possible to encrypt the EBS volumes used by the EC2 launch cluster. For more information, see [Endnote 4](#endnote-4). *Note: Fargate does not support encryption at rest. Each Fargate task receives ephemeral task storage. After a Fargate task stops, the storage is deleted.*  
Amazon Elastic File System (Amazon EFS) provides simple, scalable file storage for use with Amazon EC2 instances. You can use Amazon EFS file systems with Amazon ECS to export file system data across your fleet of container instances. Encryption can be enabled for your Amazon EFS file system at rest.

## Detective
### 1. Utilize automated monitoring tools such as Amazon CLoudWatch Logs by enabling the awslogs Log Driver
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-3|Event data are aggregated and correlated from multiple sources and sensors|
|DE.AE-4|Impact of events is determined|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|

**Why?** You can configure your container instances to send log information to CloudWatch Logs. This enables your security team the ability to monitor, store and access different logs from your various container instances in one convenient location. You can use ECS logs as a security tool to monitor the traffic that is reaching your containers. Once configured the logs can be utilized to establish network baselines, help determine event impacts and detect anomalous activity.  

**How?** By enabling the awslogs Log Driver and specifying it in your container's task definitions. For additional details see [Endnote 5](#endnote-5)

### 2. Use CloudTrail to log ECS API activity
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.AE-1|A baseline of network operations and expected data flows for users and systems is established and managed|
|DE.AE-3|Event data are aggregated and correlated from multiple sources and sensors|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-6|External service provider activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|

**Why?** Amazon ECS is integrated with AWS CloudTrail, a service that provides a record of actions taken by a user, role, or an AWS service in Amazon ECS. CloudTrail captures all API calls for Amazon ECS as events, including calls from the Amazon ECS console and from code calls to the Amazon ECS API operations. Using the information collected by CloudTrail, you can determine the request that was made to Amazon ECS, the IP address from which the request was made, who made the request, when it was made, and additional details.

**How?** For an ongoing record of events in your AWS account, including events for Amazon ECS, create a trail. A trail enables CloudTrail to deliver log files to an Amazon S3 bucket. By default, when you create a trail in the console, the trail applies to all regions. The trail logs events from all Regions in the AWS partition and delivers the log files to the Amazon S3 bucket that you specify. Additionally, you can configure other AWS services to further analyze and act upon the event data collected in CloudTrail logs. 

### 3. Consider using X-Ray to capture distributed traces from your containerized applications
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-4|Malicious code is detected|
|DE.CM-5|Unauthorized mobile code is detected|
|DE.CM-6|External service provider activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|

**Why?** X-Ray provides an end-to-end view of requests as they travel through your application, and shows a map of your application’s underlying components. You can use X-Ray to analyze both applications in development and in production, from simple three-tier applications to complex microservices applications consisting of thousands of services. AWS X-Ray is a service that collects data about requests that your application serves, and provides tools you can use to view, filter, and gain insights into that data to identify issues and opportunities for optimization. For any traced request to your application, you can see detailed information not only about the request and response, but also about calls that your application makes to downstream AWS resources, microservices, databases and HTTP web APIs. 

**How?** X-Ray can automatically highlight bugs or errors in your application code by analyzing the response code for each request made to your application. This enables easy debugging of application code without requiring you to reproduce the bug or error.

### 4. Utilize AWS CloudWatch Container Insights
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-5|Unauthorized mobile code is detected|
|DE.AE-3|Event data are aggregated and correlated from multiple sources and sensors|
|DE.AE-4|Impact of events is determined|

**Why?** CloudWatch Container Insights collects, aggregates, and summarizes metrics and logs from your containerized applications and microservices. The metrics include utilization for resources such as CPU, memory, disk, and network. Network metrics are only available for tasks that use the bridge network mode. The metrics are available in CloudWatch automatic dashboards. Operational data is collected as performance log events. These are entries that use a structured JSON schema that enables high-cardinality data to be ingested and stored at scale. From this data, CloudWatch creates higher-level aggregated metrics at the cluster and service level as CloudWatch metrics.

**How?** Container Insights can be enabled for all new clusters created by opting in to the container Insights account setting, on individual clusters by enabling it using the cluster settings during cluster creation, or on existing clusters by using the Update Cluster Settings API. Opting in to the container Insights account setting can be done with both the Amazon ECS console and the AWS CLI. You must be running version 1.16.200 or later of the AWS CLI to use this feature

### 5. Enable VPC Flow Logs for ECS Cluster VPC (EC2 Launch Types Only)
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|DE.CM-1|The network is monitored to detect potential cybersecurity events|
|DE.CM-6|External service provider activity is monitored to detect potential cybersecurity events|
|DE.CM-7|Monitoring for unauthorized personnel, connections, devices, and software is performed|
|DE.DP-4|Event detection information is communicated to appropriate parties|

**Why?** VPC Flow logs can help you with a number of tasks; for example, to troubleshoot why specific traffic is not reaching an instance, which in turn helps you diagnose overly restrictive security group rules. You can also use flow logs as a security tool to monitor the traffic that is reaching your instance. 

**How?** VPC Flow Logs is a feature that enables you to capture information about the IP traffic going to and from network interfaces in your VPC. Flow log data can be published to Amazon CloudWatch Logs and Amazon S3. After you've created a flow log, you can retrieve and view its data in the chosen destination.

## Respond/Recover
### 1. Utilize Amazon ECS Events and EventBridge
NIST CSF:
|NIST Subcategory Control|Description|
|-----------|------------------------|
|RS.AN-1|Notifications from detection systems are investigated |
|RS.AN-2|The impact of the incident is understood|
|RS.AN-4|Incidents are categorized consistent with response plans|
|RS.AN-5|Processes are established to receive, analyze and respond to vulnerabilities disclosed to the organization from internal and external sources (e.g. internal testing, security bulletins, or security researchers)|
|RS.CO-2|Events are reported consistent with established criteria|
|RS.CO-3|Information is shared consistent with response plans|

**Why?** Amazon EventBridge enables you to automate your AWS services and respond automatically to system events such as application availability issues or resource changes. Events from AWS services are delivered to EventBridge in near real time. You can write simple rules to indicate which events are of interest to you and what automated actions to take when an event matches a rule.

**How?** You can use Amazon ECS events for EventBridge to receive near real-time notifications regarding the current state of your Amazon ECS clusters. If your tasks are using the Fargate launch type, you can see the state of your tasks. If your tasks are using the EC2 launch type, you can see the state of both the container instances and the current state of all tasks running on those container instances. For services, you can see events related to the health of your service. Using EventBridge, you can build custom schedulers on top of Amazon ECS that are responsible for orchestrating tasks across clusters and monitoring the state of clusters in near real time.

## Endnotes
### Endnote 1 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonECR/latest/userguide/vpc-endpoints.html](https://docs.aws.amazon.com/AmazonECR/latest/userguide/vpc-endpoints.html)
### Endnote 2 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data-secrets.html](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data-secrets.html)
### Endnote 3 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data-parameters.html](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data-parameters.html)
### Endnote 4 <!-- omit in toc -->
[https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html)
### Endnote 5 <!-- omit in toc -->
[https://docs.aws.amazon.com/AmazonECS/latest/userguide/using_awslogs.html](https://docs.aws.amazon.com/AmazonECS/latest/userguide/using_awslogs.html)
