<img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS" width="250"/>

# Amazon Managed Streaming for Apache Kafka (MSK) - Security Playbook <!-- omit in toc -->
## NIST Cybersecurity Framework Alignment <!-- omit in toc -->

**Generated By:**  
[Rob Goss (RMG)](https://cgweb3/profile/RMG)
<br>
Security Engineering

**Last Update:** *01/20/2021*

## Table of Contents <!-- omit in toc -->
- [Overview](#overview)
- [Preventative Controls](#Preventative-Controls)
  - [1. MSK Deployed in Private VPC](#1-MSK-Deployed-in-Private-VPC)
  - [2. Encrypt all data in the Cloud](#2-Encrypt-all-data-in-the-Cloud)
  - [3. IAM Users and Roles Enforce Least Priviledge](#-IAM-Users-and-Roles-Enforce-Least-Priviledge)
- [Detective Controls](#Detective-Controls)
  - [1. MSK resources are tagged according to CG standards](#1-Application-Load-Balancing-resources-are-tagged-according-to-CG-standards)
  - [2. CloudTrail logging enabled and sent to Splunk](#2-CloudTrail-logging-enabled-and-sent-to-Splunk)
  - [3. CloudWatch logging enabled](#2-CloudWatch-logging-enabled)
- [Respond & Recover](#Respond/Recover)
- [Endnotes](#Endnotes)
- [Capital Group Glossory](#Capital-Group-Glossory) 

## Overview
Amazon Managed Streaming for Apache Kafka (Amazon MSK) is a fully managed service that enables you to build and run applications that use Apache Kafka to process streaming data. Amazon MSK provides the control-plane operations, such as those for creating, updating, and deleting clusters. It lets you use Apache Kafka data-plane operations, such as those for producing and consuming data. It runs open-source versions of Apache Kafka. This means existing applications, tooling, and plugins from partners and the Apache Kafka community are supported without requiring changes to application code.

**Below is a reference diagram of an MSK deployment:**

<img src="/docs/img/msk/mskarchitecture.png" width="500"> <br>

The diagram above demonstrates the interaction between the following components:

 - **Broker nodes** — When creating an Amazon MSK cluster, you specify how many broker nodes you want Amazon MSK to create in each Availability Zone. In the example cluster shown in this diagram, there's one broker per Availability Zone. Each Availability Zone has its own virtual private cloud (VPC) subnet.

 - **ZooKeeper nodes** — Amazon MSK also creates the Apache ZooKeeper nodes for you. Apache ZooKeeper is an open-source server that enables highly reliable distributed coordination.

 - **Producers, consumers, and topic creators** — Amazon MSK lets you use Apache Kafka data-plane operations to create topics and to produce and consume data.

 - **Cluster Operations** You can use the AWS Management Console, the AWS Command Line Interface (AWS CLI), or the APIs in the SDK to perform control-plane operations. For example, you can create or delete an Amazon MSK cluster, list all the clusters in an account, view the properties of a cluster, and update the number of brokers in a cluster.

Amazon MSK detects and automatically recovers from the most common failure scenarios for clusters so that your producer and consumer applications can continue their write and read operations with minimal impact.

**NOTE:** This document currently only pertains to the **"Amazon Managed Streaming for Apache Kafka (MSK)"** service and does not cover building a Kafka cluster from scratch on IaaS infrastructure on AWS.

## Preventative Controls
<img src="/docs/img/Prevent.png" width="50">

### 1. MSK Deployed in Private VPC
One of CG's core tenets for migration of services or data out to any cloud provider is that the service or data not be publically exposed.  Fortunatly MSK allows for the building of Kafka clusters inside a private VPC, which allows the service to be built on CG's private IP space and the apply network access crontrols to further limit external access.

**NIST CSF:** <br>

|NIST Subcategory Control|Description|
|-----------|------------------------|
|PR.PT-4|Communications and control networks are protected|
|PR.PT-5|Mechanisms (e.g., failsafe, load balancing, hot swap) are implemented to achieve resilience requirements in normal and adverse situations|
|PR.AC-3|Remote access is managed|
|PR.AC-5|Network integrity is protected (e.g., network segregation, network segmentation)|
<br>

**Capital Group:** <br>

|Control Statement|Description|
|------|----------------------|
|6|Any AWS service used by CG should not be directly available to the Internet and the default route is always the CG gateway.|
|7|Use of AWS IAM accounts are restricted to CG networks.|
<br>

**Why?**

Utilizing a Private VPC for an MSK cluster makes sure its only accessible by internal resources, and allows the service to be only accessible by CG owned resources and does not expose the endpoint to the public Internet.  There should always be a diliniation between Private CG services and Public Facing CG services, Private VPC allows for this.  When creating MSK clusters, one should never use the default VPC as this by default has public access and public IP assignment.


**How?**

A VPC or Virtual Private Cloud allows for the logical seperation of a network onto a private subnet owned and maintained by CG. VPCs also allow for granular network control policies though the use of Security Groups to allow the enforcement of least priviledge.  If an appropriate VPC already exists, one can utilize this VPC, as long as its not the default VPC or has public access.

Below is an example new VPC and Security group setup for MSK:

 1. **Create a new VPC for MSK**

    - First navigate to the VPC creation screen AWS services search.
    - Next enter the following items:<br>
      1: *IPv4 CIDR block* - This should be assigned by the Network Engineering team.<br>
      2: *VPC Name tag* - This name should be appropriate to the MSK cluster being built.<br>
      3: *Create VPC* - Click Create<br>
     <img src="/docs/img/msk/vpc_setting2.png" width="800"> <br> 

 2. **Creation of a Security Group to enforce least priviledge**<br>
Once we have the VPC created, we now need to secure it with assignment of a Security Group. One can use a default Security Group, but it is a better option to create a security group for our service to limit the access to only allow CG IP's and the appropriate Kafka Service ports.<br><br>
We first need to click on create security group, after the appropriate VPC has been selected. Next we need to create a new security group with the following baseline settings, although the security group can be created with even more restricted access if company wide access is not needed.<br><br>

- **Security Group Name:** "MSW_SG" or similar.
- **Description:** "Limit access to valid Kafka service ports for internal access or similar.
- **VPC:** Select the VPC that was previously created for MSK.
- **Inbound Rules:** Default inbound rules for MSK should at minimum contain the below:<br>
  1: Limit access from only 10.0.0.0/8 (CG's internal Network)
  2: Limit open ports to only those required to use the Kafka Service
- **Outbound Rules:** Default Outbound rules should reflect the minimum connectivity needed for the service to function.<br><br>
<img src="/docs/img/msk/new_sg.png" width="500"> <br><br>

 3. **Assign newly created VPC to new MSK Cluster**<br>
 <img src="/docs/img/msk/vpc_setting.png" width="500"> <br>


## Endnotes
**Resources**
1. https://docs.aws.amazon.com/msk/latest/developerguide/security.html
2. https://docs.aws.amazon.com/msk/latest/developerguide/before-you-begin.html
<br>

## Capital Group Glossory 
**Data** - Digital pieces of information stored or transmitted for use with an information system from which understandable information is derived. Items that could be considered to be data are: Source code, meta-data, build artifacts, information input and output.  
 
**Information System** - An organized assembly of resources and procedures for the collection, processing, maintenance, use, sharing, dissemination, or disposition of information. All systems, platforms, compute instances including and not limited to physical and virtual client endpoints, physical and virtual servers, software containers, databases, Internet of Things (IoT) devices, network devices, applications (internal and external), Serverless computing instances (i.e. AWS Lambda), vendor provided appliances, and third-party platforms, connected to the Capital Group network or used by Capital Group users or customers.

**Log** - a record of the events occurring within information systems and networks. Logs are composed of log entries; each entry contains information related to a specific event that has occurred within a system or network.

**Information** - communication or representation of knowledge such as facts, data, or opinions in any medium or form, including textual, numerical, graphic, cartographic, narrative, or audiovisual. 

**Cloud computing** - A model for enabling ubiquitous, convenient, on-demand network access to a shared pool of configurable computing resources (e.g., networks, servers, storage, applications, and services) that can be rapidly provisioned and released with minimal management effort or service provider interaction.

**Vulnerability**  - Weakness in an information system, system security procedures, internal controls, or implementation that could be exploited or triggered by a threat source. Note: The term weakness is synonymous for deficiency. Weakness may result in security and/or privacy risks.
